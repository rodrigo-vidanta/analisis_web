import{t as z,f as x}from"./AWSConsoleUnified-FYhalQvB.js";import"./index-UksZEC30.js";import"./supabase-BU-KUXcc.js";import"./vendor-NHdFJPub.js";import"./ui-vwqaVgG7.js";import"./awsConsoleServiceProduction-Dw__GshH.js";class j{marshaller;serializer;deserializer;serdeContext;defaultContentType;constructor({marshaller:i,serializer:a,deserializer:o,serdeContext:m,defaultContentType:d}){this.marshaller=i,this.serializer=a,this.deserializer=o,this.serdeContext=m,this.defaultContentType=d}async serializeEventStream({eventStream:i,requestSchema:a,initialRequest:o}){const m=this.marshaller,d=a.getEventStreamMember(),S=a.getMemberSchema(d),y=this.serializer,f=this.defaultContentType,h=Symbol("initialRequestMarker"),p={async*[Symbol.asyncIterator](){if(o){const r={":event-type":{type:"string",value:"initial-request"},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:f}};y.write(a,o);const t=y.flush();yield{[h]:!0,headers:r,body:t}}for await(const r of i)yield r}};return m.serialize(p,r=>{if(r[h])return{headers:r.headers,body:r.body};const t=Object.keys(r).find(s=>s!=="__type")??"",{additionalHeaders:e,body:n,eventType:l,explicitPayloadContentType:c}=this.writeEventBody(t,S,r);return{headers:{":event-type":{type:"string",value:l},":message-type":{type:"string",value:"event"},":content-type":{type:"string",value:c??f},...e},body:n}})}async deserializeEventStream({response:i,responseSchema:a,initialResponseContainer:o}){const m=this.marshaller,d=a.getEventStreamMember(),y=a.getMemberSchema(d).getMemberSchemas(),f=Symbol("initialResponseMarker"),h=m.deserialize(i.body,async t=>{const e=Object.keys(t).find(l=>l!=="__type")??"",n=t[e].body;if(e==="initial-response"){const l=await this.deserializer.read(a,n);return delete l[d],{[f]:!0,...l}}else if(e in y){const l=y[e];if(l.isStructSchema()){const c={};let u=!1;for(const[s,g]of l.structIterator()){const{eventHeader:v,eventPayload:w}=g.getMergedTraits();if(u=u||!!(v||w),w)g.isBlobSchema()?c[s]=n:g.isStringSchema()?c[s]=(this.serdeContext?.utf8Encoder??z)(n):g.isStructSchema()&&(c[s]=await this.deserializer.read(g,n));else if(v){const b=t[e].headers[s]?.value;b!=null&&(g.isNumericSchema()?b&&typeof b=="object"&&"bytes"in b?c[s]=BigInt(b.toString()):c[s]=Number(b):c[s]=b)}}if(u)return{[e]:c}}return{[e]:await this.deserializer.read(l,n)}}else return{$unknown:t}}),p=h[Symbol.asyncIterator](),r=await p.next();if(r.done)return h;if(r.value?.[f]){if(!a)throw new Error("@smithy::core/protocols - initial-response event encountered in event stream but no response schema given.");for(const[t,e]of Object.entries(r.value))o[t]=e}return{async*[Symbol.asyncIterator](){for(r?.value?.[f]||(yield r.value);;){const{done:t,value:e}=await p.next();if(t)break;yield e}}}}writeEventBody(i,a,o){const m=this.serializer;let d=i,S=null,y;const f=a.getSchema()[4].includes(i),h={};if(f){const t=a.getMemberSchema(i);if(t.isStructSchema()){for(const[e,n]of t.structIterator()){const{eventHeader:l,eventPayload:c}=n.getMergedTraits();if(c){S=e;break}else if(l){const u=o[i][e];let s="binary";n.isNumericSchema()?(-2)**31<=u&&u<=2**31-1?s="integer":s="long":n.isTimestampSchema()?s="timestamp":n.isStringSchema()?s="string":n.isBooleanSchema()&&(s="boolean"),u!=null&&(h[e]={type:s,value:u},delete o[i][e])}}if(S!==null){const e=t.getMemberSchema(S);e.isBlobSchema()?y="application/octet-stream":e.isStringSchema()&&(y="text/plain"),m.write(e,o[i][S])}else m.write(t,o[i])}else throw new Error("@smithy/core/event-streams - non-struct member not supported in event stream union.")}else{const[t,e]=o[i];d=t,m.write(15,e)}const p=m.flush();return{body:typeof p=="string"?(this.serdeContext?.utf8Decoder??x)(p):p,eventType:d,explicitPayloadContentType:y,additionalHeaders:h}}}export{j as EventStreamSerde};
