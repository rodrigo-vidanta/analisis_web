# Contexto Maestro del Proyecto - PQNC QA AI Platform

> **DescripciÃ³n:** Regla maestra que proporciona contexto completo del proyecto para Composer y agentes de IA.
> **AplicaciÃ³n:** Siempre activa (Always Apply)
> **Ãšltima actualizaciÃ³n:** Enero 2026

---

## ðŸŽ¯ Resumen Ejecutivo del Proyecto

**PQNC QA AI Platform** es una plataforma empresarial de Quality Assurance para call centers que usa IA para analizar llamadas de ventas, gestionar prospectos y automatizar comunicaciones WhatsApp.

### Stack TecnolÃ³gico Principal

| Capa | TecnologÃ­a |
|------|------------|
| **Frontend** | React 19, TypeScript, Vite, TailwindCSS |
| **Estado** | Zustand (stores), React Context (Auth) |
| **Backend** | Supabase (PostgreSQL + Edge Functions) |
| **AI/ML** | Anthropic Claude, OpenAI, VAPI (voz) |
| **MensajerÃ­a** | WhatsApp Business API via N8N |
| **Infra** | AWS (ECS, RDS, S3, CloudFront) |
| **AutomatizaciÃ³n** | N8N (Railway) |

---

## ðŸ“ Estructura de Carpetas CrÃ­tica

```
src/
â”œâ”€â”€ components/           # Componentes React por mÃ³dulo
â”‚   â”œâ”€â”€ analysis/        # ðŸ“Š AnÃ¡lisis de llamadas, Live Monitor
â”‚   â”œâ”€â”€ chat/            # ðŸ’¬ WhatsApp Live Chat
â”‚   â”œâ”€â”€ prospectos/      # ðŸ‘¥ GestiÃ³n de prospectos
â”‚   â”œâ”€â”€ admin/           # ðŸ‘¤ AdministraciÃ³n de usuarios
â”‚   â”œâ”€â”€ campaigns/       # ðŸ“¢ CampaÃ±as de llamadas
â”‚   â”œâ”€â”€ scheduled-calls/ # ðŸ“… Llamadas programadas
â”‚   â”œâ”€â”€ citas/           # ðŸ“† Sistema de citas Vidanta
â”‚   â”œâ”€â”€ aws/             # â˜ï¸ AWS Infrastructure Manager
â”‚   â”œâ”€â”€ notifications/   # ðŸ”” Sistema de notificaciones
â”‚   â”œâ”€â”€ support/         # ðŸŽ« Sistema de tickets
â”‚   â””â”€â”€ shared/          # ðŸ”§ Componentes compartidos
â”‚
â”œâ”€â”€ services/            # Servicios de negocio
â”‚   â”œâ”€â”€ supabase*.ts     # Clientes y queries Supabase
â”‚   â”œâ”€â”€ n8n*.ts          # IntegraciÃ³n N8N
â”‚   â”œâ”€â”€ vapi*.ts         # IntegraciÃ³n VAPI (voz)
â”‚   â”œâ”€â”€ whatsapp*.ts     # Servicios WhatsApp
â”‚   â””â”€â”€ aws*.ts          # Servicios AWS
â”‚
â”œâ”€â”€ stores/              # Zustand stores
â”‚   â”œâ”€â”€ appStore.ts      # Estado global de app
â”‚   â”œâ”€â”€ notificationStore.ts
â”‚   â””â”€â”€ ninjaStore.ts
â”‚
â”œâ”€â”€ hooks/               # Custom hooks
â”œâ”€â”€ config/              # Configuraciones Supabase
â”œâ”€â”€ contexts/            # React Context (AuthContext)
â”œâ”€â”€ utils/               # Utilidades
â””â”€â”€ types/               # TypeScript types
```

---

## ðŸ—„ï¸ Arquitectura de Base de Datos

### Base de Datos UNIFICADA: PQNC_AI

**URL:** `glsmifhkoaifvaegsozd.supabase.co`

| Dominio | Tablas Principales |
|---------|-------------------|
| **Auth** | `auth_users`, `auth_roles`, `auth_sessions`, `auth_user_coordinaciones` |
| **Permisos** | `permissions`, `permission_groups`, `auth_role_permissions` |
| **Prospectos** | `prospectos`, `prospect_assignments`, `prospect_history` |
| **Llamadas** | `llamadas_ventas`, `call_analysis_summary`, `call_recordings` |
| **WhatsApp** | `conversaciones_whatsapp`, `mensajes_whatsapp`, `whatsapp_templates` |
| **Coordinaciones** | `coordinaciones`, `auth_user_coordinaciones` |
| **Config** | `system_config`, `api_auth_tokens`, `app_themes` |

### Clientes Supabase en CÃ³digo

```typescript
// âœ… USAR SIEMPRE
import { analysisSupabase } from '../config/analysisSupabase';
import { supabaseSystemUI } from '../config/supabaseSystemUI';

// âŒ NUNCA USAR (eliminados por seguridad)
// supabaseSystemUIAdmin, analysisSupabaseAdmin, pqncSupabase
```

---

## ðŸ” Seguridad (CRÃTICO)

### Reglas de Seguridad Absolutas

1. **NUNCA** usar clientes `*Admin` (eliminados del codebase)
2. **NUNCA** exponer `service_role_key` en frontend
3. **SOLO** usar `anon_key` en bundle de producciÃ³n
4. **SIEMPRE** usar Edge Functions para operaciones privilegiadas

### Edge Functions Disponibles

| FunciÃ³n | Uso |
|---------|-----|
| `multi-db-proxy` | Acceso a PQNC_QA y LOGMONITOR |
| `auth-admin-proxy` | Operaciones admin de auth |
| `secure-query` | Consultas seguras |
| `anthropic-proxy` | API de Claude |
| `send-img-proxy` | EnvÃ­o de imÃ¡genes WhatsApp |

---

## ðŸ§© Patrones de CÃ³digo

### Componentes React

```typescript
// PatrÃ³n estÃ¡ndar de componente
import { useState, useEffect, useCallback } from 'react';
import { motion } from 'framer-motion';
import { analysisSupabase } from '../config/analysisSupabase';

interface Props {
  id: string;
  onComplete?: () => void;
}

export const MiComponente: React.FC<Props> = ({ id, onComplete }) => {
  const [loading, setLoading] = useState(true);
  const [data, setData] = useState<MiTipo | null>(null);

  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      const { data, error } = await analysisSupabase
        .from('tabla')
        .select('*')
        .eq('id', id);
      if (error) throw error;
      setData(data);
    } catch (err) {
      console.error('Error:', err);
      toast.error('Error al cargar');
    } finally {
      setLoading(false);
    }
  }, [id]);

  useEffect(() => { fetchData(); }, [fetchData]);

  if (loading) return <LoadingSpinner />;

  return (
    <motion.div 
      initial={{ opacity: 0 }} 
      animate={{ opacity: 1 }}
      className="p-4 bg-white dark:bg-gray-900 rounded-xl"
    >
      {/* Contenido */}
    </motion.div>
  );
};
```

### Servicios

```typescript
// PatrÃ³n estÃ¡ndar de servicio
import { analysisSupabase } from '../config/analysisSupabase';

export const miServicio = {
  async obtenerTodos(): Promise<MiTipo[]> {
    const { data, error } = await analysisSupabase
      .from('tabla')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (error) throw new Error(`Error: ${error.message}`);
    return data || [];
  },

  async crear(item: Omit<MiTipo, 'id'>): Promise<MiTipo> {
    const { data, error } = await analysisSupabase
      .from('tabla')
      .insert(item)
      .select()
      .single();
    
    if (error) throw error;
    return data;
  }
};
```

---

## ðŸ“‹ Convenciones de CÃ³digo

### Nomenclatura

| Tipo | ConvenciÃ³n | Ejemplo |
|------|------------|---------|
| Componentes | PascalCase | `UserProfile.tsx` |
| Hooks | camelCase, prefix `use` | `useProspectos.ts` |
| Servicios | camelCase + Service | `prospectoService.ts` |
| Stores | camelCase + Store | `appStore.ts` |
| Handlers | prefix `handle` | `handleSubmit`, `handleClick` |
| Boolean | prefix `is/has/can` | `isLoading`, `hasError` |

### Estilos

- **SOLO TailwindCSS** (no CSS custom)
- Dark mode: `dark:` prefix
- Animaciones: `framer-motion`
- Iconos: `lucide-react`
- Toast: `react-hot-toast`

---

## ðŸ”— Integraciones Externas

### N8N (AutomatizaciÃ³n)

```typescript
// Usar credentialsService para obtener tokens
import { credentialsService } from '../services/credentialsService';

const { apiKey, baseUrl } = await credentialsService.getN8NCredentials();
```

**Workflows CrÃ­ticos (PROD):**
- Guardrail agentic logic
- LÃ³gica de llamadas programadas
- VAPI transfer tool
- WhatsApp templates

### VAPI (Voz)

```typescript
import { vapiService } from '../services/vapiService';
```

### AWS

```typescript
import { awsDiagramService } from '../services/awsDiagramService';
```

---

## âš¡ Tips para Composer

### Para Menos Errores:

1. **Siempre verificar imports** antes de usar funciones
2. **Usar servicios existentes** en `src/services/`
3. **Revisar stores** antes de crear estado nuevo
4. **Seguir patrones** de componentes similares

### Archivos Clave a Consultar:

| Necesitas... | Consulta... |
|--------------|-------------|
| Rutas de la app | `src/components/MainApp.tsx` |
| Auth/Login | `src/contexts/AuthContext.tsx` |
| Estado global | `src/stores/appStore.ts` |
| Config Supabase | `src/config/analysisSupabase.ts` |
| Tipos de datos | `src/types/` |

### Antes de Crear Algo Nuevo:

1. Â¿Existe un servicio similar? â†’ Revisar `src/services/`
2. Â¿Existe un hook similar? â†’ Revisar `src/hooks/`
3. Â¿Existe un componente similar? â†’ Revisar mÃ³dulo correspondiente

---

## ðŸ“š DocumentaciÃ³n Adicional

- **Arquitectura BD:** `.cursor/rules/arquitectura-bd-unificada.mdc`
- **Seguridad:** `.cursor/rules/security-rules.mdc`
- **MCPs:** `.cursor/rules/mcp-rules.mdc`
- **N8N:** `.cursor/rules/n8n-rules.mdc`
- **Estilos/Modales:** `.cursor/rules/style.mdc`

---

## ðŸš« Prohibiciones

1. **NO** hacer push/deploy sin autorizaciÃ³n
2. **NO** crear cÃ³digo mock o de prueba
3. **NO** usar clientes Admin de Supabase
4. **NO** hardcodear credenciales
5. **NO** crear archivos CSS (solo Tailwind)
6. **NO** usar `any` en TypeScript
