# Reglas del Sistema de Notificaciones v2.0

## Descripci√≥n
Sistema de notificaciones en tiempo real estilo "redes sociales" para alertar a coordinadores, supervisores y ejecutivos sobre eventos importantes de prospectos.

**Versi√≥n:** 2.0.0 (2026-01-15)
**Arquitectura:** Trigger de BD unificado (elimina duplicados)

---

## Arquitectura v2.0

### Base de Datos: PQNC_AI (UNIFICADA)
- **URL**: `glsmifhkoaifvaegsozd.supabase.co`
- **Cliente**: `analysisSupabase` (de `src/config/analysisSupabase.ts`)
- **Tablas**: 
  - `user_notifications` (notificaciones)
  - `prospectos` (eventos que generan notificaciones)
  - `auth_users`, `auth_roles`, `auth_user_coordinaciones` (migradas desde SystemUI)
- **RLS**: DESHABILITADO en `user_notifications`
- **Realtime**: HABILITADO en `user_notifications`

### ‚õî SystemUI: DEPRECADO
- Ya NO se usa para notificaciones
- Tablas migradas a PQNC_AI
- No usar `supabaseSystemUI` en c√≥digo de notificaciones

---

## Trigger Unificado

```
Nombre:     trigger_notify_prospecto_changes
Tabla:      prospectos
Eventos:    AFTER INSERT OR UPDATE OF ejecutivo_id, requiere_atencion_humana
Funci√≥n:    fn_notify_prospecto_changes()
```

### Casos manejados por el trigger:

| Caso | Evento | Condici√≥n | Destinatarios |
|------|--------|-----------|---------------|
| 1 | INSERT | coordinacion_id NOT NULL AND ejecutivo_id IS NULL | Coordinadores y supervisores de la coordinaci√≥n |
| 2 | UPDATE | ejecutivo_id cambia de NULL a valor | El ejecutivo asignado |
| 3 | UPDATE | requiere_atencion_humana cambia de false/null a true | Ejecutivo (si tiene) o Coordinadores |

---

## Archivos del Sistema

| Archivo | Descripci√≥n |
|---------|-------------|
| `src/components/notifications/NotificationSystem.tsx` | Componente principal (Bell, Dropdown, Toast) |
| `src/stores/notificationStore.ts` | Store Zustand para estado global |
| `src/services/notificationsService.ts` | Servicio simplificado (solo lectura + realtime) |
| `src/hooks/useProspectosNotifications.ts` | **DEPRECADO** - No usar |
| `public/sounds/notification.mp3` | Audio de alerta |
| `src/components/notifications/README_NOTIFICATIONS.md` | Documentaci√≥n completa |
| `src/components/notifications/CHANGELOG_NOTIFICATIONS.md` | Historial de cambios |

---

## Tipos de Notificaciones

```typescript
type NotificationType = 
  | 'nuevo_prospecto'      // Icono: MessageSquare (morado) - coordinadores
  | 'prospecto_asignado'   // Icono: UserPlus (verde) - ejecutivo asignado
  | 'requiere_atencion'    // Icono: AlertTriangle (rojo) - urgente
  | 'mensaje_nuevo';       // Reservado para futuro
```

---

## Reglas Cr√≠ticas

### ‚õî NUNCA hacer:
1. ‚ùå Usar `supabaseSystemUI` para notificaciones (est√° deprecado)
2. ‚ùå Habilitar RLS en la tabla `user_notifications`
3. ‚ùå Generar notificaciones desde el frontend (causa duplicados)
4. ‚ùå Modificar el trigger `trigger_notify_prospecto_changes` sin backup
5. ‚ùå Usar el hook `useProspectosNotifications` (deprecado)

### ‚úÖ SIEMPRE hacer:
1. ‚úÖ Usar `analysisSupabase` o `notificationsClient` para operaciones
2. ‚úÖ Mantener RLS deshabilitado en `user_notifications`
3. ‚úÖ Las notificaciones se generan SOLO por el trigger de BD
4. ‚úÖ El frontend SOLO escucha via Realtime y muestra
5. ‚úÖ Verificar que `user_id` viene del AuthContext

---

## Flujo de Datos

```
1. Evento en tabla 'prospectos' (INSERT/UPDATE)
2. Trigger trigger_notify_prospecto_changes se dispara
3. Funci√≥n fn_notify_prospecto_changes() eval√∫a condiciones
4. INSERT en 'user_notifications' para usuarios correspondientes
5. Supabase Realtime detecta INSERT
6. WebSocket env√≠a payload al frontend
7. notificationsService.subscribeToUserNotifications callback
8. notificationStore.addNotification():
   - Agrega a lista
   - Incrementa contador
   - Reproduce sonido
   - Muestra toast
```

---

## Debugging

### Notificaciones no se generan:
```sql
-- Verificar trigger existe
SELECT tgname FROM pg_trigger WHERE tgrelid = 'public.prospectos'::regclass;

-- Verificar funci√≥n existe
SELECT proname FROM pg_proc WHERE proname = 'fn_notify_prospecto_changes';

-- Probar manualmente (simular asignaci√≥n)
UPDATE prospectos SET ejecutivo_id = 'UUID' WHERE id = 'ID' AND ejecutivo_id IS NULL;

-- Verificar notificaci√≥n creada
SELECT * FROM user_notifications ORDER BY created_at DESC LIMIT 5;
```

### Realtime no funciona:
1. Verificar que usa `analysisSupabase` (no supabaseSystemUI)
2. Verificar Realtime habilitado: 
   ```sql
   SELECT * FROM pg_publication_tables WHERE pubname = 'supabase_realtime';
   ```
3. Verificar en consola: buscar "üîî [Realtime]" logs

### Audio no suena:
- Requiere interacci√≥n previa del usuario (Browser Autoplay Policy)
- Verificar que existe `/public/sounds/notification.mp3`

---

## Metadata de Notificaci√≥n

```typescript
interface NotificationMetadata {
  prospecto_id: string;           // UUID del prospecto
  prospecto_nombre: string;       // Nombre a mostrar
  coordinacion_id?: string;       // UUID coordinaci√≥n
  coordinacion_nombre?: string;   // Nombre de coordinaci√≥n
  telefono?: string;              // WhatsApp del prospecto
  motivo?: string;                // Solo en requiere_atencion
  action_url: string;             // URL para navegaci√≥n
}
```

---

## Dependencias

- `@supabase/supabase-js` - Cliente Supabase
- `zustand` - State management
- `framer-motion` - Animaciones
- `lucide-react` - Iconos (Bell, AlertTriangle, UserPlus, etc.)

---

## Documentaci√≥n Relacionada

- `src/components/notifications/README_NOTIFICATIONS.md` - Documentaci√≥n t√©cnica
- `src/components/notifications/CHANGELOG_NOTIFICATIONS.md` - Historial de cambios
- `.cursor/rules/unified-database-architecture.mdc` - Arquitectura BD unificada
- `docs/MCP_CATALOG.md` - Cat√°logo de conexiones MCP

---

**√öltima actualizaci√≥n:** 2026-01-15
**Versi√≥n:** 2.0.0
