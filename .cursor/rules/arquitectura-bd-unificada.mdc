---
alwaysApply: true
---

# Arquitectura de Base de Datos Unificada

**Fecha de Vigencia:** 16 de Enero 2026  
**Versión:** v3.0.0

---

## ⚠️ CAMBIOS ARQUITECTÓNICOS CRÍTICOS

### Migración de Enero 2025
- BD unificada: de 2 proyectos a 1 (PQNC_AI)

### Cambios de Seguridad Enero 2026
- **Clientes `*Admin` ELIMINADOS** del codebase
- **RLS HABILITADO** con políticas seguras (pentesting 2026-01-16)
- **Solo `anon_key`** en bundle de producción
- **Edge Functions migradas** a PQNC_AI con verificación de JWT

---

## Nueva Arquitectura (ACTUAL)

### Base de Datos Principal: PQNC_AI

**URL:** `https://glsmifhkoaifvaegsozd.supabase.co`  
**Proyecto:** glsmifhkoaifvaegsozd  
**RLS:** ✅ HABILITADO con políticas seguras (2026-01-16)

**Contiene TODO:**
- ✅ Autenticación (auth_users, auth_roles, auth_sessions)
- ✅ Permisos (permissions, auth_*_permissions, permission_groups)
- ✅ Coordinaciones (coordinaciones, auth_user_coordinaciones)
- ✅ Prospectos (prospectos, prospect_assignments)
- ✅ Llamadas (llamadas_ventas, call_analysis_summary)
- ✅ WhatsApp (conversaciones_whatsapp, mensajes_whatsapp)
- ✅ Configuración (system_config, app_themes, api_auth_tokens)
- ✅ Moderación (content_moderation_warnings, user_warning_counters)
- ✅ Logs (auth_login_logs, paraphrase_logs, assignment_logs)
- ✅ Edge Functions (multi-db-proxy, auth-admin-proxy)

---

## Clientes de Supabase en el Código

### ✅ analysisSupabase (PRINCIPAL - USAR SIEMPRE)

**Archivo:** `src/config/analysisSupabase.ts`  
**Variables env:**
- `VITE_ANALYSIS_SUPABASE_URL` (glsmifhkoaifvaegsozd)
- `VITE_ANALYSIS_SUPABASE_ANON_KEY`

**Uso:** **TODO** - Auth, prospectos, llamadas, WhatsApp, configuración

### ✅ supabaseSystemUI (REDIRIGIDO a PQNC_AI)

**Archivo:** `src/config/supabaseSystemUI.ts`  
**Variables env:**
- `VITE_SYSTEM_UI_SUPABASE_URL` (ahora apunta a glsmifhkoaifvaegsozd)
- `VITE_SYSTEM_UI_SUPABASE_ANON_KEY` (mismo que ANALYSIS)

**Uso:** Auth, usuarios, permisos (MIGRADO a PQNC_AI desde 2025-01-13)

### ❌ Clientes ELIMINADOS (NUNCA USAR)

| Cliente | Estado | Razón |
|---------|--------|-------|
| `supabaseSystemUIAdmin` | **ELIMINADO** | Exponía `service_role_key` |
| `analysisSupabaseAdmin` | **ELIMINADO** | Exponía `service_role_key` |
| `pqncSupabaseAdmin` | **ELIMINADO** | Proyecto prohibido |

**⚠️ CRÍTICO:** Si ves código usando estos clientes, está DESACTUALIZADO. Reemplazar por clientes normales.

---

## Edge Functions

**⚠️ CAMBIO 2026-01-16: Edge Functions migradas a PQNC_AI**

**Ubicación:** PQNC_AI (glsmifhkoaifvaegsozd.supabase.co)  
**Variables env:**
- `VITE_EDGE_FUNCTIONS_URL` = `https://glsmifhkoaifvaegsozd.supabase.co`
- `VITE_ANALYSIS_SUPABASE_ANON_KEY` (para Authorization)

**Funciones Principales:**

| Función | Requiere Auth | Uso | Secrets |
|---------|---------------|-----|---------|
| `multi-db-proxy` | ✅ JWT User | Proxy a PQNC_QA y LOGMONITOR | `PQNC_QA_SERVICE_KEY`, `LOGMONITOR_SERVICE_KEY` |
| `auth-admin-proxy` | ✅ | Operaciones admin | `SUPABASE_SERVICE_ROLE_KEY` |
| `secure-query` | ✅ | Consultas seguras PQNC_AI | `SUPABASE_SERVICE_ROLE_KEY` |
| `send-img-proxy` | ✅ | Envío imágenes WhatsApp | `N8N_WEBHOOK_URL` |
| `anthropic-proxy` | ✅ | API Anthropic | `ANTHROPIC_API_KEY` |

**⚠️ IMPORTANTE:** 
- Los secrets están en Supabase Dashboard, NO en el código frontend
- `multi-db-proxy` valida que el JWT sea de un usuario autenticado (no solo anon_key)

---

## Reglas de Desarrollo

### ✅ CORRECTO

```typescript
// Consultar usuarios
const { data } = await supabaseSystemUI.from('auth_users').select('*');
// ✅ Consulta PQNC_AI con anon_key (RLS deshabilitado)

// Consultar prospectos
const { data } = await analysisSupabase.from('prospectos').select('*');
// ✅ Consulta PQNC_AI con anon_key

// Llamar Edge Function
const url = `${import.meta.env.VITE_EDGE_FUNCTIONS_URL}/functions/v1/multi-db-proxy`;
// ✅ Llama a PQNC_AI (glsmifhkoaifvaegsozd)
```

### ❌ INCORRECTO

```typescript
// ❌ PROHIBIDO - Clientes Admin ELIMINADOS
const { data } = await supabaseSystemUIAdmin.from('auth_users').select('*');
// Error: supabaseSystemUIAdmin ya no existe

// ❌ PROHIBIDO - No usar pqncSupabase
const { data } = await pqncSupabase.from('auth_users').select('*');
// Consulta hmmfuhqgvsehkizlfzga (proyecto PROHIBIDO)

// ❌ PROHIBIDO - No usar service_key en frontend
const serviceKey = import.meta.env.VITE_SUPABASE_SERVICE_KEY;
// Las service_key NO deben estar en producción
```

---

## Optimizaciones Disponibles

### JOINs Directos

Ahora que TODO está en PQNC_AI, puedes hacer JOINs nativos:

```typescript
// ANTES (2 queries)
const prospectos = await analysisSupabase.from('prospectos').select('*');
const ejecutivos = await supabaseSystemUI.from('auth_users').in('id', ids);

// AHORA (1 query con JOIN)
const { data } = await analysisSupabase
  .from('prospectos')
  .select(`
    *,
    ejecutivo:ejecutivo_id (full_name, email, phone),
    coordinacion:coordinacion_id (nombre, codigo)
  `);
```

### Vistas Pre-calculadas

```typescript
// Usar vistas optimizadas
const { data } = await analysisSupabase
  .from('prospectos_con_ejecutivo_y_coordinacion')
  .select('*');
  
// Ya incluye: ejecutivo_nombre, coordinacion_nombre, etc.
```

---

## ⛔ Tablas/Views DEPRECADAS

**Actualizado: 2026-01-14**

### Tabla de Coordinaciones de Usuarios

| Tabla/View | Estado | Usar en su lugar |
|------------|--------|------------------|
| `coordinador_coordinaciones` | ❌ **ELIMINADA** | `auth_user_coordinaciones` |
| `coordinador_coordinaciones_legacy` | ⚠️ Solo backup histórico | `auth_user_coordinaciones` |

### Uso Correcto

```typescript
// ✅ CORRECTO - Obtener coordinaciones de un usuario
const { data } = await supabaseSystemUI
  .from('auth_user_coordinaciones')
  .select('coordinacion_id')
  .eq('user_id', userId);

// ✅ CORRECTO - Insertar relación usuario-coordinación
await supabaseSystemUI
  .from('auth_user_coordinaciones')
  .insert({
    user_id: userId,
    coordinacion_id: coordId,
    assigned_by: currentUserId
  });

// ❌ INCORRECTO - NUNCA usar tablas legacy
.from('coordinador_coordinaciones')        // VIEW eliminada
.from('coordinador_coordinaciones_legacy') // Solo backup
```

### Historial de Migración

| Fecha | Acción |
|-------|--------|
| Dic 2025 | Creada `auth_user_coordinaciones` (nueva) |
| 2025-12-29 | Migración de código completada |
| 2026-01-14 | VIEW `coordinador_coordinaciones` eliminada |

---

## Migración Histórica

**Antes (hasta 12 Enero 2025):**
- System_UI: Auth, usuarios, permisos, coordinaciones
- PQNC_AI: Prospectos, llamadas, WhatsApp

**Después (desde 13 Enero 2025):**
- PQNC_AI: **TODO** (BD unificada)
- System_UI: Solo backup y Edge Functions

**Documentación completa:** `docs/MIGRACION_SYSTEM_UI_A_PQNC_AI_COMPLETA.md`

---

## Referencias

- [Documentación Maestra de Migración](../docs/MIGRACION_SYSTEM_UI_A_PQNC_AI_COMPLETA.md)
- [Nueva Arquitectura BD Unificada](../docs/NUEVA_ARQUITECTURA_BD_UNIFICADA.md)
- [Plan de Optimizaciones con JOINs](../docs/PLAN_OPTIMIZACIONES_JOINS.md)
- [Reporte de Optimizaciones](../docs/REPORTE_OPTIMIZACIONES_BD_UNIFICADA.md)

---

**IMPORTANTE:** Al desarrollar nuevas features, usar SIEMPRE `analysisSupabase` o `supabaseSystemUI` (ambos apuntan a PQNC_AI). NO usar `pqncSupabase` (proyecto prohibido).
