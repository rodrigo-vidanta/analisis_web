---
alwaysApply: true
---

# Reglas de Uso de MCPs de Supabase

## üìã MCPs Activos

| MCP | Proyecto | URL | Uso |
|-----|----|----|-----|
| `Supa_PQNC_AI` | pqnc_ai (UNIFICADO) | `glsmifhkoaifvaegsozd.supabase.co` | **TODO:** Auth, usuarios, permisos, prospectos, llamadas, WhatsApp, coordinaciones, configuraci√≥n |
| `SystemUI_AuthDB` | system_ui (BACKUP) | `zbylezfyagwrxoecioup.supabase.co` | **SOLO BACKUP** - No usar para datos de producci√≥n (migraci√≥n 2025-01-13) |

## ‚õî MCPs PROHIBIDOS

**NUNCA usar estos MCPs:**
- `SupaClever` (rnhejbuubpbnojalljso) - Proyecto ajeno
- `SupaPQNC` (hmmfuhqgvsehkizlfzga) - Removido de configuraci√≥n

## üìù Reglas Obligatorias

### 1. Documentaci√≥n de Cambios
- **SIEMPRE** documentar operaciones de escritura en `MCP_CHANGELOG.local.md`
- Formato: fecha, MCP, operaci√≥n, datos antes/despu√©s, rollback SQL
- Este archivo NO se sube a git

### 2. Operaciones Destructivas
- **ANTES** de DELETE/DROP/TRUNCATE: hacer backup con `backup_table`
- **NUNCA** ejecutar DELETE sin WHERE (los MCPs ya lo bloquean)
- **SIEMPRE** verificar el filtro antes de UPDATE masivos

### 3. Cu√°ndo Usar Cada MCP

**‚ö†Ô∏è MIGRACI√ìN 2025-01-13: TODO UNIFICADO EN PQNC_AI**

| Contexto | MCP a usar | Notas |
|----|---|---|
| An√°lisis de llamadas | `Supa_PQNC_AI` | ‚úÖ |
| Live Monitor | `Supa_PQNC_AI` | ‚úÖ |
| Prospectos | `Supa_PQNC_AI` | ‚úÖ |
| Conversaciones WhatsApp | `Supa_PQNC_AI` | ‚úÖ |
| M√©tricas de ventas | `Supa_PQNC_AI` | ‚úÖ |
| **Usuarios del sistema** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| **Sesiones y auth** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| **Permisos y roles** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| **Mensajes admin** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| **Bot pause status** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| **Configuraci√≥n sistema** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| **Coordinaciones** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| **Auth users** | `Supa_PQNC_AI` | ‚úÖ **MIGRADO** |
| Backup/Auditor√≠a hist√≥rica | `SystemUI_AuthDB` | Solo para consultas de respaldo |

### 4. Nomenclatura de Herramientas

**‚ö†Ô∏è IMPORTANTE: Prefijos √∫nicos para evitar conflictos**

Las herramientas de `Supa_PQNC_AI` usan el prefijo `pqnc_` para evitar conflictos de enrutamiento en Cursor. Las herramientas de `SystemUI_AuthDB` mantienen nombres sin prefijo.

#### Herramientas de Supa_PQNC_AI (con prefijo `pqnc_`)

```
mcp_Supa_PQNC_AI_pqnc_query_table           # Consultar tabla en PQNC AI
mcp_Supa_PQNC_AI_pqnc_insert_data          # Insertar en PQNC AI
mcp_Supa_PQNC_AI_pqnc_update_data          # Actualizar en PQNC AI
mcp_Supa_PQNC_AI_pqnc_delete_data          # Eliminar en PQNC AI (‚ö†Ô∏è)
mcp_Supa_PQNC_AI_pqnc_execute_sql          # SQL en PQNC AI
mcp_Supa_PQNC_AI_pqnc_get_database_schema  # Esquema de PQNC AI
mcp_Supa_PQNC_AI_pqnc_execute_rpc         # Ejecutar RPC en PQNC AI
mcp_Supa_PQNC_AI_pqnc_backup_table         # Backup de tabla en PQNC AI
mcp_Supa_PQNC_AI_pqnc_get_table_info       # Info de tabla en PQNC AI
mcp_Supa_PQNC_AI_pqnc_exec_sql_transaction # Transacci√≥n SQL en PQNC AI
mcp_Supa_PQNC_AI_pqnc_debug_connection     # Debug conexi√≥n PQNC AI
```

#### Herramientas de SystemUI_AuthDB (sin prefijo)

```
mcp_SystemUI_AuthDB_query_table            # Consultar tabla en SystemUI
mcp_SystemUI_AuthDB_insert_data            # Insertar en SystemUI
mcp_SystemUI_AuthDB_update_data            # Actualizar en SystemUI
mcp_SystemUI_AuthDB_delete_data            # Eliminar en SystemUI (‚ö†Ô∏è)
mcp_SystemUI_AuthDB_execute_sql            # SQL en SystemUI
mcp_SystemUI_AuthDB_get_database_schema    # Esquema de SystemUI
mcp_SystemUI_AuthDB_execute_rpc            # Ejecutar RPC en SystemUI
mcp_SystemUI_AuthDB_backup_table           # Backup de tabla en SystemUI
mcp_SystemUI_AuthDB_get_table_info         # Info de tabla en SystemUI
mcp_SystemUI_AuthDB_exec_sql_transaction  # Transacci√≥n SQL en SystemUI
mcp_SystemUI_AuthDB_debug_connection       # Debug conexi√≥n SystemUI
```

**Nota:** El prefijo `pqnc_` fue implementado para resolver conflictos de enrutamiento cuando ambos MCPs tienen herramientas con los mismos nombres. Esto garantiza que Cursor pueda distinguir correctamente entre los servidores.

### 5. Flujo de Trabajo Recomendado

1. **Identificar MCP correcto**: Usar `Supa_PQNC_AI` para datos de PQNC, `SystemUI_AuthDB` para usuarios/auth
2. **Usar nombres correctos**: Recordar que `Supa_PQNC_AI` requiere prefijo `pqnc_` en todas las herramientas
3. **Consultar primero**: Usar `pqnc_query_table` o `query_table` (seg√∫n MCP) o `execute_sql` SELECT antes de modificar
4. **Backup si es destructivo**: Usar `pqnc_backup_table` o `backup_table` antes de DELETE/UPDATE masivo
5. **Ejecutar cambio**: Realizar la operaci√≥n con el nombre correcto de herramienta
6. **Documentar**: Registrar en `MCP_CHANGELOG.local.md`
7. **Verificar**: Consultar de nuevo para confirmar el resultado

### 6. Requisitos de Setup

Para acceso completo (DDL/DML), ejecutar en cada proyecto Supabase:

```sql
-- Ejecutar: enable_full_access_mcp.sql
-- Crea funciones: exec_sql, get_database_schema, backup_table_data, exec_sql_transaction
```

## üìÅ Archivos Relacionados

| Archivo | Descripci√≥n | En Git |
|---|----|----|
| `~/.cursor/mcp.json` | Configuraci√≥n global de MCPs | No |
| `mcp-pqnc-ai-server.ts` | Servidor MCP PQNC AI | S√≠ |
| `mcp-systemui-server.ts` | Servidor MCP SystemUI | S√≠ |
| `enable_full_access_mcp.sql` | Script de habilitaci√≥n | S√≠ |
| `MCP_CHANGELOG.local.md` | Log local de cambios | **No** |
| `docs/MCP_CATALOG.md` | Documentaci√≥n completa | S√≠ |

## ‚õî Tablas/Views DEPRECADAS (NO USAR)

**Actualizado: 2026-01-14**

| Tabla/View | Estado | Reemplazo | Notas |
|------------|--------|-----------|-------|
| `coordinador_coordinaciones` | ‚ùå **ELIMINADA** (era VIEW) | `auth_user_coordinaciones` | VIEW eliminada 2026-01-14 |
| `coordinador_coordinaciones_legacy` | ‚ö†Ô∏è Solo backup | `auth_user_coordinaciones` | Tabla legacy, NO usar |

### Tabla Correcta para Coordinaciones de Usuarios

```typescript
// ‚úÖ CORRECTO - Usar SIEMPRE auth_user_coordinaciones
const { data } = await supabase
  .from('auth_user_coordinaciones')
  .select('coordinacion_id')
  .eq('user_id', userId);

// ‚ùå INCORRECTO - NUNCA usar estas tablas
.from('coordinador_coordinaciones')      // VIEW eliminada
.from('coordinador_coordinaciones_legacy') // Tabla legacy
```

### Estructura de auth_user_coordinaciones

| Columna | Tipo | Descripci√≥n |
|---------|------|-------------|
| `id` | UUID | PK |
| `user_id` | UUID | FK ‚Üí auth_users.id |
| `coordinacion_id` | UUID | FK ‚Üí coordinaciones.id |
| `assigned_at` | TIMESTAMPTZ | Fecha de asignaci√≥n |
| `assigned_by` | UUID | Usuario que asign√≥ (auditor√≠a) |

## ‚ö†Ô∏è Advertencias

1. **Producci√≥n activa**: PQNC_AI est√° en producci√≥n activa
2. **System_UI es SOLO BACKUP**: NO usar para operaciones de producci√≥n (migraci√≥n 2025-01-13)
3. **Sin rollback autom√°tico**: Los cambios son permanentes
4. **Credenciales en mcp.json**: NUNCA compartir ~/.cursor/mcp.json
5. **Service Role Key**: Los MCPs usan service_role (acceso total)
6. **Nombres de herramientas**: SIEMPRE usar prefijo `pqnc_` para herramientas de `Supa_PQNC_AI`
7. **Edge Functions**: Permanecen en System_UI (zbylezfyagwrxoecioup) - usar VITE_EDGE_FUNCTIONS_*
8. **Tablas legacy**: NUNCA usar `coordinador_coordinaciones*` - usar `auth_user_coordinaciones`

## üîß Ejemplos de Uso

### Consultar tabla en PQNC AI
```typescript
// ‚úÖ CORRECTO
mcp_Supa_PQNC_AI_pqnc_query_table({ table: 'prospectos', limit: 10 })

// ‚ùå INCORRECTO (no funcionar√°)
mcp_Supa_PQNC_AI_query_table({ table: 'prospectos', limit: 10 })
```

### Consultar tabla en SystemUI
```typescript
// ‚úÖ CORRECTO
mcp_SystemUI_AuthDB_query_table({ table: 'auth_users', limit: 10 })
```

### Debug de conexi√≥n
```typescript
// PQNC AI
mcp_Supa_PQNC_AI_pqnc_debug_connection()

// SystemUI
mcp_SystemUI_AuthDB_debug_connection()
```