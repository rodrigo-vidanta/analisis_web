# Workflow de Despliegue Automatizado

> **Descripci√≥n:** Proceso completo de deploy automatizado a Git y AWS.
> **Aplicaci√≥n:** Agent Requested (cuando usuario solicita deploy)
> **Trigger:** Usuario dice "push", "deploy", "documenta y actualiza"

---

## Cu√°ndo Aplicar Esta Regla

Cuando el usuario diga:
- "documenta y actualiza"
- "push a git"
- "push a git y aws"
- "deploy"
- "de acuerdo a la regla"

**‚ö†Ô∏è IMPORTANTE:** "documenta y actualiza" ejecuta AUTOM√ÅTICAMENTE todas las tareas sin confirmaci√≥n.

---

## Flujo Automatizado Completo

```
"documenta y actualiza"
    ‚Üì
1. Ejecutar script deploy-complete.ts (PASO 1-5)
    ‚Üì
2. Actualizar BD v√≠a MCP SupabaseREST (PASO 6)
    ‚Üì
3. Crear handover con REF (PASO 7)
    ‚Üì
4. Imprimir resumen en chat (PASO 8)
```

---

## Proceso Completo para el Agente

### PASO 1: Determinar Versi√≥n y Ejecutar Script

**El agente DEBE:**

1. **Leer versi√≥n actual de `src/config/appVersion.ts`:**
   - Buscar l√≠nea con `export const APP_VERSION = 'BX.X.XNX.X.X';`
   - Extraer la versi√≥n actual

2. **Determinar nueva versi√≥n:**
   - Si el usuario proporciona versi√≥n expl√≠cita: usar esa
   - Si no: incrementar autom√°ticamente la parte frontend (ej: `B10.1.42N2.5.42` ‚Üí `B10.1.42N2.5.43`)

3. **Ejecutar el script `deploy-complete.ts`:**

```bash
# Opci√≥n 1: Versi√≥n expl√≠cita
tsx scripts/deploy-complete.ts B10.1.43N2.5.43 "Mensaje del deploy"

# Opci√≥n 2: Incremento autom√°tico (sin argumentos)
tsx scripts/deploy-complete.ts

# Opci√≥n 3: Incremento espec√≠fico
tsx scripts/deploy-complete.ts --increment-frontend "Mensaje"
tsx scripts/deploy-complete.ts --increment-backend "Mensaje"
```

**El script ejecuta autom√°ticamente (SIN confirmaciones):**
1. ‚úÖ Sincronizar documentaci√≥n (`public/docs/`)
2. ‚úÖ Actualizar `src/config/appVersion.ts` con la nueva versi√≥n
3. ‚úÖ Actualizar `package.json` (versi√≥n num√©rica extra√≠da)
4. ‚úÖ Actualizar `src/components/documentation/DocumentationModule.tsx`:
   - Stats (versi√≥n y release)
   - Agregar commit a `gitCommits[]` (hash se actualiza despu√©s del commit)
   - Agregar deployment a `awsDeployments[]`
5. ‚úÖ Git commit y push (sin confirmaci√≥n)
6. ‚úÖ Deploy AWS con `./update-frontend.sh` (sin confirmaci√≥n)

**Par√°metros del script:**
- **Sin argumentos**: Lee versi√≥n actual e incrementa frontend autom√°ticamente
- **Versi√≥n expl√≠cita**: `BX.X.XNX.X.X` (ej: `B10.1.43N2.5.43`)
- **--increment**: Incrementa frontend autom√°ticamente
- **--increment-backend**: Incrementa backend autom√°ticamente
- **Mensaje (opcional)**: Descripci√≥n del deploy (default: "Deploy autom√°tico completo")

**Ejemplo de ejecuci√≥n:**
```bash
# El agente lee appVersion.ts y encuentra B10.1.42N2.5.42
# Incrementa autom√°ticamente a B10.1.42N2.5.43
tsx scripts/deploy-complete.ts "Fix modal actualizaci√≥n + dropdowns enriquecidos"
```

**‚ö†Ô∏è IMPORTANTE:** 
- El script NO requiere confirmaci√≥n para git push ni AWS deploy
- El script actualiza autom√°ticamente todos los archivos necesarios
- El script retorna el hash del commit para usar en el handover

### PASO 2: Extraer Informaci√≥n del Script

Despu√©s de ejecutar el script, el agente debe:
1. **Leer la versi√≥n usada**: Del output del script (l√≠nea "üì¶ Versi√≥n: BX.X.XNX.X.X")
2. **Leer el commit hash**: Del output del script (l√≠nea "‚úÖ Git push completado (commit: XXXXXXX)")
3. **Leer la duraci√≥n del deploy**: Del output del script (l√≠nea "‚úÖ Deploy AWS completado (XXs)")

**Nota:** El script imprime toda esta informaci√≥n al final en el resumen.

### PASO 3: Actualizar Versi√≥n Requerida en BD (v√≠a MCP)

**‚ö†Ô∏è CR√çTICO:** Ejecutar SOLO despu√©s de que el deploy AWS est√© completo.

**El agente DEBE ejecutar autom√°ticamente este paso usando MCP `Supa_PQNC_AI`:**

1. **Extraer versi√≥n del script ejecutado:**
   - La versi√≥n ya est√° disponible del PASO 1 (ej: `"B10.1.43N2.5.43"`)

2. **Verificar configuraci√≥n existente:**
   ```typescript
   mcp_Supa_PQNC_AI_pqnc_query_table({
     table: "system_config",
     select: "config_key, config_value",
     filter: { config_key: "app_version" },
     limit: 1
   })
   ```

3. **Actualizar o crear registro:**
   - Si existe: usar `mcp_Supa_PQNC_AI_pqnc_update_data`
   - Si no existe: usar `mcp_Supa_PQNC_AI_pqnc_insert_data`
   
   **Estructura del `config_value`:**
   ```json
   {
     "version": "B10.1.43N2.5.43",  // Versi√≥n completa del script
     "force_update": true
   }
   ```

4. **Ejemplo de actualizaci√≥n:**
   ```typescript
   // Si existe (UPDATE)
   mcp_Supa_PQNC_AI_pqnc_update_data({
     table: "system_config",
     filter: { config_key: "app_version" },
     data: {
       config_value: {
         version: "B10.1.43N2.5.43",  // Versi√≥n del script
         force_update: true
       },
       updated_at: new Date().toISOString()
     }
   })
   
   // Si no existe (INSERT)
   mcp_Supa_PQNC_AI_pqnc_insert_data({
     table: "system_config",
     data: {
       config_key: "app_version",
       config_value: {
         version: "B10.1.43N2.5.43",  // Versi√≥n del script
         force_update: true
       },
       description: "Versi√≥n requerida de la aplicaci√≥n. Los usuarios con versiones anteriores ser√°n forzados a actualizar."
     }
   })
   ```

5. **Verificar actualizaci√≥n:**
   ```typescript
   mcp_Supa_PQNC_AI_pqnc_query_table({
     table: "system_config",
     select: "config_key, config_value, updated_at",
     filter: { config_key: "app_version" },
     limit: 1
   })
   ```

**Par√°metros del MCP:**
- **MCP Name:** `Supa_PQNC_AI`
- **Proyecto:** `glsmifhkoaifvaegsozd` (PQNC_AI)
- **Tabla:** `system_config`
- **Config Key:** `app_version`

**Notas Importantes:**
- ‚úÖ La versi√≥n debe ser el formato COMPLETO (ej: `"B10.1.43N2.5.43"`)
- ‚úÖ El sistema de control de versiones compara la PRIMERA parte antes de "N" (ej: `"B10.1.43"`)
- ‚úÖ `force_update: true` fuerza la actualizaci√≥n en todos los clientes

### PASO 4: Crear Handover Final

**Formato:**
```markdown
REF: HANDOVER-YYYY-MM-DD-DEPLOY-vX.X.X
```

**Ubicaci√≥n:** `.cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md`

**Contenido m√≠nimo:**
- Versi√≥n desplegada (del script)
- Commit hash (del script)
- Archivos principales modificados
- Estado del deploy AWS (duraci√≥n del script)
- Estado de actualizaci√≥n BD
- Pr√≥ximos pasos (si aplica)

Ver `.cursor/rules/handover-format.mdc` para estructura completa.

### PASO 5: Informar Resultado

**En el chat, imprimir solo:**

```markdown
‚úÖ Deploy completado

**REF**: `HANDOVER-YYYY-MM-DD-DEPLOY-vX.X.X`  
**Ubicaci√≥n**: `.cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md`

**Resumen r√°pido**:
- ‚úÖ Documentaci√≥n sincronizada (N archivos)
- ‚úÖ Versi√≥n actualizada: BX.X.XNX.X.X (appVersion.ts)
- ‚úÖ Git push: commit XXXXXXX
- ‚úÖ AWS deploy: exitoso (XXs)
- ‚úÖ Versi√≥n requerida actualizada en BD (v√≠a MCP)
- Pr√≥ximo: [acci√≥n si aplica]
```

**‚ö†Ô∏è NO repetir el handover completo en el chat** - Solo REF + resumen.

---

## Ejemplo Completo de Ejecuci√≥n

Cuando el usuario dice "documenta y actualiza":

1. **Agente ejecuta script:**
   ```bash
   tsx scripts/deploy-complete.ts B10.1.43N2.5.43 "Fix modal + dropdowns"
   ```

2. **Script ejecuta autom√°ticamente:**
   - Sincroniza docs
   - Actualiza appVersion.ts ‚Üí `B10.1.43N2.5.43`
   - Actualiza package.json ‚Üí `2.5.43`
   - Actualiza DocumentationModule.tsx
   - Git commit y push
   - Deploy AWS

3. **Agente actualiza BD:**
   ```typescript
   mcp_Supa_PQNC_AI_pqnc_update_data({
     table: "system_config",
     filter: { config_key: "app_version" },
     data: {
       config_value: { version: "B10.1.43N2.5.43", force_update: true }
     }
   })
   ```

4. **Agente crea handover** con toda la informaci√≥n

5. **Agente imprime resumen** en chat

---

## Ventajas del Script Automatizado

‚úÖ **Sin confirmaciones**: Ejecuta todo autom√°ticamente  
‚úÖ **Consistencia**: Siempre actualiza los mismos archivos  
‚úÖ **Trazabilidad**: Logs claros de cada paso  
‚úÖ **Reutilizable**: Puede ejecutarse manualmente tambi√©n  
‚úÖ **Completo**: Cubre todos los pasos excepto BD (que requiere MCP)  

---

## Formato de Versiones

```
Formato completo: BX.X.XNX.X.X
Ejemplo: B10.1.43N2.5.43

- Primera parte (antes de "N"): Versi√≥n del backend/build
- Segunda parte (despu√©s de "N"): Versi√≥n del frontend/package.json
```

---

## Troubleshooting

**Si el script falla:**
- Verificar que la versi√≥n tenga el formato correcto
- Verificar que no haya cambios sin commitear (el script hace `git add -A`)
- Verificar permisos de escritura en archivos

**Si la BD no se actualiza:**
- Verificar que el MCP `Supa_PQNC_AI` est√© configurado
- Verificar que la tabla `system_config` exista
- Verificar que el access token tenga permisos

---

**√öltima actualizaci√≥n:** 2026-01-22  
**Versi√≥n del rule:** 2.0.0 (Script automatizado)
