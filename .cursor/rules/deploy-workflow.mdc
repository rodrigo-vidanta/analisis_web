# Workflow de Despliegue Automatizado

> **Descripci√≥n:** Proceso completo de deploy automatizado a Git y AWS.
> **Aplicaci√≥n:** **ALWAYS APPLY** cuando usuario solicita deploy
> **Trigger:** Usuario dice "push", "deploy", "documenta y actualiza", "deploy completo"

---

## üö® COMANDOS ESPEC√çFICOS PARA INVOCAR (Usuario)

Para garantizar ejecuci√≥n completa, el usuario debe usar EXACTAMENTE uno de estos comandos:

### ‚úÖ Comando Recomendado #1 (M√°s Seguro)
```
@deploy-workflow.mdc deploy completo con mensaje: [tu mensaje aqu√≠]
```

### ‚úÖ Comando Recomendado #2 (Alternativo)
```
Ejecuta deploy-workflow.mdc completo: [tu mensaje]
```

### ‚úÖ Comando Recomendado #3 (Corto)
```
deploy completo
```

**‚ö†Ô∏è EVITAR comandos ambiguos como:**
- ‚ùå "documenta y actualiza" (puede interpretarse solo como docs)
- ‚ùå "push a git" (solo git, no AWS ni BD)
- ‚ùå "deploy" (ambiguo, puede no incluir BD)

---

## ‚ö° MODO ESTRICTO (OBLIGATORIO)

**El agente DEBE verificar ANTES de empezar:**

```typescript
// CHECKLIST PRE-EJECUCI√ìN (El agente debe verificar TODOS estos puntos)
const preChecks = {
  1: "¬øExiste scripts/deploy-complete.ts?",
  2: "¬øMCP Supa_PQNC_AI est√° disponible?",
  3: "¬øHay cambios sin commitear? (git status)",
  4: "¬øUsuario confirm√≥ el mensaje del deploy?",
  5: "¬øTengo acceso a .cursor/handovers/?",
};

// Si CUALQUIERA falla ‚Üí DETENER y pedir al usuario que lo resuelva
```

**El agente DEBE reportar al INICIO:**
```
üîç Pre-checks:
‚úÖ Script deploy-complete.ts: OK
‚úÖ MCP Supa_PQNC_AI: Conectado
‚úÖ Git status: Clean (o X archivos sin commitear)
‚úÖ Handovers dir: Accesible
‚ö†Ô∏è Mensaje deploy: [pendiente del usuario si no lo dio]

¬øProceder con deploy? (Este mensaje es solo informativo, el agente procede autom√°ticamente)
```

---

## Cu√°ndo Aplicar Esta Regla

Cuando el usuario diga **EXACTAMENTE**:
- "deploy completo"
- "deploy completo con mensaje: [...]"
- "@deploy-workflow.mdc deploy completo"
- "Ejecuta deploy-workflow.mdc completo"

**üö® IMPORTANTE:** Con estos comandos espec√≠ficos, el agente ejecuta AUTOM√ÅTICAMENTE todas las tareas sin pedir confirmaci√≥n adicional.

---

## Flujo Automatizado Completo

```
"deploy completo"
    ‚Üì
PRE-CHECKS (5 verificaciones)
    ‚Üì
PASO 1: Ejecutar script deploy-complete.ts
    ‚Üì
PASO 2: Verificar output del script
    ‚Üì
PASO 3: Actualizar BD v√≠a MCP Supa_PQNC_AI
    ‚Üì
PASO 4: Verificar actualizaci√≥n de BD
    ‚Üì
PASO 5: Crear handover con REF
    ‚Üì
PASO 6: Commit handover a Git
    ‚Üì
PASO 7: Imprimir resumen COMPLETO en chat
    ‚Üì
PASO 8: Auto-verificaci√≥n final
```

---

## Proceso Completo para el Agente

### PRE-CHECKS (OBLIGATORIO)

**El agente DEBE ejecutar estos checks ANTES de empezar:**

```bash
# Check 1: Verificar script existe
[ -f scripts/deploy-complete.ts ] && echo "‚úÖ Script OK" || echo "‚ùå Script no encontrado"

# Check 2: Verificar MCP (intentar conexi√≥n)
# (El agente intenta listar tools del MCP)

# Check 3: Verificar git status
git status --short | wc -l  # Si >0, hay cambios sin commitear

# Check 4: Verificar handovers dir
[ -d .cursor/handovers ] && echo "‚úÖ Dir OK" || echo "‚ùå Dir no existe"
```

**Si CUALQUIER check falla:**
```
‚ùå PRE-CHECK FALLIDO

Check fallido: [nombre del check]
Raz√≥n: [descripci√≥n]

üîß Acci√≥n requerida:
[Instrucci√≥n espec√≠fica para el usuario]

‚è∏Ô∏è Deploy DETENIDO. Resuelve el issue y vuelve a ejecutar.
```

### PASO 1: Determinar Versi√≥n y Ejecutar Script

**El agente DEBE:**

1. **Leer versi√≥n actual de `src/config/appVersion.ts`:**
   - Buscar l√≠nea con `export const APP_VERSION = 'BX.X.XNX.X.X';`
   - Extraer la versi√≥n actual

2. **Determinar nueva versi√≥n:**
   - Si el usuario proporciona versi√≥n expl√≠cita: usar esa
   - Si no: incrementar autom√°ticamente la parte frontend (ej: `B10.1.42N2.5.42` ‚Üí `B10.1.42N2.5.43`)

3. **Ejecutar el script `deploy-complete.ts`:**

```bash
# Opci√≥n 1: Versi√≥n expl√≠cita
tsx scripts/deploy-complete.ts B10.1.43N2.5.43 "Mensaje del deploy"

# Opci√≥n 2: Incremento autom√°tico (sin argumentos)
tsx scripts/deploy-complete.ts

# Opci√≥n 3: Incremento espec√≠fico
tsx scripts/deploy-complete.ts --increment-frontend "Mensaje"
tsx scripts/deploy-complete.ts --increment-backend "Mensaje"
```

**El script ejecuta autom√°ticamente (SIN confirmaciones):**
1. ‚úÖ Sincronizar documentaci√≥n (`public/docs/`)
2. ‚úÖ Actualizar `src/config/appVersion.ts` con la nueva versi√≥n
3. ‚úÖ Actualizar `package.json` (versi√≥n num√©rica extra√≠da)
4. ‚úÖ Actualizar `src/components/documentation/DocumentationModule.tsx`:
   - Stats (versi√≥n y release)
   - Agregar commit a `gitCommits[]` (hash se actualiza despu√©s del commit)
   - Agregar deployment a `awsDeployments[]`
5. ‚úÖ Git commit y push (sin confirmaci√≥n)
6. ‚úÖ Deploy AWS con `./update-frontend.sh` (sin confirmaci√≥n)

**Par√°metros del script:**
- **Sin argumentos**: Lee versi√≥n actual e incrementa frontend autom√°ticamente
- **Versi√≥n expl√≠cita**: `BX.X.XNX.X.X` (ej: `B10.1.43N2.5.43`)
- **--increment**: Incrementa frontend autom√°ticamente
- **--increment-backend**: Incrementa backend autom√°ticamente
- **Mensaje (opcional)**: Descripci√≥n del deploy (default: "Deploy autom√°tico completo")

**Ejemplo de ejecuci√≥n:**
```bash
# ‚úÖ CORRECTO: Sin argumentos (auto-incremento)
tsx scripts/deploy-complete.ts

# ‚úÖ CORRECTO: Con mensaje (auto-incremento + mensaje)
tsx scripts/deploy-complete.ts "Fix modal actualizaci√≥n + dropdowns enriquecidos"

# ‚úÖ CORRECTO: Con versi√≥n expl√≠cita + mensaje
tsx scripts/deploy-complete.ts B10.1.43N2.5.43 "Fix modal actualizaci√≥n"

# ‚ùå INCORRECTO: Versi√≥n mal formada (se interpretar√° como mensaje)
tsx scripts/deploy-complete.ts v2.5.50
```

**‚ö†Ô∏è IMPORTANTE:** 
- El script VALIDA que el primer argumento sea una versi√≥n v√°lida (formato `BX.X.XNX.X.X`)
- Si NO es versi√≥n v√°lida, lo trata como mensaje y auto-incrementa la versi√≥n
- El script NO requiere confirmaci√≥n para git push ni AWS deploy
- El script actualiza autom√°ticamente todos los archivos necesarios
- El script retorna el hash del commit para usar en el handover

### PASO 2: Extraer Informaci√≥n del Script

Despu√©s de ejecutar el script, el agente debe:
1. **Leer la versi√≥n usada**: Del output del script (l√≠nea "üì¶ Versi√≥n: BX.X.XNX.X.X")
2. **Leer el commit hash**: Del output del script (l√≠nea "‚úÖ Git push completado (commit: XXXXXXX)")
3. **Leer la duraci√≥n del deploy**: Del output del script (l√≠nea "‚úÖ Deploy AWS completado (XXs)")

**Nota:** El script imprime toda esta informaci√≥n al final en el resumen.

### PASO 3: Actualizar Versi√≥n Requerida en BD (v√≠a MCP)

**‚ö†Ô∏è CR√çTICO:** Ejecutar SOLO despu√©s de que el deploy AWS est√© completo.

**El agente DEBE ejecutar autom√°ticamente este paso usando MCP `Supa_PQNC_AI`:**

1. **Extraer versi√≥n del script ejecutado:**
   - La versi√≥n ya est√° disponible del PASO 1 (ej: `"B10.1.43N2.5.43"`)

2. **Verificar configuraci√≥n existente:**
   ```typescript
   mcp_Supa_PQNC_AI_pqnc_query_table({
     table: "system_config",
     select: "config_key, config_value",
     filter: { config_key: "app_version" },
     limit: 1
   })
   ```

3. **Actualizar o crear registro:**
   - Si existe: usar `mcp_Supa_PQNC_AI_pqnc_update_data`
   - Si no existe: usar `mcp_Supa_PQNC_AI_pqnc_insert_data`
   
   **Estructura del `config_value`:**
   ```json
   {
     "version": "B10.1.43N2.5.43",  // Versi√≥n completa del script
     "force_update": true
   }
   ```

4. **Ejemplo de actualizaci√≥n:**
   ```typescript
   // Si existe (UPDATE)
   mcp_Supa_PQNC_AI_pqnc_update_data({
     table: "system_config",
     filter: { config_key: "app_version" },
     data: {
       config_value: {
         version: "B10.1.43N2.5.43",  // Versi√≥n del script
         force_update: true
       },
       updated_at: new Date().toISOString()
     }
   })
   
   // Si no existe (INSERT)
   mcp_Supa_PQNC_AI_pqnc_insert_data({
     table: "system_config",
     data: {
       config_key: "app_version",
       config_value: {
         version: "B10.1.43N2.5.43",  // Versi√≥n del script
         force_update: true
       },
       description: "Versi√≥n requerida de la aplicaci√≥n. Los usuarios con versiones anteriores ser√°n forzados a actualizar."
     }
   })
   ```

5. **Verificar actualizaci√≥n:**
   ```typescript
   mcp_Supa_PQNC_AI_pqnc_query_table({
     table: "system_config",
     select: "config_key, config_value, updated_at",
     filter: { config_key: "app_version" },
     limit: 1
   })
   ```

**Par√°metros del MCP:**
- **MCP Name:** `Supa_PQNC_AI`
- **Proyecto:** `glsmifhkoaifvaegsozd` (PQNC_AI)
- **Tabla:** `system_config`
- **Config Key:** `app_version`

**Notas Importantes:**
- ‚úÖ La versi√≥n debe ser el formato COMPLETO (ej: `"B10.1.43N2.5.43"`)
- ‚úÖ El sistema de control de versiones compara la PRIMERA parte antes de "N" (ej: `"B10.1.43"`)
- ‚úÖ `force_update: true` fuerza la actualizaci√≥n en todos los clientes

### PASO 4: Crear Handover Final

**Formato:**
```markdown
REF: HANDOVER-YYYY-MM-DD-DEPLOY-vX.X.X
```

**Ubicaci√≥n:** `.cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md`

**Contenido m√≠nimo:**
- Versi√≥n desplegada (del script)
- Commit hash (del script)
- Archivos principales modificados
- Estado del deploy AWS (duraci√≥n del script)
- Estado de actualizaci√≥n BD
- Pr√≥ximos pasos (si aplica)

Ver `.cursor/rules/handover-format.mdc` para estructura completa.

### PASO 7: Auto-Verificaci√≥n Final (OBLIGATORIO)

**El agente DEBE verificar que TODO se complet√≥:**

```typescript
const finalChecks = {
  "‚úÖ Script ejecutado": "¬øOutput del script mostr√≥ 'Deploy AWS completado'?",
  "‚úÖ BD actualizada": "¬øMCP retorn√≥ 'Updated 1 record(s) successfully'?",
  "‚úÖ Handover creado": "¬øArchivo .cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md existe?",
  "‚úÖ Handover commiteado": "¬øGit push mostr√≥ 'main -> main'?",
  "‚úÖ Versi√≥n correcta": "¬øsystem_config.config_value.version === nueva versi√≥n?",
};

// Si CUALQUIERA falla ‚Üí REPORTAR ERROR CR√çTICO
```

**Output esperado:**
```
üîç AUTO-VERIFICACI√ìN FINAL:

‚úÖ Script deploy-complete.ts: Ejecutado (commit: XXXXXXX)
‚úÖ AWS deploy: Exitoso (34.42s)
‚úÖ Base de datos: Actualizada (version: BX.X.XNX.X.X)
‚úÖ Handover: Creado y commiteado
‚úÖ Git: 2 commits pusheados

üéâ DEPLOY 100% COMPLETO - Sin errores
```

**Si algo fall√≥:**
```
‚ùå AUTO-VERIFICACI√ìN FALLIDA

Pasos completados: X/5
Paso fallido: [nombre del paso]
Error: [descripci√≥n del error]

üîß Acci√≥n requerida:
[Instrucci√≥n espec√≠fica para corregir]

‚ö†Ô∏è DEPLOY INCOMPLETO - Requiere intervenci√≥n manual
```

---

## üéØ Resumen para el Usuario (FORMATO EST√ÅNDAR)

**El agente DEBE imprimir este resumen EXACTO al final:**

```markdown
## ‚úÖ DEPLOY COMPLETO v[X.X.X]

**REF**: `HANDOVER-YYYY-MM-DD-DEPLOY-vX.X.X`  
**Ubicaci√≥n**: `.cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md`

### üìä M√©tricas
- ‚è±Ô∏è Tiempo total: [XX minutos]
- üì¶ Archivos modificados: [N archivos]
- üî® Commits: [hash1, hash2]
- üöÄ URLs:
  - S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
  - CloudFront: https://d3m6zgat40u0u1.cloudfront.net

### ‚úÖ Checklist Completado
- [x] Documentaci√≥n sincronizada
- [x] Versi√≥n actualizada (BX.X.XNX.X.X)
- [x] Git push exitoso
- [x] AWS deploy exitoso
- [x] Base de datos actualizada
- [x] Handover creado y commiteado

### ‚è≠Ô∏è Pr√≥ximos Pasos
1. Esperar 5-10 min (propagaci√≥n CloudFront)
2. Limpiar cache navegador (Cmd+Shift+R)
3. Verificar versi√≥n en footer
4. [Acci√≥n espec√≠fica del deploy si aplica]

---
üîó **Ver handover completo**: `.cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md`
```

---

## üìù Plantilla de Handover (OBLIGATORIA)

**Nombre de archivo:** `.cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md`

**Estructura m√≠nima OBLIGATORIA:**

```markdown
# Handover: Deploy vX.X.X

**REF:** HANDOVER-YYYY-MM-DD-DEPLOY-vX.X.X  
**Fecha:** YYYY-MM-DD  
**Commit:** [hash del primer commit]  
**Versi√≥n:** BX.X.XNX.X.X

---

## üìã Resumen Ejecutivo

[Descripci√≥n breve del deploy - 1-2 l√≠neas]

---

## ‚úÖ Tareas Completadas

### 1. Actualizaci√≥n de C√≥digo
[Lista de archivos modificados]

### 2. Git Push
- Commit(s): [hash1, hash2]
- Push a: origin/main

### 3. Deploy AWS
- Build: [tiempo]
- URLs: [S3, CloudFront]

### 4. Base de Datos
- Tabla: system_config
- Config Key: app_version
- Versi√≥n: BX.X.XNX.X.X

---

## üìä Cambios Principales

[Bullet points de cambios importantes]

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

[Acciones para el usuario]

---

## üìö Referencias

[Links a docs relevantes]

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Lecciones Aprendidas:** [Si aplica]
```

---

## üö® Manejo de Errores

### Error en PASO 1 (Script)
```
‚ùå Script deploy-complete.ts fall√≥

Error: [mensaje del error]

üîß Soluciones posibles:
1. Verificar que no haya conflictos de merge
2. Verificar permisos de archivos
3. Ejecutar manualmente: tsx scripts/deploy-complete.ts

‚è∏Ô∏è Deploy DETENIDO en PASO 1
```

### Error en PASO 3 (BD)
```
‚ùå Actualizaci√≥n de BD fall√≥

Error: [mensaje del MCP]

üîß Soluciones posibles:
1. Verificar que MCP Supa_PQNC_AI est√© conectado
2. Verificar tabla system_config existe
3. Ejecutar manualmente v√≠a MCP

‚ö†Ô∏è Deploy PARCIAL: Git y AWS OK, BD pendiente
```

### Error en PASO 5 (Handover)
```
‚ùå Creaci√≥n de handover fall√≥

Error: [mensaje del error]

üîß Soluciones posibles:
1. Verificar que .cursor/handovers/ existe
2. Verificar permisos de escritura
3. Crear handover manualmente

‚ö†Ô∏è Deploy COMPLETO pero sin documentaci√≥n
```

---

## ‚öôÔ∏è Troubleshooting para el Agente

**Problema:** No s√© si debo ejecutar esta rule
**Soluci√≥n:** Si el usuario dice "deploy completo" o menciona @deploy-workflow.mdc, SIEMPRE ejecutar

**Problema:** Script deploy-complete.ts no existe
**Soluci√≥n:** DETENER y pedir al usuario que lo cree o use deploy manual

**Problema:** MCP Supa_PQNC_AI no responde
**Soluci√≥n:** Intentar 2 veces m√°s, si falla reportar error pero NO detener deploy (solo advertir)

**Problema:** No tengo el mensaje del deploy
**Soluci√≥n:** Usar mensaje por defecto: "Deploy autom√°tico v[X.X.X]"

**Problema:** Usuario cancel√≥ a mitad del proceso
**Soluci√≥n:** Reportar qu√© pasos se completaron y qu√© falta, crear handover parcial

**Si el script falla:**
- Verificar que la versi√≥n tenga el formato correcto
- Verificar que no haya cambios sin commitear (el script hace `git add -A`)
- Verificar permisos de escritura en archivos

**Si la BD no se actualiza:**
- Verificar que el MCP `Supa_PQNC_AI` est√© configurado
- Verificar que la tabla `system_config` exista
- Verificar que el access token tenga permisos

---

## üìö Referencias Internas

- Script principal: `scripts/deploy-complete.ts`
- Formato handover: `.cursor/rules/handover-format.mdc`
- MCP docs: `.cursor/rules/mcp-rules.mdc`
- Security checks: `.cursor/rules/security-rules.mdc`

---

## üéì Gu√≠a para el Usuario

### ¬øC√≥mo invocar correctamente este workflow?

**‚úÖ FORMA CORRECTA (Garantiza ejecuci√≥n completa):**
```
deploy completo
```

O con mensaje personalizado:
```
deploy completo con mensaje: Fix b√∫squeda WhatsApp + Performance
```

**‚ùå EVITAR (Puede ser ambiguo):**
- "documenta y actualiza" ‚Üí Puede interpretarse solo como actualizar docs
- "push a git" ‚Üí Solo hace git push, no AWS ni BD
- "deploy" ‚Üí Ambiguo, puede no incluir todos los pasos

### ¬øQu√© hace exactamente?

1. ‚úÖ Sincroniza documentaci√≥n a `public/docs/`
2. ‚úÖ Actualiza versi√≥n en `appVersion.ts` y `package.json`
3. ‚úÖ Hace git commit y push autom√°tico
4. ‚úÖ Deploy a AWS S3 + CloudFront
5. ‚úÖ Actualiza versi√≥n requerida en BD (`system_config`)
6. ‚úÖ Crea handover con REF √∫nico
7. ‚úÖ Commitea el handover
8. ‚úÖ Imprime resumen completo

### ¬øCu√°nto tarda?

- T√≠pico: 1-2 minutos
- Con muchos archivos: 3-5 minutos
- CloudFront propagation: +5-10 minutos adicionales

### ¬øPuedo cancelar?

S√≠, pero el agente reportar√° qu√© se complet√≥ y qu√© falta. Tendr√°s un handover parcial con el estado actual.

### ¬øQu√© pasa si algo falla?

El agente:
1. Detecta el error
2. Reporta qu√© paso fall√≥
3. Sugiere soluciones
4. Crea handover con estado PARCIAL
5. No contin√∫a pasos siguientes (safe-fail)

---

## üîê Seguridad

**Checks autom√°ticos de seguridad:**
- ‚úÖ Verifica que no se expongan API keys en bundle
- ‚úÖ Verifica que `system_config` use MCP seguro
- ‚úÖ Verifica que handover no contenga secretos
- ‚úÖ Verifica permisos de archivos antes de commit

**Si detecta un issue de seguridad:**
```
üö® SECURITY ISSUE DETECTADO

Tipo: [API key exposure / Credentials in bundle / etc]
Ubicaci√≥n: [archivo:l√≠nea]

‚õî DEPLOY BLOQUEADO
üîß Acci√≥n requerida: [pasos para resolver]

El deploy NO continuar√° hasta resolver el issue.
```

---

## üìä M√©tricas de √âxito

**Un deploy se considera 100% exitoso si:**
- ‚úÖ Todos los pre-checks pasaron
- ‚úÖ Script retorn√≥ exit code 0
- ‚úÖ Git push exitoso (retorn√≥ "main -> main")
- ‚úÖ AWS deploy exitoso (retorn√≥ "‚úÖ Frontend actualizado")
- ‚úÖ BD actualizada (MCP retorn√≥ "Updated 1 record")
- ‚úÖ Handover creado y commiteado
- ‚úÖ Auto-verificaci√≥n final: 100%

**M√©tricas t√≠picas:**
- Pre-checks: ~5 segundos
- Script ejecuci√≥n: 30-45 segundos
- BD update: 1-2 segundos
- Handover: 5 segundos
- **Total:** ~1 minuto

---

**√öltima actualizaci√≥n:** 2026-01-24  
**Versi√≥n del rule:** 3.0.0 (Modo estricto + Pre-checks + Auto-verificaci√≥n)
