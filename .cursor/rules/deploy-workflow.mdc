# Workflow de Despliegue

> **Descripci√≥n:** Proceso de deploy a Git y AWS.
> **Aplicaci√≥n:** Agent Requested (cuando usuario solicita deploy)
> **Trigger:** Usuario dice "push", "deploy", "documenta y actualiza"

---

## Cu√°ndo Aplicar Esta Regla

Cuando el usuario diga:
- "documenta y actualiza"
- "push a git"
- "push a git y aws"
- "deploy"
- "de acuerdo a la regla"

**‚ö†Ô∏è IMPORTANTE:** "documenta y actualiza" implica:
1. ‚úÖ Sincronizar documentaci√≥n
2. ‚úÖ Actualizar versiones en componentes
3. ‚úÖ Git commit y push
4. ‚úÖ Deploy a AWS (ejecutar `./update-frontend.sh`)
5. ‚úÖ Actualizar versi√≥n requerida en BD (despu√©s de deploy AWS)
6. ‚úÖ Crear handover final con REF

**Flujo autom√°tico:**
```
"documenta y actualiza"
    ‚Üì
Sincronizar docs (PASO 1)
    ‚Üì
Actualizar DocumentationModule.tsx (PASO 2)
    ‚Üì
Actualizar Footer.tsx (PASO 3)
    ‚Üì
Actualizar package.json si es release (PASO 4)
    ‚Üì
Git commit y push (PASO 5)
    ‚Üì
Deploy AWS con ./update-frontend.sh (PASO 6)
    ‚Üì
Actualizar versi√≥n requerida en BD v√≠a MCP SupabaseREST (PASO 6.5)
    ‚Üì
Crear handover con REF (PASO 7)
    ‚Üì
Imprimir REF + resumen en chat (PASO 8)
```

---

## Proceso Completo

### PASO 1: Sincronizar Documentaci√≥n

```bash
# Documentaci√≥n ra√≠z
cp CHANGELOG.md public/docs/
cp VERSIONS.md public/docs/

# Documentaci√≥n general
cp docs/*.md public/docs/ 2>/dev/null || true

# Documentaci√≥n de m√≥dulos
cp src/components/analysis/*.md public/docs/
cp src/components/chat/*.md public/docs/
cp src/components/prospectos/*.md public/docs/
cp src/components/admin/*.md public/docs/
cp src/components/aws/*.md public/docs/
cp src/components/scheduled-calls/*.md public/docs/

# Servicios y config
cp src/services/README.md public/docs/README_SERVICES.md
cp src/config/README.md public/docs/README_CONFIG.md
```

### PASO 2: Actualizar DocumentationModule.tsx

**Archivo:** `src/components/documentation/DocumentationModule.tsx`

1. **Actualizar stats** (~l√≠nea 367):
```typescript
const stats = [
  { label: 'Version', value: 'vX.X.X', highlight: true },
  { label: 'Release', value: 'BX.X.XNX.X.X', highlight: false },
  { label: 'Ultima actualizacion', value: 'DD Mes YYYY', highlight: false },
];
```

2. **Agregar commit a gitCommits[]** (~l√≠nea 256):
```typescript
{ hash: 'XXXXXXX', date: 'YYYY-MM-DD', author: 'Team', message: 'vX.X.X: Descripci√≥n', isRelease: true },
```

3. **Si es deploy AWS, agregar a awsDeployments[]** (~l√≠nea 321):
```typescript
{ id: 'deploy-XXX', date: 'YYYY-MM-DD HH:mm', version: 'BX.X.XNX.X.X', status: 'success', duration: 'XXs', triggeredBy: 'Samuel Rosales', environment: 'Production' },
```

### PASO 3: Actualizar Versi√≥n de la Aplicaci√≥n

**‚ö†Ô∏è IMPORTANTE:** Actualizar AMBOS archivos para mantener consistencia:

1. **Archivo:** `src/config/appVersion.ts` (~l√≠nea 15):
```typescript
export const APP_VERSION = 'BX.X.XNX.X.X';
```

2. **Archivo:** `src/components/Footer.tsx` (~l√≠nea 25):
```typescript
// Ya usa APP_VERSION importado, no requiere cambios manuales
// Pero verificar que el import est√© presente:
import { APP_VERSION } from '../config/appVersion';
const version = APP_VERSION;
```

**Nota:** El Footer.tsx ya importa `APP_VERSION` desde `appVersion.ts`, as√≠ que solo necesitas actualizar `appVersion.ts`.

### PASO 4: Actualizar package.json (si es release)

```json
"version": "X.X.X"
```

### PASO 5: Git Commit y Push

```bash
git add -A
git status  # Verificar cambios
git commit -m "vX.X.X: Descripci√≥n clara del cambio"
git push origin main
```

### PASO 6: Deploy a AWS (si se solicita)

```bash
./update-frontend.sh
```

### PASO 6.5: Actualizar Versi√≥n Requerida en BD (despu√©s de deploy AWS)

**‚ö†Ô∏è IMPORTANTE:** Ejecutar SOLO despu√©s de que el deploy a AWS est√© completo y la nueva versi√≥n est√© disponible.

**üîß M√©todo Autom√°tico usando MCP SupabaseREST:**

El agente DEBE ejecutar autom√°ticamente este paso usando el MCP `SupabaseREST` con el access token del usuario.

#### Paso a Paso para el Agente:

1. **Extraer versi√≥n de appVersion.ts:**
   - Leer `src/config/appVersion.ts`
   - Buscar l√≠nea con `export const APP_VERSION = 'BX.X.XNX.X.X';`
   - Extraer el valor completo (ej: `"B10.1.39N2.5.39"`)
   - **Nota:** Este es el archivo fuente de verdad. Footer.tsx importa esta constante.

2. **Verificar configuraci√≥n existente:**
   ```typescript
   mcp_SupabaseREST_query_table({
     table: "system_config",
     select: "config_key, config_value",
     filter: { config_key: "app_version" }
   })
   ```

3. **Actualizar o crear registro:**
   - Si existe: usar `mcp_SupabaseREST_update_data`
   - Si no existe: usar `mcp_SupabaseREST_insert_data`
   
   **Estructura del `config_value`:**
   ```json
   {
     "version": "B10.1.39N2.5.39",  // Versi√≥n completa del Footer.tsx
     "force_update": true
   }
   ```

4. **Ejemplo de actualizaci√≥n:**
   ```typescript
   // Si existe (UPDATE)
   mcp_SupabaseREST_update_data({
     table: "system_config",
     filter: { config_key: "app_version" },
     data: {
       config_value: {
         version: "B10.1.39N2.5.39",  // Versi√≥n extra√≠da del Footer.tsx
         force_update: true
       },
       updated_at: new Date().toISOString()
     }
   })
   
   // Si no existe (INSERT)
   mcp_SupabaseREST_insert_data({
     table: "system_config",
     data: {
       config_key: "app_version",
       config_value: {
         version: "B10.1.39N2.5.39",  // Versi√≥n extra√≠da del Footer.tsx
         force_update: true
       },
       description: "Versi√≥n requerida de la aplicaci√≥n. Los usuarios con versiones anteriores ser√°n forzados a actualizar."
     }
   })
   ```

5. **Verificar actualizaci√≥n:**
   ```typescript
   mcp_SupabaseREST_query_table({
     table: "system_config",
     select: "config_key, config_value, updated_at",
     filter: { config_key: "app_version" }
   })
   ```

#### Par√°metros del MCP:

- **MCP Name:** `SupabaseREST`
- **Access Token:** Le√≠do autom√°ticamente de `.supabase/access_token` (configurado en `~/.cursor/mcp.json`)
- **Proyecto:** `glsmifhkoaifvaegsozd` (PQNC_AI)
- **Tabla:** `system_config`
- **Config Key:** `app_version`

#### Notas Importantes:

- ‚úÖ El MCP lee el access token autom√°ticamente de `.supabase/access_token`
- ‚úÖ No requiere service_role_key ni variables de entorno adicionales
- ‚úÖ Usa Management API REST de Supabase (acceso total de admin)
- ‚úÖ La versi√≥n debe ser el formato COMPLETO del Footer (ej: `"B10.1.39N2.5.39"`)
- ‚ö†Ô∏è El sistema de control de versiones compara la PRIMERA parte antes de "N" (ej: `"B10.1.39"`)

#### M√©todo Manual (Alternativa):

Si el MCP no est√° disponible, usar script:
```bash
# Leer versi√≥n del Footer.tsx manualmente y ejecutar:
tsx scripts/update-app-version.ts "B10.1.39N2.5.39"
```

### PASO 7: Crear Handover Final

**Formato:**
```markdown
REF: HANDOVER-YYYY-MM-DD-DEPLOY-vX.X.X
```

**Contenido m√≠nimo:**
- Versi√≥n desplegada
- Archivos principales modificados
- Commits realizados
- Estado del deploy AWS
- Pr√≥ximos pasos (si aplica)

Ver `.cursor/rules/handover-format.mdc` para estructura completa.

### PASO 8: Informar Resultado

**En el chat, imprimir solo:**

```markdown
‚úÖ Deploy completado

**REF**: `HANDOVER-YYYY-MM-DD-DEPLOY-vX.X.X`  
**Ubicaci√≥n**: `.cursor/handovers/YYYY-MM-DD-deploy-vX-X-X.md`

**Resumen r√°pido**:
- ‚úÖ Documentaci√≥n sincronizada (N archivos)
- ‚úÖ Versi√≥n actualizada: BX.X.XNX.X.X (Footer.tsx)
- ‚úÖ Git push: commit XXXXXXX
- ‚úÖ AWS deploy: exitoso (XXs)
- ‚úÖ Versi√≥n requerida actualizada en BD (v√≠a MCP SupabaseREST)
- Pr√≥ximo: [acci√≥n si aplica]
```

**‚ö†Ô∏è NO repetir el handover completo en el chat** - Solo REF + resumen.

---

## Formato de Commits

```
# Releases
vX.X.X: BX.X.XNX.X.X - Descripci√≥n breve

# Fixes
fix: Descripci√≥n del bug corregido

# Features
feat: Descripci√≥n de nueva funcionalidad

# Refactors
refactor: Descripci√≥n del cambio

# Documentaci√≥n
docs: Descripci√≥n de actualizaci√≥n
```

---

## Versionamiento

```
Formato p√∫blico: vMAJOR.MINOR.PATCH
Formato interno: BBACKEND.NNX.NFRONTEND

Ejemplo: v2.1.26 = B6.0.3N6.0.0
```

---

## Qu√© Documentar Seg√∫n el Cambio

| Tipo | Documentos |
|------|------------|
| Cambio en Analysis | CHANGELOG_ANALISIS_IA.md o CHANGELOG_LIVEMONITOR.md |
| Cambio en Chat | CHANGELOG_LIVECHAT.md |
| Cambio en Prospectos | CHANGELOG_PROSPECTOS.md |
| Cambio en Admin | CHANGELOG_PQNC_HUMANS.md |
| Cambio en AWS | CHANGELOG_AWS_MANAGER.md |
| Bug Fix general | CHANGELOG.md (si significativo) |
| Nueva Feature | CHANGELOG.md + doc del m√≥dulo |
| Release | CHANGELOG.md, VERSIONS.md, package.json |
