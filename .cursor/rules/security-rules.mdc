---
alwaysApply: true
---

# üîí Reglas de Seguridad - PQNC QA AI Platform

**Fecha de Vigencia:** 16 de Enero 2026  
**Versi√≥n:** v3.1.0  
**√öltima actualizaci√≥n:** 16 de Enero 2026 20:52 UTC  
**CR√çTICO:** Estas reglas son OBLIGATORIAS para todo desarrollo

---

## ‚õî PROHIBICIONES ABSOLUTAS

### 1. NUNCA Usar Clientes Admin

Los clientes `*Admin` fueron **ELIMINADOS** del codebase. Si ves c√≥digo que los usa, est√° DESACTUALIZADO.

```typescript
// ‚ùå PROHIBIDO - ESTOS CLIENTES YA NO EXISTEN
import { supabaseSystemUIAdmin } from '../config/supabaseSystemUI';
import { analysisSupabaseAdmin } from '../config/analysisSupabaseAdmin';
import { pqncSupabaseAdmin } from '../config/pqncSupabase';

// ‚úÖ CORRECTO - Usar clientes normales
import { supabaseSystemUI } from '../config/supabaseSystemUI';
import { analysisSupabase } from '../config/analysisSupabase';
```

### 2. NUNCA Exponer Service Role Keys

```typescript
// ‚ùå PROHIBIDO - Nunca usar service_key en frontend
const serviceKey = import.meta.env.VITE_*_SERVICE_KEY;
const client = createClient(url, serviceKey);

// ‚ùå PROHIBIDO - Nunca hardcodear keys
const key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...service_role...';

// ‚úÖ CORRECTO - Solo anon_key
const anonKey = import.meta.env.VITE_ANALYSIS_SUPABASE_ANON_KEY;
const client = createClient(url, anonKey);
```

### 3. NUNCA Crear Nuevos Clientes Admin

Si una funcionalidad requiere permisos elevados, usar Edge Functions:

```typescript
// ‚ùå PROHIBIDO - Crear cliente con service_role
const adminClient = createClient(url, import.meta.env.VITE_SERVICE_KEY);
await adminClient.from('users').update({ is_admin: true });

// ‚úÖ CORRECTO - Usar Edge Function
await fetch(`${EDGE_FUNCTIONS_URL}/functions/v1/auth-admin-proxy`, {
  method: 'POST',
  headers: { 'Authorization': `Bearer ${anonKey}` },
  body: JSON.stringify({ action: 'updateUser', userId, data: { is_admin: true } })
});
```

---

## ‚úÖ PATRONES CORRECTOS

### Consultas a Base de Datos

```typescript
// ‚úÖ CORRECTO - Usar cliente normal
const { data, error } = await supabaseSystemUI
  .from('auth_users')
  .select('*')
  .eq('id', userId);

// ‚úÖ CORRECTO - Usar analysisSupabase para datos de an√°lisis
const { data } = await analysisSupabase
  .from('prospectos')
  .select('*');
```

### Operaciones de Escritura

```typescript
// ‚úÖ CORRECTO - INSERT/UPDATE/DELETE con cliente normal
await supabaseSystemUI
  .from('auth_users')
  .update({ last_login: new Date().toISOString() })
  .eq('id', userId);
```

### Edge Functions

```typescript
// ‚úÖ CORRECTO - Llamar Edge Function
const edgeFunctionsUrl = import.meta.env.VITE_EDGE_FUNCTIONS_URL;
const anonKey = import.meta.env.VITE_ANALYSIS_SUPABASE_ANON_KEY;

const response = await fetch(`${edgeFunctionsUrl}/functions/v1/mi-funcion`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${anonKey}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(payload)
});
```

---

## üîß Configuraci√≥n de Ambiente

### .env.production (SOLO ANON KEYS)

```bash
# ‚úÖ CORRECTO - Solo anon_key en producci√≥n
VITE_ANALYSIS_SUPABASE_URL=https://glsmifhkoaifvaegsozd.supabase.co
VITE_ANALYSIS_SUPABASE_ANON_KEY=eyJ...anon...

VITE_SYSTEM_UI_SUPABASE_URL=https://glsmifhkoaifvaegsozd.supabase.co
VITE_SYSTEM_UI_SUPABASE_ANON_KEY=eyJ...anon...

VITE_EDGE_FUNCTIONS_URL=https://glsmifhkoaifvaegsozd.supabase.co

# ‚ùå NUNCA AGREGAR ESTAS L√çNEAS
# VITE_ANALYSIS_SUPABASE_SERVICE_KEY=...
# VITE_SYSTEM_UI_SUPABASE_SERVICE_KEY=...
```

### .env.local (Desarrollo)

```bash
# En desarrollo puedes tener service_key para MCPs y testing
# PERO: Nunca se usar√° en el bundle de producci√≥n
VITE_ANALYSIS_SUPABASE_SERVICE_KEY=eyJ...service_role...
```

---

## üõ°Ô∏è Estado de Seguridad Actual

### RLS (Row Level Security)

**Estado: HABILITADO con pol√≠ticas seguras (actualizado 2026-01-16)**

| Tabla | RLS | Pol√≠tica |
|-------|-----|----------|
| `auth_users` | ‚úÖ | Solo `service_role` (password_hash protegido) |
| `auth_sessions` | ‚úÖ | Solo `service_role` |
| `api_auth_tokens` | ‚úÖ | Solo `service_role` |
| `system_config` | ‚úÖ | Lectura p√∫blica, escritura `service_role` |
| `prospectos` | ‚úÖ | Usuarios autenticados |
| `llamadas_ventas` | ‚úÖ | Usuarios autenticados |

### Vistas Seguras (Solo Usuarios Autenticados)

**‚ö†Ô∏è ACTUALIZACI√ìN 2026-01-16:** Todas las vistas requieren autenticaci√≥n (`authenticated` role)

| Vista | Descripci√≥n | Acceso |
|-------|-------------|--------|
| `auth_users_safe` | Datos de usuarios SIN `password_hash` | ‚úÖ Solo authenticated |
| `api_auth_tokens_safe` | Metadatos de tokens SIN `token_value` | ‚úÖ Solo authenticated |
| `user_profiles_v2` | Perfiles completos SIN `password_hash` | ‚úÖ Solo authenticated |
| **Todas las vistas** (23 total) | Analytics, WhatsApp, Llamadas, etc. | ‚úÖ Solo authenticated |

**Implementaci√≥n:**
- `REVOKE ALL` de rol `anon` en todas las vistas
- `GRANT SELECT` solo a `authenticated` y `service_role`
- Previene enumeraci√≥n de datos sin login

### Funciones RPC Seguras

| Funci√≥n | Requiere Auth | Descripci√≥n |
|---------|---------------|-------------|
| `get_credential_value(module, key)` | ‚úÖ | Obtiene tokens de API (solo autenticados) |
| `check_account_locked(email)` | ‚ùå | Verifica bloqueo de cuenta |
| `get_user_permissions(user_id)` | ‚úÖ | Obtiene permisos del usuario |

### Edge Functions

**Ubicaci√≥n: PQNC_AI (glsmifhkoaifvaegsozd)**

| Funci√≥n | Requiere Auth | Uso |
|---------|---------------|-----|
| `multi-db-proxy` | ‚úÖ JWT User | Acceso seguro a PQNC_QA y LOGMONITOR |
| `auth-admin-proxy` | ‚úÖ | Operaciones admin de autenticaci√≥n |
| `secure-query` | ‚úÖ | Consultas seguras a PQNC_AI |
| `pause-bot-proxy` | ‚úÖ | Control de bot WhatsApp |

---

## üìã Checklist Pre-Commit

Antes de hacer commit/push, verificar:

- [ ] No hay imports de clientes `*Admin`
- [ ] No hay `service_role_key` hardcodeado
- [ ] No hay variables `VITE_*_SERVICE_KEY` usadas en c√≥digo frontend
- [ ] `.env.production` solo tiene `anon_key`

---

## üìã Checklist Pre-Deploy

Antes de desplegar a producci√≥n:

```bash
# 1. Build limpio
rm -rf dist
npm run build

# 2. Verificar bundle
for jwt in $(grep -oh "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9[^\"']*" dist/assets/index-*.js | sort -u); do
    payload=$(echo "$jwt" | cut -d. -f2 | base64 -d 2>/dev/null)
    if echo "$payload" | grep -q "service_role"; then
        echo "‚ùå ABORT: SERVICE_ROLE KEY EN BUNDLE"
        exit 1
    fi
done
echo "‚úÖ Bundle seguro"

# 3. Deploy
./update-frontend.sh
```

---

## üìö Documentaci√≥n Relacionada

- **Pentesting 2026-01-16:** `docs/PENTESTING_2026-01-16.md`
- **Arquitectura Completa:** `docs/ARQUITECTURA_SEGURIDAD_2026.md`
- **Edge Functions:** `docs/EDGE_FUNCTIONS_CATALOG.md`
- **Cat√°logo MCP:** `docs/MCP_CATALOG.md`

---

## üîê Acceso a Credenciales desde Frontend

### Patr√≥n Correcto (Post-RLS)

```typescript
// ‚ùå INCORRECTO - La tabla est√° bloqueada por RLS
const { data } = await supabase.from('api_auth_tokens').select('token_value');

// ‚úÖ CORRECTO - Usar RPC (requiere usuario autenticado)
const { data } = await supabase.rpc('get_credential_value', {
  p_module_name: 'ElevenLabs',
  p_token_key: 'API_KEY'
});

// ‚úÖ CORRECTO - Usar vista segura para verificar existencia
const { data } = await supabase.from('api_auth_tokens_safe').select('module_name,has_value');
```

### Acceso a Datos de Usuario

```typescript
// ‚ùå INCORRECTO - La tabla est√° bloqueada por RLS
const { data } = await supabase.from('auth_users').select('*');

// ‚úÖ CORRECTO - Usar vista segura (sin password_hash)
const { data } = await supabase.from('auth_users_safe').select('*');

// ‚úÖ CORRECTO - Usar vista de perfiles con role info (sin password_hash)
const { data } = await supabase.from('user_profiles_v2').select('*');

// ‚úÖ CORRECTO - Usar Edge Function para operaciones admin
await authAdminProxyService.updateUserField(userId, 'is_operativo', true);

// ‚ùå INCORRECTO - Vista eliminada (expon√≠a password_hash)
const { data } = await supabase.from('auth_user_profiles').select('*'); // ELIMINADA 2026-01-16
```

---

**‚ö†Ô∏è IMPORTANTE:** Cualquier violaci√≥n de estas reglas puede exponer credenciales de producci√≥n y comprometer la seguridad del sistema.

**√öltima auditor√≠a:** 16 de Enero 2026 - ‚úÖ APROBADA
