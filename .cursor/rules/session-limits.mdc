# LÃ­mites de SesiÃ³n y PrevenciÃ³n de Overflow

> **DescripciÃ³n:** Reglas para prevenir exceder lÃ­mites de tokens y costos adicionales.
> **AplicaciÃ³n:** Always (Siempre activa)
> **Prioridad:** CRÃTICA - Afecta costos directamente

---

## El Problema

```
Ventana de Contexto Sonnet: 200K tokens
Si excedes 200K â†’ Costo x2 por token
Si sigues â†’ 300K, 400K... â†’ Costos se disparan exponencialmente
```

**No hay alerta automÃ¡tica.** Debes monitorear manualmente.

---

## Reglas de LÃ­mites

### Regla de los 50 Mensajes

```
MÃ¡ximo: 50 intercambios (mensajes) por chat
DespuÃ©s de 50 â†’ NUEVO CHAT obligatorio
```

### Regla de la 1 Hora

```
SesiÃ³n mÃ¡xima: 1-2 horas de trabajo continuo
DespuÃ©s â†’ Crear resumen â†’ Nuevo chat
```

### Regla de la Tarea

```
1 feature = 1 chat
1 bug fix = 1 chat
Completar â†’ Commit â†’ Nuevo chat
```

---

## SeÃ±ales de Overflow Inminente

### SÃ­ntomas de Contexto Saturado:

| SeÃ±al | Significado | AcciÃ³n |
|-------|-------------|--------|
| Respuestas mÃ¡s lentas | Cerca del lÃ­mite | Preparar nuevo chat |
| Respuestas menos precisas | Contexto saturado | Nuevo chat YA |
| "Olvida" cosas mencionadas | Overflow | Nuevo chat URGENTE |
| Chat se siente "pesado" | Muchos tokens | Nuevo chat |
| Errores que ya corrigiÃ³ | Contexto perdido | Nuevo chat |

---

## Protocolo de SesiÃ³n Segura

### Al Iniciar Chat:

```
1. Definir tarea especÃ­fica (1 sola)
2. Cargar solo archivos necesarios (@Files)
3. Revisar si hay handover previo
4. Establecer objetivo claro
```

### Durante el Chat:

```
Cada 15-20 mensajes:
1. Â¿Estoy avanzando?
2. Â¿El agente sigue coherente?
3. Â¿Necesito un checkpoint?

Si algo falla â†’ Nuevo chat con resumen
```

### Al Completar Tarea:

```
1. Verificar cambios funcionan
2. Hacer commit
3. Si hay mÃ¡s trabajo â†’ Nuevo chat
4. Guardar handover si es necesario
```

---

## CÃ³mo Crear Nuevo Chat Eficientemente

### Paso 1: Guardar Contexto CrÃ­tico

```markdown
// Copiar esto antes de cerrar:

## Estado Actual:
- Archivo: src/components/X.tsx
- LÃ­nea: ~150
- Cambio: Implementando funciÃ³n Y

## Lo que funciona:
- [Lista de lo completado]

## Pendiente:
- [Lo que falta]
```

### Paso 2: Iniciar Nuevo Chat

```
Mensaje inicial:
"ContinÃºo trabajo de sesiÃ³n anterior.

Estado: [pegar resumen]
Archivo principal: [archivo]
PrÃ³ximo paso: [lo que sigue]"
```

### Paso 3: Cargar Contexto MÃ­nimo

```
@src/components/X.tsx (archivo principal)
@src/services/Y.ts (solo si necesario)

NO cargar todo el proyecto
```

---

## EstimaciÃ³n de Tokens

### Aproximados por Tipo de InteracciÃ³n:

| Tipo | Tokens Estimados |
|------|------------------|
| Mensaje simple | 500-1K |
| Respuesta con cÃ³digo | 2-5K |
| read_file (archivo mediano) | 5-20K |
| read_file (archivo grande) | 20-50K |
| grep (resultados extensos) | 5-15K |
| codebase_search | 10-30K |

### Presupuesto por SesiÃ³n:

```
LÃ­mite seguro: 150K tokens (75% de 200K)
Margen de seguridad: 50K tokens

SesiÃ³n tÃ­pica de 1 hora: ~50-100K tokens
SesiÃ³n con muchos archivos: ~100-150K tokens
```

---

## Workflow Anti-Overflow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Inicio Chat    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tarea EspecÃ­ficaâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ~20 mensajes    â”‚â”€â”€â”€â”€â–ºâ”‚ Checkpoint      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â¿Tarea completa?â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
  [SÃ­]      [No]
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Commit â”‚  â”‚>40 mensajes?â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â–¼         â”Œâ”€â”€â”€â”´â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”     â–¼       â–¼
â”‚Nuevo  â”‚   [SÃ­]    [No]
â”‚Chat   â”‚     â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜     â–¼       â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚Handoverâ”‚ â”‚Continuarâ”‚
         â”‚+ Nuevoâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚Chat   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Recordatorios Proactivos del Agente

### OBLIGATORIO: Detectar y Avisar

El agente DEBE monitorear y avisar proactivamente cuando detecte:

1. **Muchas herramientas usadas** (>15 llamadas a read_file, grep, etc.)
2. **MÃºltiples archivos distintos** referenciados (>10 archivos)
3. **ConversaciÃ³n extensa** (estimado >30 intercambios)
4. **Cambio de tema/tarea** dentro del mismo chat

### Mensaje de Aviso (usar cuando aplique):

```
ğŸ“Š **Aviso de SesiÃ³n**

Esta sesiÃ³n tiene bastante contexto acumulado.
Para mantener precisiÃ³n y evitar costos extras, recomiendo:

1. Hacer commit de cambios actuales
2. Crear handover con estado actual
3. Continuar en nuevo chat

Â¿Deseas que prepare el handover ahora?
```

### Al completar una feature/tarea:

```
âœ… **Tarea completada**

Recomiendo:
1. Verificar que los cambios funcionan
2. Hacer commit
3. Iniciar nuevo chat para siguiente tarea

Â¿Procedemos con el commit?
```

### Al detectar que el usuario cambia de tema:

```
ğŸ’¡ **Sugerencia**

Veo que vamos a trabajar en algo diferente.
Para mejor contexto, Â¿prefieres continuar aquÃ­ o abrir nuevo chat?
```

### Cada ~20-25 intercambios:

El agente debe hacer un "checkpoint mental" y si hay mucho contexto acumulado, sugerir:

```
ğŸ”„ **Checkpoint de SesiÃ³n**

Llevamos un buen rato trabajando. Estado actual:
- Archivos modificados: [lista]
- Pendiente: [lista]

Â¿Continuamos o prefieres nuevo chat con handover?
```

---

## Comandos RÃ¡pidos

### Para el Usuario:

- **"nuevo chat"** â†’ Crear resumen y recomendar nuevo chat
- **"checkpoint"** â†’ Generar resumen del estado actual
- **"cuÃ¡ntos mensajes"** â†’ Estimar mensajes en sesiÃ³n actual
- **"handover"** â†’ Crear documento de handover completo
