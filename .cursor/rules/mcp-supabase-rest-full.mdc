# Reglas del MCP Supabase REST (Actualizado)

**Fecha de actualizaci√≥n:** 27 de Enero 2026  
**Versi√≥n:** 2.0.0  
**Estado:** ‚úÖ Completamente funcional

---

## üìã Informaci√≥n del MCP

| Propiedad | Valor |
|-----------|-------|
| **Nombre en Cursor** | `user-SupabaseREST` |
| **Tipo** | REST API + RPC Functions |
| **Proyecto** | PQNC_AI (`glsmifhkoaifvaegsozd`) |
| **Token** | `service_role_key` en `~/.cursor/mcp.json` |
| **Capacidad** | SQL completo (DDL + DML) |

---

## ‚ö†Ô∏è IMPORTANTE - Seguridad

### ‚úÖ D√≥nde est√° el `service_role_key`

```
~/.cursor/mcp.json  ‚Üê Solo aqu√≠ (NO en el proyecto)
```

**Este archivo:**
- ‚úÖ Es local en tu computadora
- ‚úÖ NO est√° en Git
- ‚úÖ NO se incluye en el bundle
- ‚úÖ Solo lo usa el MCP (servidor local)

### ‚ùå D√≥nde NUNCA debe estar

```
‚ùå src/config/*.ts
‚ùå .env o .env.production
‚ùå Cualquier archivo con VITE_*
‚ùå C√≥digo fuente del proyecto
```

### üîí Funciones Seguras en Supabase

El MCP usa 2 funciones RPC en Supabase:

#### 1. `exec_sql` (Ya exist√≠a)
```sql
-- Para SELECT/INSERT/UPDATE/DELETE que devuelven datos
-- Accesible con: service_role_key
```

#### 2. `exec_ddl` (Nueva - Creada 2026-01-27)
```sql
-- Para CREATE/DROP/ALTER que NO devuelven datos
-- SOLO accesible con: service_role_key
-- REVOCADO acceso a: anon, authenticated, public

CREATE OR REPLACE FUNCTION exec_ddl(sql_command TEXT)
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  EXECUTE sql_command;
  RETURN 'OK';
END;
$$;

REVOKE ALL ON FUNCTION exec_ddl(TEXT) FROM PUBLIC;
GRANT EXECUTE ON FUNCTION exec_ddl(TEXT) TO service_role;
```

**Seguridad:** Aunque exista en Supabase, **NO puede ser llamada con `anon_key`** (frontend), solo con `service_role_key` (MCP local).

---

## üîß Herramientas Disponibles

### SQL Completo
```typescript
mcp_user-SupabaseREST_execute_sql
```

**Detecta autom√°ticamente:**
- DDL (CREATE, DROP, ALTER) ‚Üí usa `exec_ddl`
- DML (SELECT, INSERT, UPDATE, DELETE) ‚Üí usa `exec_sql`

**Ejemplos:**
```typescript
// CREATE TABLE
execute_sql({ sql: "CREATE TABLE test (id serial)" })

// DROP FUNCTION
execute_sql({ sql: "DROP FUNCTION my_func CASCADE" })

// CREATE FUNCTION
execute_sql({ sql: "CREATE FUNCTION ..." })

// SELECT
execute_sql({ sql: "SELECT * FROM prospectos LIMIT 5" })
```

### Operaciones Espec√≠ficas
```typescript
mcp_user-SupabaseREST_query_table        // SELECT con filtros
mcp_user-SupabaseREST_insert_data        // INSERT
mcp_user-SupabaseREST_update_data        // UPDATE
mcp_user-SupabaseREST_delete_data        // DELETE
mcp_user-SupabaseREST_get_schema         // Ver tablas
mcp_user-SupabaseREST_get_table_info     // Ver columnas
mcp_user-SupabaseREST_backup_table       // Backup JSON
mcp_user-SupabaseREST_debug_connection   // Test conexi√≥n
```

---

## üìù Ejemplos de Uso

### Crear Vista
```typescript
CallMcpTool({
  server: "user-SupabaseREST",
  toolName: "execute_sql",
  arguments: {
    sql: `CREATE OR REPLACE VIEW my_view AS 
          SELECT p.*, e.full_name 
          FROM prospectos p 
          LEFT JOIN auth_users e ON p.ejecutivo_id = e.id`
  }
})
```

### Actualizar Configuraci√≥n
```typescript
CallMcpTool({
  server: "user-SupabaseREST",
  toolName: "update_data",
  arguments: {
    table: "system_config",
    data: { 
      config_value: { version: "1.0.0", force_update: true }
    },
    filter: { config_key: "app_version" }
  }
})
```

### Consultar con Filtros
```typescript
CallMcpTool({
  server: "user-SupabaseREST",
  toolName: "query_table",
  arguments: {
    table: "prospectos",
    select: "id, nombre, telefono",
    filter: { coordinacion_id: "abc-123" },
    limit: 10,
    order: "created_at.desc"
  }
})
```

---

## üö´ Limitaciones

### ‚ùå NO Funciona Para
- Queries extremadamente largas (>100KB)
- Transacciones multi-statement con `BEGIN/COMMIT`
- Modificar usuarios de auth.users (usar Dashboard)

### ‚úÖ S√ç Funciona Para
- CREATE/DROP/ALTER TABLE
- CREATE/DROP/ALTER FUNCTION
- CREATE/DROP TRIGGER
- CREATE/DROP VIEW
- CREATE/DROP INDEX
- INSERT/UPDATE/DELETE en cualquier tabla
- SELECT con JOINs complejos

---

## üîç Troubleshooting

### MCP no funciona despu√©s de cambios
```bash
# 1. Limpiar cache
rm -rf ~/.cursor/projects/.../mcps/user-SupabaseREST/

# 2. Reiniciar Cursor
Cmd+Q ‚Üí Esperar 5s ‚Üí Reabrir
```

### Error "function exec_ddl does not exist"
```bash
# Ejecutar en Supabase Dashboard:
cat CREAR_EXEC_DDL_SEGURO.sql
# ‚Üí Copiar y pegar en SQL Editor
```

### Error "JWT failed verification"
```bash
# Verificar que service_role_key est√© en ~/.cursor/mcp.json
cat ~/.cursor/mcp.json | grep SUPABASE_SERVICE_ROLE_KEY
```

---

## üìö Documentaci√≥n Relacionada

| Documento | Prop√≥sito |
|-----------|-----------|
| `SUPABASE_CREDENTIALS.local.md` | üîë Credenciales (NO en Git) |
| `CREAR_EXEC_DDL_SEGURO.sql` | Script para crear `exec_ddl` |
| `mcp-supabase-rest-server.ts` | C√≥digo del servidor MCP |
| `docs/DIAGNOSTICO_MCP_SUPABASE_REST.md` | Historial de problemas |
| `.cursor/rules/security-rules.mdc` | Reglas generales de seguridad |

---

## ‚ö° Checklist de Seguridad

Antes de cada commit:

- [ ] `service_role_key` NO est√° en c√≥digo fuente
- [ ] `SUPABASE_CREDENTIALS.local.md` est√° en `.gitignore`
- [ ] `.env.production` solo tiene `anon_key`
- [ ] Build no contiene `service_role`: `grep -r "service_role" dist/`

---

**√öltima actualizaci√≥n:** 27 de Enero 2026  
**Autor:** MCP Setup con seguridad completa  
**Validado:** ‚úÖ Funcionando con DDL completo
