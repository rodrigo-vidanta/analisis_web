# Sistema de Tickets de Soporte - Reglas de Desarrollo

**Fecha de Creaci√≥n:** 20 de Enero 2026  
**Versi√≥n:** v1.0.0  
**M√≥dulo:** `src/components/support/`

---

## üìã Descripci√≥n General

El Sistema de Tickets de Soporte permite a usuarios reportar fallas y solicitar requerimientos. Incluye:
- Captura autom√°tica de pantalla
- Notificaciones en tiempo real
- Gesti√≥n de tickets por administradores
- Historial de cambios y comentarios

---

## üèóÔ∏è Arquitectura de Base de Datos

### Proyecto Supabase
- **Proyecto:** PQNC_AI (`glsmifhkoaifvaegsozd`)
- **RLS:** ‚úÖ Habilitado con pol√≠ticas seguras
- **Realtime:** ‚úÖ Habilitado en tablas principales

### Tablas Principales

| Tabla | Descripci√≥n | RLS |
|-------|-------------|-----|
| `support_tickets` | Tickets principales | ‚úÖ |
| `support_ticket_comments` | Comentarios y respuestas | ‚úÖ |
| `support_ticket_history` | Historial de cambios | ‚úÖ |
| `support_ticket_attachments` | Archivos adjuntos | ‚úÖ |
| `support_ticket_notifications` | Notificaciones tiempo real | ‚úÖ |

### Esquema de `support_tickets`

```sql
CREATE TABLE support_tickets (
  id UUID PRIMARY KEY,
  ticket_number VARCHAR(20) UNIQUE,          -- Formato: TKT-YYYYMMDD-XXXX
  type VARCHAR(20) NOT NULL,                 -- 'reporte_falla' | 'requerimiento'
  category VARCHAR(50),                      -- Categor√≠a del requerimiento
  subcategory VARCHAR(100),                  -- Subcategor√≠a
  status VARCHAR(20) DEFAULT 'abierto',      -- Estado del ticket
  priority VARCHAR(10) DEFAULT 'normal',     -- Prioridad
  
  title VARCHAR(200) NOT NULL,               -- T√≠tulo
  description TEXT NOT NULL,                 -- Descripci√≥n
  
  -- Contexto de captura
  app_version VARCHAR(50),                   -- Versi√≥n del footer
  user_agent TEXT,                           -- Navegador
  current_module VARCHAR(50),                -- M√≥dulo donde se report√≥
  prospecto_id UUID,                         -- ID del prospecto (si aplica)
  prospecto_nombre VARCHAR(200),             -- Nombre del prospecto
  session_details JSONB,                     -- Detalles de sesi√≥n
  
  -- Screenshots
  screenshot_url TEXT,                       -- URL en Storage (preferido)
  screenshot_base64 TEXT,                    -- Base64 (legacy)
  
  -- Formulario din√°mico
  form_data JSONB,                           -- Datos del formulario
  
  -- Reporter
  reporter_id UUID NOT NULL,                 -- ID del usuario que reporta
  reporter_name VARCHAR(200),
  reporter_email VARCHAR(200),
  reporter_role VARCHAR(50),
  
  -- Asignaci√≥n
  assigned_to UUID,
  assigned_at TIMESTAMPTZ,
  assigned_by UUID,
  
  -- Timestamps
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  resolved_at TIMESTAMPTZ,
  closed_at TIMESTAMPTZ
);
```

### Estados de Ticket (`status`)

| Estado | Descripci√≥n | Siguiente Estado V√°lido |
|--------|-------------|------------------------|
| `abierto` | Reci√©n creado | `en_progreso`, `pendiente_info`, `cancelado` |
| `en_progreso` | En proceso de resoluci√≥n | `pendiente_info`, `resuelto`, `cancelado` |
| `pendiente_info` | Esperando info del usuario | `en_progreso`, `cerrado` |
| `resuelto` | Problema resuelto | `cerrado`, `abierto` (reabierto) |
| `cerrado` | Ticket finalizado | N/A |
| `cancelado` | Cancelado por admin | N/A |

### Prioridades (`priority`)

| Prioridad | Descripci√≥n | SLA Sugerido |
|-----------|-------------|--------------|
| `baja` | No urgente | 72 horas |
| `normal` | Est√°ndar | 48 horas |
| `alta` | Importante | 24 horas |
| `urgente` | Cr√≠tico | 4 horas |

### Tipos de Ticket (`type`)

| Tipo | Descripci√≥n |
|------|-------------|
| `reporte_falla` | Bug o error en la aplicaci√≥n |
| `requerimiento` | Solicitud de cambio o mejora |

---

## üîí Seguridad

### Pol√≠ticas RLS

```sql
-- TICKETS: Usuarios ven solo sus tickets, admins ven todos
"Users can view own tickets" ‚Üí reporter_id = auth.uid() OR is_support_admin()
"Users can create tickets"   ‚Üí reporter_id = auth.uid()
"Admins can update tickets"  ‚Üí is_support_admin()
"Admins can delete tickets"  ‚Üí is_support_admin()

-- COMENTARIOS: Usuarios no ven comentarios internos
"Users can view comments on own tickets" ‚Üí (ticket.reporter_id = auth.uid() AND is_internal = FALSE) OR is_support_admin()
"Users can add comments to own tickets"  ‚Üí is_internal = FALSE (forzado para usuarios)
```

### Funci√≥n de Seguridad

```sql
-- is_support_admin(): SECURITY DEFINER
-- Verifica si el usuario actual es admin, admin_operativo o developer
-- Roles permitidos:
--   - admin: 12690827-493e-447b-ac2f-40174fe17389
--   - administrador_operativo: 34cc26d1-8a96-4be2-833e-7a13d5553722
--   - developer: 59386336-794d-40de-83a4-de73681d6904
```

### Storage Buckets

| Bucket | P√∫blico | L√≠mite | Uso |
|--------|---------|--------|-----|
| `support-tickets` | ‚úÖ | 10 MB | Screenshots de reportes |
| `user-avatars` | ‚úÖ | 5 MB | Fotos de perfil |

---

## üîî Notificaciones en Tiempo Real

### Triggers Autom√°ticos

| Evento | Trigger | Destinatario |
|--------|---------|--------------|
| Nuevo ticket | `trigger_notify_new_ticket` | Todos los admins |
| Cambio status | `trigger_notify_status_change` | Reporter |
| Admin responde | `trigger_notify_new_comment` | Reporter (si no es interno) |
| Usuario responde | `trigger_notify_new_comment` | Todos los admins |

### Suscripci√≥n Realtime

```typescript
// Suscribirse a notificaciones
const channel = ticketService.subscribeToNotifications(userId, (notification) => {
  // Manejar nueva notificaci√≥n
  console.log('Nueva notificaci√≥n:', notification);
});

// Desuscribirse
ticketService.unsubscribeFromNotifications(channel);
```

---

## üìÅ Estructura de Archivos

```
src/components/support/
‚îú‚îÄ‚îÄ index.ts                  # Exports del m√≥dulo
‚îú‚îÄ‚îÄ SupportButton.tsx         # Bot√≥n salvavidas en header
‚îú‚îÄ‚îÄ ReportIssueModal.tsx      # Modal de reporte de falla
‚îú‚îÄ‚îÄ RequestModal.tsx          # Modal de requerimiento
‚îú‚îÄ‚îÄ MyTicketsModal.tsx        # Modal "Mis Tickets"
‚îú‚îÄ‚îÄ AdminTicketsPanel.tsx     # Panel de administraci√≥n
‚îú‚îÄ‚îÄ README_TICKETS.md         # Documentaci√≥n t√©cnica
‚îî‚îÄ‚îÄ CHANGELOG_TICKETS.md      # Control de cambios

src/services/
‚îî‚îÄ‚îÄ ticketService.ts          # Servicio de tickets
```

---

## üîß Servicio de Tickets (`ticketService`)

### Funciones Principales

```typescript
// CRUD de Tickets
ticketService.createTicket(data)           // Crear ticket
ticketService.getMyTickets(userId)         // Mis tickets
ticketService.getAllTickets(filters)       // Todos (admin)
ticketService.updateTicketStatus(id, ...)  // Cambiar status

// Comentarios
ticketService.getTicketComments(ticketId)
ticketService.addComment(ticketId, userId, ...)

// Notificaciones
ticketService.getUnreadNotificationCount(userId)
ticketService.markTicketNotificationsAsRead(userId, ticketId)
ticketService.markAllNotificationsAsRead(userId)
ticketService.subscribeToNotifications(userId, callback)
ticketService.unsubscribeFromNotifications(channel)
```

---

## üé® Componentes UI

### SupportButton
- Ubicaci√≥n: Header principal
- Funcionalidad: Men√∫ desplegable con opciones
- Badge: Contador de notificaciones no le√≠das
- Animaci√≥n: Pulso suave cuando no hay notificaciones

### ReportIssueModal
- Captura de pantalla autom√°tica con `html2canvas`
- Recopilaci√≥n de contexto (versi√≥n, m√≥dulo, prospecto, sesi√≥n)
- Upload de screenshot a Storage
- Validaci√≥n de descripci√≥n obligatoria

### RequestModal
- Formulario din√°mico por categor√≠a
- 6 categor√≠as principales con subcategor√≠as
- Preguntas espec√≠ficas por subcategor√≠a
- Validaci√≥n por pasos

### MyTicketsModal
- Lista de tickets del usuario
- Filtros por estado
- Vista detallada con comentarios
- Agregar comentarios

### AdminTicketsPanel
- Vista completa para administradores
- Filtros por estado, tipo y b√∫squeda
- Cambio de status y prioridad
- Comentarios internos y p√∫blicos
- Historial de cambios

---

## ‚ö†Ô∏è Reglas de Desarrollo

### ‚úÖ CORRECTO

```typescript
// Usar ticketService para operaciones
const { ticket, error } = await ticketService.createTicket(data);

// Usar analysisSupabase para consultas directas
const { data } = await analysisSupabase.from('support_tickets').select('*');

// Marcar notificaciones como le√≠das al abrir ticket
await ticketService.markTicketNotificationsAsRead(userId, ticketId);
```

### ‚ùå INCORRECTO

```typescript
// NO usar clientes admin
const { data } = await supabaseSystemUIAdmin.from('support_tickets').select('*');

// NO hardcodear roles
if (user.role_name === 'admin') { ... }  // Usar is_support_admin() en RLS

// NO guardar screenshots en base64 en la BD
screenshot_base64: base64Data  // Usar screenshot_url con Storage
```

---

## üìä Categor√≠as de Requerimientos

| Categor√≠a | Subcategor√≠as |
|-----------|---------------|
| `reasignacion_prospectos` | Cambiar ejecutivo, Cambiar coordinaci√≥n, Reasignaci√≥n masiva |
| `cambio_roles` | Ascenso, Cambio de √°rea, Nuevo usuario |
| `bloquear_usuario` | Temporal, Permanente, Desbloquear |
| `anadir_funciones` | Chat, Reportes, Notificaciones, Otros |
| `mejorar_funciones` | Performance, UX, Automatizaci√≥n, Integraciones |
| `otro` | (Campo abierto) |

---

## üóÑÔ∏è Migraciones SQL

| Archivo | Descripci√≥n | Estado |
|---------|-------------|--------|
| `20260120_support_tickets_system.sql` | Tablas principales | ‚úÖ Ejecutado |
| `20260120_fix_rls_policies.sql` | Correcci√≥n de pol√≠ticas | ‚úÖ Ejecutado |
| `20260120_storage_policies.sql` | Pol√≠ticas de Storage | ‚úÖ Ejecutado |
| `20260120_realtime_notifications.sql` | Sistema de notificaciones | ‚úÖ Ejecutado |

---

## üìö Referencias

- **Documentaci√≥n del M√≥dulo:** `src/components/support/README_TICKETS.md`
- **Control de Cambios:** `src/components/support/CHANGELOG_TICKETS.md`
- **Servicio:** `src/services/ticketService.ts`
- **Reglas de Seguridad:** `.cursor/rules/security-rules.mdc`
- **Arquitectura BD:** `.cursor/rules/database-architecture.mdc`

---

**√öltima Actualizaci√≥n:** 20 de Enero 2026
