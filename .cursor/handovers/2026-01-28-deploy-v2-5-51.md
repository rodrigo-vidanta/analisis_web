# Handover: Deploy v2.5.51

**REF:** HANDOVER-2026-01-28-DEPLOY-v2.5.51  
**Fecha:** 2026-01-28  
**Commit Principal:** efbedb2  
**Commit Docs:** 2ae802b  
**Versi√≥n:** B10.1.43N2.5.51

---

## üìã Resumen Ejecutivo

Deploy completo del Wizard de Importaci√≥n WhatsApp con validaci√≥n avanzada de variables en plantillas y correcci√≥n de permisos por coordinaci√≥n.

---

## ‚úÖ Tareas Completadas

### 1. Actualizaci√≥n de C√≥digo

#### Archivos Nuevos
- `src/components/chat/ImportWizardModal.tsx` (1564 l√≠neas)
  - Wizard multi-paso (b√∫squeda ‚Üí permisos ‚Üí plantillas ‚Üí variables ‚Üí env√≠o)
  - Validaci√≥n de prospectos existentes
  - Normalizaci√≥n de coordinaciones (COBACA=COB Acapulco, APEX=i360)
  - Validaci√≥n avanzada de permisos por rol y coordinaci√≥n
  - Filtrado de plantillas por tags (GIN index)
  - Validaci√≥n de variables contra datos reales del prospecto
  - Resoluci√≥n completa de variables (sistema + prospecto + tablas relacionadas)
  
- `src/components/campaigns/plantillas/TemplateTagsSelector.tsx` (186 l√≠neas)
  - Selector multi-tag con b√∫squeda
  - Integrado en paso 3 del wizard
  
- `scripts/add_tags_to_whatsapp_templates.sql` (45 l√≠neas)
  - Migraci√≥n para agregar columna `tags TEXT[]`
  - √çndice GIN para b√∫squeda eficiente
  
- `scripts/add_tags_to_whatsapp_templates_with_data.sql` (89 l√≠neas)
  - Data seeding para tags de plantillas existentes

#### Archivos Modificados
- `src/components/chat/LiveChatModule.tsx`
  - Integraci√≥n del nuevo `ImportWizardModal`
  - Eliminados modales antiguos: `QuickImportModal`, `SendTemplateToProspectModal`
  - Simplificado `handleQuickImportSuccess` para navegaci√≥n directa
  
- `src/types/whatsappTemplates.ts`
  - Agregado campo `tags?: string[]` a interface `WhatsAppTemplate`

#### Handovers Documentados
- `.cursor/handovers/2026-01-28-RESUMEN-QUICK-IMPORT-DEPLOY.md`
- `.cursor/handovers/2026-01-28-wizard-importacion-whatsapp.md`
- `.cursor/handovers/2026-01-28-fix-wizard-importacion.md`
- `.cursor/handovers/2026-01-28-fix-validacion-variables-plantillas.md`

### 2. Git Push

**Commit Principal (efbedb2):**
```
v2.5.51: B10.1.43N2.5.51 - Wizard importaci√≥n WhatsApp: 
validaci√≥n de variables en plantillas + fix permisos

15 archivos modificados
3352 inserciones, 81 eliminaciones
```

**Commit Docs (2ae802b):**
```
fix: Actualizar hash commit en DocumentationModule
1 archivo modificado
```

**Push:** origin/main ‚Üí main ‚úÖ

### 3. Deploy AWS

- **Build:** 17.40s (Vite)
- **Upload S3:** ~3s
- **Invalidaci√≥n CloudFront:** ~3s
- **Tiempo Total:** 24s

**URLs:**
- S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
- CloudFront: https://d3m6zgat40u0u1.cloudfront.net

**Bundle Size:**
- `index-DWSRCsSm.js`: 9,275.73 kB (gzip: 2,563.17 kB)
- `index-CmaqG38y.css`: 299.26 kB (gzip: 39.40 kB)

**Warnings:**
- ‚ö†Ô∏è Duplicate member "isLoaded" en `etapasService.ts` (no cr√≠tico)
- ‚ö†Ô∏è Const reassignment en `ProspectosManager.tsx` (no cr√≠tico)
- ‚ÑπÔ∏è Dynamic imports de supabaseSystemUI (esperado)

### 4. Base de Datos

**Tabla:** `system_config`  
**Config Key:** `app_version`  
**Versi√≥n Anterior:** `B10.1.43N2.5.50`  
**Versi√≥n Nueva:** `B10.1.43N2.5.51`  
**Config Value:**
```json
{
  "version": "B10.1.43N2.5.51",
  "force_update": true
}
```

**Updated At:** 2026-01-28T22:51:25.047354+00:00 ‚úÖ

---

## üìä Cambios Principales

### üéØ Wizard de Importaci√≥n WhatsApp (4 Pasos)

**PASO 1: B√∫squeda de Prospecto**
- B√∫squeda local en BD con fallback a `telefono_principal`
- B√∫squeda en Dynamics CRM si no existe localmente
- Normalizaci√≥n de tel√©fonos (sin caracteres especiales)
- Detecci√≥n de prospecto existente con datos completos:
  - Nombre, ejecutivo asignado, coordinaci√≥n
  - Estado de conversaci√≥n WhatsApp
  - Bot√≥n para navegar a conversaci√≥n existente
- **BLOQUEO:** Si existe localmente, NO permite continuar

**PASO 2: Validaci√≥n de Permisos**
- Normalizaci√≥n de coordinaciones con equivalencias:
  - `"COB ACAPULCO"` ‚Üî `"COBACA"`
  - `"APEX"` ‚Üî `"i360"`
- L√≥gica de permisos:
  - **Admin/Admin Operativo/Coordinador Calidad:** Pueden importar de cualquier coordinaci√≥n
  - **Coordinador:** Solo de su coordinaci√≥n
  - **Ejecutivo:** Solo de su coordinaci√≥n (aunque sea de otro ejecutivo)
- Muestra propietario en Dynamics (NO asignaci√≥n, es autom√°tica por backend)
- Validaci√≥n antes de permitir avanzar

**PASO 3: Selecci√≥n de Plantilla**
- Filtrado por tags (TEXT[] con √≠ndice GIN)
- B√∫squeda por nombre/descripci√≥n
- **Validaci√≥n CR√çTICA de variables:**
  - Carga datos completos del prospecto reci√©n importado
  - Para cada plantilla, verifica que el prospecto tenga todos los campos requeridos
  - Si falta un campo (ej: `titulo`), la plantilla se muestra como **bloqueada**
  - UI clara con:
    - Borde rojo + fondo rojo claro
    - Mensaje: "‚ö†Ô∏è No se puede enviar"
    - Raz√≥n espec√≠fica: "Faltan datos del prospecto: T√≠tulo"
    - Lista de campos faltantes
- Banner informativo: "Solo se muestran plantillas que el prospecto puede recibir..."

**PASO 4: Configuraci√≥n de Variables**
- Variables editables del sistema:
  - `fecha_personalizada`: DatePicker
  - `hora_personalizada`: Input time
- Variables auto-completadas (preview):
  - Sistema: Ejecutivo, coordinaci√≥n
  - Prospecto: Nombre, apellidos, etc.
  - Otras tablas: Destinos, resorts (lookup)
- Preview en tiempo real con valores reales

**ENV√çO:**
- Resoluci√≥n completa de TODAS las variables:
  ```typescript
  for (const mapping of selectedTemplate.variable_mappings) {
    if (mapping.table_name === 'system') {
      value = variableValues[mapping.variable_number] || defaultSystemValue;
    } else if (mapping.table_name === 'prospectos') {
      value = prospectoData[mapping.field_name];
    } else {
      value = await getTableExampleData(mapping.table_name, mapping.field_name);
    }
    resolvedVariables[mapping.variable_number] = value;
  }
  ```
- Texto final con variables interpoladas
- Env√≠o v√≠a `whatsapp-templates-send-proxy`
- Navegaci√≥n autom√°tica a conversaci√≥n creada

### üêõ Fixes Cr√≠ticos

1. **B√∫squeda Local Robusta:**
   - Eliminados JOINs directos que causaban errores 400
   - Queries separadas para `coordinaciones` y `auth_users`
   - Fallback a `telefono_principal` si `whatsapp` falla

2. **Mensaje de Asignaci√≥n Corregido:**
   - Antes: "Se asignar√° a [Usuario X]" ‚ùå
   - Ahora: "Propietario en Dynamics: [Owner]" ‚úÖ
   - Nota expl√≠cita: "Se asignar√° autom√°ticamente al propietario en Dynamics CRM"

3. **Validaci√≥n Real de Variables:**
   - Antes: Todas las plantillas disponibles (enviaba `[T√≠tulo]` si faltaba)
   - Ahora: Solo muestra plantillas con datos completos del prospecto
   - Validaci√≥n contra `importedProspectData` (cargado con `SELECT *`)

4. **Display de Prospecto Existente:**
   - Ahora muestra: Nombre, Ejecutivo, Coordinaci√≥n, Estado conversaci√≥n
   - Bot√≥n para navegar a conversaci√≥n si existe
   - Mensaje claro: "No se puede importar: Este prospecto ya est√° registrado"

### üîß Mejoras T√©cnicas

- `importedProspectData` state para almacenar datos completos tras importar
- Funci√≥n `canSendTemplate()` retorna `{ canSend, reason, missingFields }`
- Validaci√≥n exhaustiva campo por campo de `variable_mappings`
- UI adaptativa: plantillas bloqueadas con estilo visual distintivo
- Logs de debug: `resolvedVariables` y `resolvedText` antes de enviar

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

### Inmediatos (Usuario)
1. ‚è±Ô∏è Esperar 5-10 min para propagaci√≥n CloudFront
2. üîÑ Limpiar cache del navegador (Cmd+Shift+R o Ctrl+F5)
3. ‚úÖ Verificar versi√≥n en footer: `B10.1.43N2.5.51`
4. üß™ Probar wizard completo:
   - Buscar prospecto existente ‚Üí Debe bloquear
   - Buscar prospecto nuevo ‚Üí Debe permitir importar
   - Verificar permisos por coordinaci√≥n
   - Verificar plantillas bloqueadas si faltan datos
   - Enviar plantilla y verificar variables resueltas

### Pendientes (Desarrollo)

#### 1. Validaci√≥n de Tablas Relacionadas
Actualmente solo valida campos de `prospectos`. Pendiente:
- `destinos.nombre` (si prospecto tiene `destino_preferencia`)
- `resorts.nombre` (si prospecto tiene `resort_id`)
- `llamadas_ventas.*` (si prospecto tiene llamadas)

```typescript
// Propuesta:
if (mapping.table_name === 'destinos') {
  const destino_id = prospectoData.destino_preferencia;
  if (!destino_id) missingFields.push(mapping.display_name);
}
```

#### 2. Auto-Completar Datos Faltantes
Si falta un campo cr√≠tico (ej: `titulo`), ofrecer input para completarlo:

```typescript
<div>
  <p>Esta plantilla requiere "T√≠tulo" pero el prospecto no lo tiene.</p>
  <select onChange={handleTituloChange}>
    <option value="Sr.">Sr.</option>
    <option value="Sra.">Sra.</option>
    <option value="Lic.">Lic.</option>
  </select>
  <button onClick={updateProspectoAndContinue}>Actualizar y Continuar</button>
</div>
```

#### 3. Cach√© de Plantillas
Actualmente carga todas las plantillas cada vez. Considerar:
- Cache en Zustand store
- Invalidaci√≥n al editar plantilla
- Reducir tiempo de carga en paso 3

#### 4. Analytics del Wizard
Agregar tracking de:
- % de usuarios que llegan a cada paso
- % de plantillas bloqueadas por falta de datos
- Campos m√°s faltantes (para priorizar data enrichment)

---

## üìö Referencias

### Documentaci√≥n Creada
- [Wizard Importaci√≥n WhatsApp](../.cursor/handovers/2026-01-28-wizard-importacion-whatsapp.md)
- [Fix Wizard Importaci√≥n](../.cursor/handovers/2026-01-28-fix-wizard-importacion.md)
- [Fix Validaci√≥n Variables](../.cursor/handovers/2026-01-28-fix-validacion-variables-plantillas.md)
- [Resumen Quick Import](../.cursor/handovers/2026-01-28-RESUMEN-QUICK-IMPORT-DEPLOY.md)

### Componentes Relacionados
- `src/services/whatsappTemplatesService.ts` - L√≥gica de plantillas
- `src/services/importContactService.ts` - Importaci√≥n de contactos
- `src/services/dynamicsLeadService.ts` - B√∫squeda en Dynamics
- `src/types/whatsappTemplates.ts` - Interfaces TypeScript

### Reglas y Patrones
- `.cursor/rules/deploy-workflow.mdc` - Workflow de deploy
- `.cursor/rules/security-rules.mdc` - Seguridad
- `.cursor/rules/mcp-rules.mdc` - Uso de MCPs

---

## üéØ M√©tricas del Deploy

| M√©trica | Valor |
|---------|-------|
| ‚è±Ô∏è Pre-checks | ~5s |
| üî® Build Vite | 17.40s |
| ‚¨ÜÔ∏è Upload S3 | ~3s |
| üîÑ CloudFront | ~3s |
| üíæ BD Update | 2s (MCP) |
| üìù Handover | <1s |
| **‚è±Ô∏è Total** | **~30s** |

| Archivo | Tama√±o | Gzip |
|---------|--------|------|
| JS Bundle Principal | 9,275.73 kB | 2,563.17 kB |
| CSS Bundle | 299.26 kB | 39.40 kB |
| AWS Architecture | 157.18 kB | 48.54 kB |
| Supabase Client | 165.95 kB | 44.13 kB |

---

## üîê Checks de Seguridad

‚úÖ No se exponen API keys en bundle  
‚úÖ `system_config` actualizado v√≠a MCP seguro  
‚úÖ Handover no contiene secretos  
‚úÖ Permisos de archivos correctos  
‚úÖ Git push con verificaci√≥n  

---

## üéì Lecciones Aprendidas

1. **Validaci√≥n Temprana:** La validaci√≥n de variables en el paso 3 (selecci√≥n de plantilla) es mucho mejor UX que validar al intentar enviar.

2. **Datos Completos Previos:** Cargar `importedProspectData` inmediatamente despu√©s de importar permite validaciones precisas sin queries adicionales.

3. **UI Clara para Errores:** Plantillas bloqueadas con borde rojo + raz√≥n espec√≠fica + lista de campos faltantes es mucho m√°s claro que un mensaje gen√©rico.

4. **Normalizaci√≥n de Coordinaciones:** Las equivalencias (COBACA, i360) deben estar centralizadas en una funci√≥n reutilizable.

5. **Separaci√≥n de Queries:** Evitar JOINs complejos en Supabase que pueden dar 400 errors. Mejor queries separadas y componer en frontend.

---

**Deploy Status:** ‚úÖ 100% COMPLETADO  
**Tiempo Total:** ~30 segundos  
**Next Deploy:** Incremento autom√°tico ‚Üí B10.1.43N2.5.52
