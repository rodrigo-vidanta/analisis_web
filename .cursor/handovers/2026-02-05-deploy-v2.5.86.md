# Handover: Deploy v2.5.86

**REF:** HANDOVER-2026-02-05-DEPLOY-v2.5.86  
**Fecha:** 2026-02-05  
**Versi√≥n:** B10.1.44N2.5.86

---

## üìã Resumen Ejecutivo

Deploy que consolida 3 sesiones de correcciones cr√≠ticas:
1. **Auth/Sesiones**: Fix p√©rdida silenciosa de sesi√≥n por race condition de doble cliente Supabase
2. **WhatsApp Module**: Fix keys duplicadas React, ERR_INSUFFICIENT_RESOURCES, CORS en Edge Function
3. **Notas de Voz**: Remuxer WebM‚ÜíOGG para que audios lleguen como PTT en WhatsApp

---

## ‚úÖ Sesi√≥n 1: Fix Autenticaci√≥n y Sesiones

**Ref:** HANDOVER-2026-02-05-FIX-AUTH-TOKEN-SESSION-MANAGEMENT

### Problemas Resueltos
- **Race condition doble cliente Supabase**: `supabaseSystemUI` y `analysisSupabase` eran instancias separadas que compet√≠an por refresh tokens ‚Üí 51.7% tokens revocados
- **Stale closures en AuthContext**: `handleForceLogout` capturaba estado del render inicial
- **Monitor de token inestable**: `logout` no memoizado ‚Üí `setInterval` reiniciado cada render
- **Sesiones zombie server-side**: `sessions_timebox: 0` ‚Üí sesiones nunca expiraban
- **Queries sin detecci√≥n de auth expirado**: ~37 archivos sin retry de 401
- **beforeunload async no funcional**: `is_operativo` no se limpiaba al cerrar pesta√±a

### Archivos Modificados
| Archivo | Cambio |
|---------|--------|
| `src/config/analysisSupabase.ts` | Re-exporta `supabaseSystemUI` (cliente √∫nico) |
| `src/config/supabaseSystemUI.ts` | Auth-aware fetch wrapper con retry 401 |
| `src/contexts/AuthContext.tsx` | `authStateRef` + `useCallback` anti-stale |
| `src/hooks/useTokenExpiryMonitor.ts` | Refs estables, interval no se reinicia |
| `src/hooks/useHeartbeat.ts` | `fetch(keepalive:true)` en beforeunload |
| `src/hooks/useInactivityTimeout.ts` | `.rpc()` en vez de Edge Function directa |
| `src/utils/syncSupabaseSessions.ts` | Deprecado como no-ops |

### Config Server-Side (Supabase Management API)
| Par√°metro | Antes | Despu√©s |
|-----------|-------|---------|
| `sessions_timebox` | `0` | `86400` (24h) |
| `refresh_token_reuse_interval` | `10s` | `30s` |

---

## ‚úÖ Sesi√≥n 2: Fix WhatsApp Module

**Ref:** HANDOVER-2026-02-05-WHATSAPP-FIXES

### Problemas Resueltos
- **Keys duplicadas React**: Coordinadores duplicados en AssignmentContextMenu, conversaciones y mensajes sin dedup en LiveChatCanvas
- **ERR_INSUFFICIENT_RESOURCES**: Cascada de errores entre fetch fallidos y `errorLogService` ‚Üí loop infinito de conexiones
- **CORS en dynamics-reasignar-proxy**: `verify_jwt:true` bloqueaba OPTIONS preflight

### Archivos Modificados
| Archivo | Cambio |
|---------|--------|
| `src/components/shared/AssignmentContextMenu.tsx` | Dedup ejecutivos+coordinadores con Set+Map |
| `src/components/chat/LiveChatCanvas.tsx` | Dedup conversaciones/mensajes, error counter |
| `src/services/liveMonitorOptimizedService.ts` | Backoff exponencial + concurrency guard |
| `src/services/errorLogService.ts` | Backoff + anti-cascade (skip ERR_INSUFFICIENT_RESOURCES) |
| `supabase/functions/dynamics-reasignar-proxy/index.ts` | Migrado a Deno.serve() + JWT manual + verify_jwt:false |

---

## ‚úÖ Sesi√≥n 3: Notas de Voz WhatsApp (WebM‚ÜíOGG)

**Ref:** HANDOVER-2026-02-05-WEBM-OGG-REMUXER

### Problema Resuelto
Los audios grabados llegaban como archivos de audio en WhatsApp, no como notas de voz (PTT). WhatsApp requiere OGG/Opus pero Chrome solo graba WebM/Opus.

### Soluci√≥n
Remuxer puro WebM‚ÜíOGG (cambio de contenedor sin re-encoding):
- Parser EBML minimal extrae paquetes Opus crudos del WebM
- Writer OGG los empaqueta con OpusHead, OpusTags y CRC-32 v√°lidos
- Zero dependencias externas, ~300 l√≠neas

### Archivos Modificados
| Archivo | Cambio |
|---------|--------|
| `src/utils/webmToOgg.ts` | **NUEVO** - Remuxer WebM‚ÜíOGG |
| `src/components/chat/LiveChatCanvas.tsx` | Integra remuxer, elimina `convertAudioToMp3` |

### Archivos Obsoletos (no eliminados)
- `src/utils/lameMp3Encoder.ts` ‚Äî Ya no se usa (conversi√≥n MP3 eliminada)
- `src/workers/audioConverter.worker.ts` ‚Äî Worker MP3 obsoleto

---

## üìä Resumen Total de Archivos Modificados

| Archivo | Sesi√≥n | Tipo |
|---------|--------|------|
| `src/config/analysisSupabase.ts` | 1 | Modificado |
| `src/config/supabaseSystemUI.ts` | 1 | Modificado |
| `src/contexts/AuthContext.tsx` | 1 | Modificado |
| `src/hooks/useTokenExpiryMonitor.ts` | 1 | Modificado |
| `src/hooks/useHeartbeat.ts` | 1 | Modificado |
| `src/hooks/useInactivityTimeout.ts` | 1 | Modificado |
| `src/utils/syncSupabaseSessions.ts` | 1 | Modificado |
| `src/components/shared/AssignmentContextMenu.tsx` | 2 | Modificado |
| `src/services/liveMonitorOptimizedService.ts` | 2 | Modificado |
| `src/services/errorLogService.ts` | 2 | Modificado |
| `supabase/functions/dynamics-reasignar-proxy/index.ts` | 2 | Modificado |
| `src/components/chat/LiveChatCanvas.tsx` | 2,3 | Modificado |
| `src/utils/webmToOgg.ts` | 3 | **Nuevo** |
| `src/utils/lameMp3Encoder.ts` | prev | Nuevo (obsoleto) |
| `src/workers/audioConverter.worker.ts` | prev | Modificado |
| `supabase/functions/send-audio-proxy/index.ts` | prev | Modificado |

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

1. Esperar 5-10 min (propagaci√≥n CloudFront)
2. Limpiar cache navegador (Cmd+Shift+R)
3. Verificar versi√≥n en footer: `B10.1.44N2.5.86`
4. Probar login/logout (sesi√≥n √∫nica, sin race conditions)
5. Probar grabaci√≥n y env√≠o de audio (debe llegar como nota de voz PTT)
6. Verificar que reasignaci√≥n de ejecutivos funciona sin CORS
7. Monitorear consola: no debe haber ERR_INSUFFICIENT_RESOURCES

---

## üìö Referencias

- [Handover Auth](2026-02-05-fix-auth-token-session-management.md)
- [Handover WhatsApp](2026-02-05-fix-whatsapp-duplicate-keys-cors-resources.md)
- [Handover WebM‚ÜíOGG](2026-02-05-webm-to-ogg-remuxer.md)

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Autor:** Claude Agent  
**Revisado:** 2026-02-05
