# Handover: Deploy v2.5.89

**REF:** HANDOVER-2026-02-06-DEPLOY-v2.5.89  
**Fecha:** 2026-02-06  
**Commit:** e466c74  
**Versión:** B10.1.44N2.5.89

---

## Resumen Ejecutivo

Deploy con 2 bugfixes críticos del módulo WhatsApp:
1. Fix tabla `uchat_messages` inexistente que bloqueaba sincronización de mensajes
2. Fix thundering herd (2146+ requests simultáneos) en `BackupService`

---

## Tareas Completadas

### 1. Fix uchat_messages table not exists (42P01)

**Problema:** La tabla `uchat_messages` nunca fue creada en producción. 3 funciones de sincronización en `LiveChatCanvas.tsx` intentaban leer/escribir en ella, fallaban con error 42P01 y hacían `return` temprano, bloqueando la actualización del estado de mensajes en la UI.

**Archivos modificados:**
- `src/components/chat/LiveChatCanvas.tsx` — Eliminadas 3 dependencias de `uchat_messages`:
  - `syncMessagesForConversationWithUnread`: INSERT → deduplicación en memoria
  - `syncMessagesForConversation`: INSERT → estado en memoria
  - `syncMessagesForOpenConversation`: SELECT + UPSERT → `messagesByConversation` state
- `src/components/dashboard/widgets/ConversacionesWidget.tsx` — Eliminado fallback a `uchat_messages`

**Verificación contra BD:**
- `uchat_messages`: NO EXISTE (confirmado via MCP)
- `mensajes_whatsapp`: 42,676 filas (fuente real)
- `user_profiles_v2`: 145 perfiles (post auth nativo)

**Handover detallado:** `.cursor/handovers/2026-02-06-fix-uchat-messages-table-not-exists.md`

### 2. Fix Thundering Herd - ERR_INSUFFICIENT_RESOURCES

**Problema:** Al buscar en el módulo WhatsApp, 2146+ componentes `BackupBadgeWrapper` disparaban la misma query HTTP simultáneamente antes de que el caché se poblara, agotando los recursos de red del navegador.

**Archivos modificados:**
- `src/services/backupService.ts`:
  - Nuevo mecanismo `dedupe()` con Map de promises in-flight
  - Fix columna inexistente `original_phone` → `telefono_original`
  - Eliminado código muerto de fallbacks legacy

**Resultado:** De 2146+ requests → 1 request real.

**Handover detallado:** `.cursor/handovers/2026-02-06-fix-thundering-herd-backup-whatsapp.md`

### 3. Git Push
- Commit: `e466c74`
- Push a: origin/main
- 8 archivos modificados, 415 inserciones, 125 eliminaciones

### 4. Deploy AWS
- Build: 24.18s
- Upload + invalidación: 28s total
- URLs:
  - S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
  - CloudFront: https://d3m6zgat40u0u1.cloudfront.net

### 5. Base de Datos
- Tabla: `system_config`
- Config Key: `app_version`
- Versión anterior: `B10.1.44N2.5.88`
- Versión nueva: `B10.1.44N2.5.89`
- `force_update: true`

---

## Cambios Principales

- Fix error 42P01 (`uchat_messages` no existe) que impedía envío de mensajes en WhatsApp
- Fix saturación de red (ERR_INSUFFICIENT_RESOURCES) al buscar conversaciones
- Deduplicación de promises in-flight en BackupService (patrón thundering herd)
- Corrección de columna `original_phone` → `telefono_original` en user_profiles_v2
- Limpieza de código legacy de fallbacks en backupService

---

## Próximos Pasos

1. Esperar 5-10 min (propagación CloudFront)
2. Limpiar cache navegador (Cmd+Shift+R)
3. Verificar versión `B10.1.44N2.5.89` en footer
4. Probar envío de mensajes en módulo WhatsApp
5. Verificar que no aparezcan errores `ERR_INSUFFICIENT_RESOURCES` al buscar

---

## Referencias

- [Fix uchat_messages](.cursor/handovers/2026-02-06-fix-uchat-messages-table-not-exists.md)
- [Fix thundering herd](.cursor/handovers/2026-02-06-fix-thundering-herd-backup-whatsapp.md)
- [Deploy anterior v2.5.88](.cursor/handovers/2026-02-06-deploy-v2-5-88.md)

---

**Deploy Status:** ✅ COMPLETADO  
**Riesgo:** Bajo — Solo elimina dependencias de tabla inexistente y agrega deduplicación
