# Handover: Deploy v2.5.75

**REF:** HANDOVER-2026-02-02-DEPLOY-v2.5.75  
**Fecha:** 2026-02-02  
**Commit:** 43046fa  
**Versi√≥n:** B10.1.44N2.5.75

---

## üìã Resumen Ejecutivo

Deploy de fix cr√≠tico para sistema de tickets de soporte. Corregidas funciones SQL `is_support_admin()` y `get_support_admin_ids()` que causaban error 404 al enviar comentarios en tickets por referencia a tabla `auth_users` (eliminada en migraci√≥n de BD unificada).

---

## ‚úÖ Tareas Completadas

### 1. Actualizaci√≥n de C√≥digo

**Scripts SQL:**
- `scripts/sql/FIX_TRIGGER_AUTH_USERS.sql` - Script inicial (no funcion√≥ por sobrecarga)
- `scripts/sql/FIX_TRIGGER_AUTH_USERS_V2_FORCE.sql` - Script final con DROP CASCADE

**Archivos de diagn√≥stico:**
- `scripts/sql/check_policies_full.sql`
- `scripts/sql/find_support_triggers.sql`
- `scripts/sql/test_samuel_admin_comment.sql`
- `scripts/sql/debug_support_ticket_comments.sql`
- `scripts/sql/fix_support_ticket_comments_rls.sql`
- `scripts/sql/fix_support_tickets_rls_FINAL.sql`
- `scripts/sql/FORCE_FIX_support_tickets_FINAL.sql`
- `scripts/sql/cleanup_support_tickets_policies.sql`
- `scripts/sql/fix_support_tickets_grants.sql`
- `scripts/sql/verificacion_completa_support_comments.sql`

**Documentaci√≥n:**
- `FIX_TRIGGER_AUTH_USERS_README.md` - Explicaci√≥n del fix
- `EJECUTAR_FIX_TRIGGERS.md` - Instrucciones ejecutivas
- `EJECUTAR_FIX_V2_FORCE.md` - Instrucciones versi√≥n 2
- `EJECUTAR_AHORA_FIX_RLS.md` - Instrucciones RLS (tentativas previas)
- `FIX_SUPPORT_COMMENTS_READY.md` - Fix RLS inicial
- `DIAGNOSTICO_404_SUPPORT_COMMENTS.md` - Diagn√≥stico
- `ACCION_REQUERIDA_FIX_COMMENTS.md` - Resumen ejecutivo

**Handovers:**
- `.cursor/handovers/2026-02-02-fix-404-support-comments.md` - Handover inicial (RLS)
- `.cursor/handovers/2026-02-02-fix-triggers-auth-users.md` - Handover final (Triggers)
- `.cursor/handovers/2026-02-02-filtro-reasignacion-is-active.md` - Handover previo (sin conflicto)

**Utilidades:**
- `src/utils/syncSupabaseSessions.ts` - Sincronizaci√≥n de sesiones (no requerida, ambos clientes apuntan al mismo proyecto)

**Actualizados:**
- `src/components/support/README_TICKETS.md` - Documentaci√≥n actualizada
- `public/docs/README_TICKETS.md` - Documentaci√≥n p√∫blica actualizada
- `CHANGELOG.md` - Nueva entrada v2.5.76

**Total:** 35 archivos modificados, 3920 inserciones, 49 eliminaciones

### 2. Git Push

**Commits:**
1. `43046fa` - v2.5.75: B10.1.44N2.5.75 - FIX CR√çTICO: Triggers soporte tickets con auth_users ‚Üí user_profiles_v2
2. `ebfa741` - fix: Actualizar hash commit en DocumentationModule

**Push a:** origin/main

### 3. Deploy AWS

**Build:** 18.50s  
**Upload + Invalidaci√≥n:** 9.5s  
**Total:** 28s

**URLs:**
- S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
- CloudFront: https://d3m6zgat40u0u1.cloudfront.net

### 4. Base de Datos

**Tabla:** `system_config`  
**Config Key:** `app_version`  
**Versi√≥n actualizada:** `B10.1.44N2.5.75`  
**Config Value:**
```json
{
  "version": "B10.1.44N2.5.75",
  "force_update": true
}
```
**Timestamp:** 2026-02-02T18:48:32.318439+00:00

---

## üìä Cambios Principales

### Problema Resuelto

**Error 404 al enviar comentarios en tickets de soporte**

**Causa Ra√≠z:**
- Trigger `notify_new_comment()` ejecutaba funci√≥n `is_support_admin(uuid)`
- Funci√≥n buscaba en tabla `auth_users` (eliminada en migraci√≥n de BD unificada Enero 2025)
- PostgreSQL retornaba: `ERROR: 42P01: relation "auth_users" does not exist`
- Frontend recib√≠a 404 (Not Found)

**Soluci√≥n Aplicada:**

**ANTES (ROTO):**
```sql
CREATE OR REPLACE FUNCTION is_support_admin(user_id_param UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM auth_users  -- ‚ùå Tabla eliminada
    WHERE id = user_id_param
    AND role_id IN (...)      -- ‚ùå Campo no existe
  );
END;
$$;
```

**DESPU√âS (CORRECTO):**
```sql
DROP FUNCTION IF EXISTS is_support_admin(uuid) CASCADE;
DROP FUNCTION IF EXISTS is_support_admin() CASCADE;

CREATE OR REPLACE FUNCTION is_support_admin(user_id_param UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM user_profiles_v2  -- ‚úÖ Vista correcta
    WHERE id = user_id_param
    AND role_name IN ('admin', 'administrador_operativo', 'developer')  -- ‚úÖ Usa role_name
    AND is_active = true
  );
END;
$$;
```

**Funciones corregidas:**
1. `is_support_admin(UUID)` - Verificaci√≥n de admin individual
2. `get_support_admin_ids()` - Obtenci√≥n de lista de admins

**Cambio clave:** `auth_users.role_id (UUID)` ‚Üí `user_profiles_v2.role_name (string)`

### Intentos Previos (Correctos pero Insuficientes)

Durante el diagn√≥stico, se aplicaron correctamente:
1. ‚úÖ Pol√≠ticas RLS actualizadas (usaban `user_profiles_v2`)
2. ‚úÖ Grants a rol `authenticated`
3. ‚úÖ Limpieza de pol√≠ticas redundantes
4. ‚úÖ Consolidaci√≥n de pol√≠ticas con nombres consistentes

**Estos cambios eran correctos**, pero el problema persist√≠a porque el trigger SQL segu√≠a roto.

---

## üß™ Validaci√≥n Realizada

### Tests SQL

1. **Verificaci√≥n de funci√≥n:**
```sql
SELECT 
  proname, 
  pg_get_function_identity_arguments(oid) as arguments,
  pg_get_functiondef(oid) LIKE '%auth_users%' as usa_auth_users_roto
FROM pg_proc 
WHERE proname = 'is_support_admin';
```
**Resultado:** `usa_auth_users_roto = FALSE` ‚úÖ

2. **Test con usuario admin:**
```sql
SELECT is_support_admin('e8ced62c-3fd0-4328-b61a-a59ebea2e877'::uuid);
```
**Resultado:** `TRUE` ‚úÖ (Samuel Rosales - admin)

3. **Test INSERT manual:**
```sql
SET LOCAL request.jwt.claims TO '{"sub": "e8ced62c-...", "role": "authenticated"}';
INSERT INTO support_ticket_comments (...) VALUES (...) RETURNING *;
```
**Resultado:** INSERT exitoso ‚úÖ

### Pendiente Validaci√≥n Frontend

- [ ] Ir a ticket TKT-20260131-0065
- [ ] Escribir comentario
- [ ] Enviar
- [ ] Verificar: Sin error 404 en console

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

### Inmediatos (Usuario)

1. **Esperar propagaci√≥n CloudFront** (5-10 minutos)
2. **Limpiar cache navegador** (Cmd+Shift+R o Ctrl+Shift+R)
3. **Verificar versi√≥n en footer:** Debe mostrar `v2.5.75`
4. **Probar comentario en ticket:** TKT-20260131-0065

### Validaci√≥n Completa

1. Enviar comentario en ticket de soporte
2. Verificar que no aparece error 404
3. Verificar que notificaci√≥n se crea en `support_ticket_notifications`
4. Verificar que trigger se ejecuta sin errores

### Auditor√≠a Opcional (Futuro)

**Buscar otras funciones que puedan tener el mismo problema:**
```sql
SELECT 
  p.proname as function_name,
  pg_get_functiondef(p.oid) as definition
FROM pg_proc p
JOIN pg_namespace n ON p.pronamespace = n.oid
WHERE n.nspname = 'public'
  AND pg_get_functiondef(p.oid) LIKE '%auth_users%';
```

Si retorna resultados, crear script adicional para corregirlas.

---

## üìö Referencias

### Scripts Ejecutados en BD

- ‚úÖ `scripts/sql/FIX_TRIGGER_AUTH_USERS_V2_FORCE.sql` (ejecutado 2026-02-02)

### Documentaci√≥n T√©cnica

- **Handover previo:** `.cursor/handovers/2026-02-02-fix-404-support-comments.md`
- **Handover triggers:** `.cursor/handovers/2026-02-02-fix-triggers-auth-users.md`
- **Arquitectura BD:** `.cursor/rules/arquitectura-bd-unificada.mdc`
- **Reglas seguridad:** `.cursor/rules/security-rules.mdc`
- **Sistema tickets:** `src/components/support/README_TICKETS.md`

### Contexto Hist√≥rico

- **Migraci√≥n BD Unificada:** Enero 2025 (System_UI ‚Üí PQNC_AI)
- **Tabla `auth_users`:** Eliminada, reemplazada por `user_profiles_v2`
- **Funciones SQL no actualizadas:** Detectado 2026-02-02

---

## üéØ Lecciones Aprendidas

1. **Triggers silenciosos:** Los errores en triggers pueden manifestarse como 404 en frontend
2. **Migraciones completas:** Al eliminar tablas, revisar TODAS las funciones SQL que las referencian
3. **Diagn√≥stico en capas:** Revisar RLS ‚Üí Grants ‚Üí Pol√≠ticas ‚Üí **Triggers/Funciones**
4. **Sobrecarga de funciones:** PostgreSQL permite funciones con mismo nombre pero diferentes firmas (requiere DROP expl√≠cito)
5. **Testing SQL directo:** Usar `SET LOCAL request.jwt.claims` para simular autenticaci√≥n en SQL Editor

---

## üìä M√©tricas del Deploy

| M√©trica | Valor |
|---------|-------|
| Tiempo total | 32 segundos |
| Archivos modificados | 35 |
| L√≠neas agregadas | 3920 |
| L√≠neas eliminadas | 49 |
| Build time | 18.5s |
| Deploy AWS | 28s |
| Commits | 2 |
| Handovers creados | 3 |

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Requiere validaci√≥n:** Frontend (comentarios en tickets)  
**Impacto:** CR√çTICO - Sistema de tickets no funcional antes del fix
