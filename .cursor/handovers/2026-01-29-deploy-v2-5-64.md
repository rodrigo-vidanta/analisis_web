# Handover: Deploy v2.5.64

**REF:** HANDOVER-2026-01-29-DEPLOY-v2.5.64  
**Fecha:** 2026-01-29  
**Commit Principal:** 453d5c5  
**Commit Handover:** 130591a  
**Versi√≥n:** B10.1.43N2.5.64

---

## üìã Resumen Ejecutivo

Deploy con m√∫ltiples hotfixes cr√≠ticos:
1. **Fix 401 Error** en pausa de bot WhatsApp (falta de persistencia de sesi√≥n)
2. **Detecci√≥n de prospectos duplicados** mejorada (b√∫squeda por √∫ltimos 10 d√≠gitos)
3. **Limpieza masiva de logs** (silenciar DynamicsLead, Realtime, Dashboard)
4. **Mejoras de UI** en wizard de importaci√≥n WhatsApp

---

## ‚úÖ Tareas Completadas

### 1. Hotfix: Error 401 en Pausa de Bot

**Problema:**
- Usuario autenticado experimentaba error `401 (Unauthorized)` al intentar pausar/reanudar bot
- La sesi√≥n ten√≠a segundos de haber sido cargada
- El webhook secret estaba correcto

**Causa Ra√≠z:**
- El cliente `supabaseSystemUI` NO ten√≠a configurada la persistencia de sesi√≥n
- Supabase no guardaba el JWT autom√°ticamente en `localStorage`
- Cada request usaba solo `anon_key` sin el token de usuario

**Soluci√≥n Implementada:**

```typescript
// src/config/supabaseSystemUI.ts
export const supabaseSystemUI = createClient(url, anonKey, {
  auth: {
    autoRefreshToken: true,      // ‚Üê AGREGADO
    persistSession: true,          // ‚Üê AGREGADO
    detectSessionInUrl: true       // ‚Üê AGREGADO
  }
});
```

**Tambi√©n aplicado a:**
- `src/config/analysisSupabase.ts` (consistencia)

**Archivos Modificados:**
- `src/config/supabaseSystemUI.ts`
- `src/config/analysisSupabase.ts`

**Testing:**
- ‚úÖ Login funcional con persistencia
- ‚úÖ Pausa/reanudaci√≥n de bot: Sin errores 401
- ‚úÖ JWT preservado en sesi√≥n

---

### 2. Hotfix: Detecci√≥n de Prospectos Duplicados

**Problema:**
- Usuario ingresaba n√∫mero `3333243333` (10 d√≠gitos)
- Prospecto exist√≠a en BD como `5213333243333` (13 d√≠gitos con c√≥digo pa√≠s)
- Sistema NO detectaba el duplicado
- Permit√≠a importar creando duplicados

**Causa Ra√≠z:**
- B√∫squeda usaba `.eq('whatsapp', '3333243333')` (igualdad exacta)
- Campo en BD: `5213333243333` ‚â† `3333243333`
- No hab√≠a match

**Soluci√≥n Implementada:**

**Estrategia de 2 pasos:**
1. B√∫squeda con LIKE (amplio): `.or('whatsapp.like.%3333243333,telefono_principal.like.%3333243333')`
2. Validaci√≥n estricta en JavaScript:
   ```typescript
   const exactMatch = candidates.find(c => {
     const whatsappNorm = c.whatsapp?.replace(/\D/g, '').slice(-10);
     const telefonoNorm = c.telefono_principal?.replace(/\D/g, '').slice(-10);
     return whatsappNorm === normalizedPhone || telefonoNorm === normalizedPhone;
   });
   ```

**Formatos Soportados:**
- ‚úÖ `3333243333` (10 d√≠gitos)
- ‚úÖ `523333243333` (12 d√≠gitos con c√≥digo MX)
- ‚úÖ `5213333243333` (13 d√≠gitos con c√≥digo pa√≠s completo)
- ‚úÖ `+523333243333` (con s√≠mbolo +)
- ‚úÖ `+52 (333) 324-3333` (con formato)

**Cambio de Vista Segura:**
```typescript
// ANTES (tabla con password_hash)
.from('auth_users')
.select('full_name')

// AHORA (vista consolidada segura)
.from('user_profiles_v2')
.select('full_name')
```

**Archivos Modificados:**
- `src/components/chat/ImportWizardModal.tsx` (funci√≥n `searchLocalProspect`)

**Testing Realizado:**
- ‚úÖ B√∫squeda con `3333243333` ‚Üí Encuentra `5213333243333`
- ‚úÖ Match exacto de √∫ltimos 10 d√≠gitos
- ‚úÖ Previene duplicados
- ‚úÖ Bot√≥n "Continuar" deshabilitado correctamente

---

### 3. Limpieza Masiva de Logs

**Problema:**
- Consola saturada con logs de desarrollo:
  - `üîç [DynamicsLead] Buscando lead...`
  - `‚úÖ [DynamicsLead] Respuesta recibida`
  - `[Realtime] Estado de suscripci√≥n: CHANNEL_ERROR`
  - `Fecha seleccionada:`, `Total llamadas:`, `Filtradas:`
  - `puede ver llamadas programadas`, `loadEtapaTotals`, etc.

**Soluci√≥n:**

**A. Logs Eliminados del C√≥digo:**
- `src/services/dynamicsLeadService.ts` (2 lugares)
- `src/services/scheduledCallsService.ts`
- `src/components/dashboard/widgets/ConversacionesWidget.tsx`
- `src/components/Header.tsx`
- `src/components/prospectos/ProspectosManager.tsx`
- `src/components/scheduled-calls/views/DailyView.tsx` (2 lugares)

**B. Filtros Globales en `consoleInterceptors.ts`:**
```typescript
// Agregados 15+ nuevos filtros:
- '[DynamicsLead]'
- 'Buscando lead'
- 'Respuesta recibida'
- '[Realtime]'
- 'Suscribiendo a notificaciones'
- 'user_notifications_'
- 'CHANNEL_ERROR'
- 'posible sobrecarga'
- 'puede ver llamadas'
- 'puede ver conversaciones'
- 'Carga inicial'
- 'Columna'
- 'Fecha seleccionada'
- 'Total llamadas'
- 'Filtradas'
- 'loadEtapaTotals'
- 'Cambiando tema a'
- 'Header:'
```

**Archivos Modificados:**
- `src/services/dynamicsLeadService.ts`
- `src/services/scheduledCallsService.ts`
- `src/components/dashboard/widgets/ConversacionesWidget.tsx`
- `src/components/Header.tsx`
- `src/components/prospectos/ProspectosManager.tsx`
- `src/components/scheduled-calls/views/DailyView.tsx`
- `src/utils/consoleInterceptors.ts` (15+ filtros agregados)

**Resultado:**
- ‚úÖ Consola limpia en producci√≥n
- ‚úÖ Solo logs cr√≠ticos visibles
- ‚úÖ Mejor experiencia de debugging

---

### 4. Mejoras de UI en Wizard de Importaci√≥n

**Cambios:**

**A. Tarjeta "Prospecto ya existe":**
- **ANTES:** Ejecutivo solo visible si existe
- **AHORA:** Ejecutivo SIEMPRE visible (`"Sin asignar"` si no hay)
- **REMOVIDO:** Bot√≥n "Ver conversaci√≥n existente"

**B. Raz√≥n del cambio:**
- UI m√°s limpia y enfocada
- Informaci√≥n del ejecutivo siempre presente (contacto directo)
- Mensaje m√°s claro: prevenir duplicado, no navegar

**C√≥digo:**
```typescript
// ANTES (condicional)
{existingProspect.ejecutivo_nombre && (
  <div>Ejecutivo: {existingProspect.ejecutivo_nombre}</div>
)}

// AHORA (siempre visible)
<div>
  Ejecutivo: {existingProspect.ejecutivo_nombre || 'Sin asignar'}
</div>

// Bot√≥n removido (l√≠neas 1165-1179)
```

**Archivos Modificados:**
- `src/components/chat/ImportWizardModal.tsx`

---

### 5. Git Commits y Push

**Commits:**
1. `453d5c5` - Deploy principal con todos los hotfixes
   ```
   v2.5.64: B10.1.43N2.5.64 - Hotfix: 401 auth bot pause + Detecci√≥n duplicados WhatsApp + Logs limpieza + UI mejoras
   ```

2. `130591a` - Actualizaci√≥n de hash en DocumentationModule
   ```
   fix: Actualizar hash commit en DocumentationModule
   ```

**Push a:** `origin/main`  
**Estado:** ‚úÖ Completado

---

### 6. Deploy AWS

**Timing:**
- Build: 27.37s
- Upload + Invalidaci√≥n: ~7s
- **Total:** 34s

**URLs:**
- **S3:** http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
- **CloudFront:** https://d3m6zgat40u0u1.cloudfront.net

**Estado:** ‚úÖ Completado

---

### 7. Base de Datos

**Tabla:** `system_config`  
**Config Key:** `app_version`  
**Antes:** `{"version": "B10.1.43N2.5.63", "force_update": true}`  
**Despu√©s:** `{"version": "B10.1.43N2.5.64", "force_update": true}`  
**Updated At:** `2026-01-29T17:52:49.553637+00:00`

**MCP Usado:** `user-SupabaseREST`  
**Tool:** `update_data`  
**Estado:** ‚úÖ Completado y verificado

---

## üìä Cambios Principales

### Archivos Modificados (Total: 16)

**Configuraci√≥n:**
- `src/config/supabaseSystemUI.ts` - Persistencia de sesi√≥n agregada
- `src/config/analysisSupabase.ts` - Persistencia de sesi√≥n agregada
- `src/config/appVersion.ts` - Versi√≥n actualizada a v2.5.64
- `package.json` - Versi√≥n actualizada a 2.5.64

**Componentes:**
- `src/components/chat/ImportWizardModal.tsx` - B√∫squeda mejorada + UI actualizada
- `src/components/dashboard/widgets/ConversacionesWidget.tsx` - Log removido
- `src/components/Header.tsx` - Log removido
- `src/components/prospectos/ProspectosManager.tsx` - Log removido
- `src/components/scheduled-calls/views/DailyView.tsx` - 2 logs removidos
- `src/components/documentation/DocumentationModule.tsx` - Stats y commits actualizados

**Servicios:**
- `src/services/dynamicsLeadService.ts` - 2 logs silenciados
- `src/services/scheduledCallsService.ts` - Log removido

**Utilidades:**
- `src/utils/consoleInterceptors.ts` - 15+ filtros agregados

**Documentaci√≥n:**
- `public/docs/` - 302 archivos sincronizados

---

## üìà M√©tricas del Deploy

**Pre-checks:**
- ‚úÖ Script deploy-complete.ts: OK
- ‚úÖ Handovers dir: Accesible
- ‚úÖ Git status: 13 archivos modificados
- ‚úÖ MCP SupabaseREST: Conectado

**Timing:**
- Pre-checks: 0.6s
- Script ejecuci√≥n: 38.6s
- BD actualizaci√≥n: 0.5s
- Handover creaci√≥n: 2s
- **Total:** ~42s

**Build:**
- Archivos generados: 15
- Bundle principal: 9.28 MB (2.56 MB gzip)
- Tiempo: 27.37s

---

## üîí Seguridad

**Validaciones Realizadas:**
- ‚úÖ Sin `service_role_key` en bundle
- ‚úÖ Solo `anon_key` en producci√≥n
- ‚úÖ Vista `user_profiles_v2` (sin `password_hash`)
- ‚úÖ Configuraci√≥n auth correcta (JWT preservation)
- ‚úÖ RLS respetado en todas las queries

**Notas:**
- Persistencia de sesi√≥n ahora activa (Supabase Auth)
- JWT autom√°tico en headers de requests autenticados
- B√∫squeda de prospectos valida match exacto (seguridad extra)

---

## ‚ö†Ô∏è Issues Conocidos

**1. CHANNEL_ERROR en Realtime**
- **Descripci√≥n:** Error `CHANNEL_ERROR` con `err: undefined` en suscripciones Realtime
- **Causa:** L√≠mite de 200 conexiones simult√°neas (plan b√°sico Supabase)
- **Impacto:** Bajo (fallback con exponential backoff implementado)
- **Soluci√≥n:** Ya implementado retry autom√°tico
- **Silenciado:** Logs agregados a `consoleInterceptors.ts`

**2. Warnings de Vite**
- **Descripci√≥n:** M√≥dulos importados din√°micamente y est√°ticamente
- **Impacto:** Performance (no cr√≠tico)
- **Acci√≥n:** Considerar code-splitting en futuras versiones

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

**Para Usuario:**
1. ‚è≥ Esperar 5-10 min (propagaci√≥n CloudFront)
2. üîÑ Limpiar cache navegador (Cmd+Shift+R en Mac / Ctrl+Shift+R en Windows)
3. ‚úÖ Verificar versi√≥n en footer: `B10.1.43N2.5.64`
4. üß™ Testing sugerido:
   - Pausar/reanudar bot WhatsApp (verificar sin 401)
   - Importar prospecto existente (verificar detecci√≥n duplicado)
   - Verificar consola limpia (sin logs debug)

**Para Desarrollo:**
1. Monitorear logs de producci√≥n (primeras 24h)
2. Validar que usuarios reporten menos errores 401
3. Confirmar que no se crean duplicados en importaciones
4. Considerar optimizaciones de bundle size (code-splitting)

---

## üìö Referencias

**Documentaci√≥n:**
- `.cursor/rules/deploy-workflow.mdc` - Workflow completo de deploy
- `.cursor/rules/security-rules.mdc` - Reglas de seguridad (RLS, vistas)
- `.cursor/rules/arquitectura-bd-unificada.mdc` - Arquitectura BD
- `docs/ARQUITECTURA_SEGURIDAD_2026.md` - Seguridad completa

**Scripts Utilizados:**
- `scripts/deploy-complete.ts` - Deploy automatizado
- `update-frontend.sh` - Deploy AWS

**MCP:**
- `user-SupabaseREST` - Actualizaci√≥n de `system_config`

---

## üéì Lecciones Aprendidas

**1. Supabase Auth: Configuraci√≥n Cr√≠tica**
- La persistencia de sesi√≥n NO es autom√°tica en `createClient()`
- Requiere configuraci√≥n expl√≠cita: `{ auth: { persistSession: true } }`
- Sin esto, el JWT no se preserva entre requests

**2. B√∫squeda de Tel√©fonos: Normalizaci√≥n**
- NUNCA asumir formato √∫nico de tel√©fono en BD
- Siempre buscar por "√∫ltimos N d√≠gitos" (flexibilidad)
- Validar match exacto despu√©s de b√∫squeda amplia (seguridad)

**3. Logs en Producci√≥n: Estrategia Dual**
- Remover logs directamente del c√≥digo (mejor performance)
- Agregar filtros globales en interceptor (cobertura total)
- Documentar cada filtro para debugging futuro

**4. UI/UX: Informaci√≥n Siempre Visible**
- Datos cr√≠ticos (ejecutivo asignado) deben SIEMPRE mostrarse
- No depender de condicionales para info importante
- Fallback claro: `"Sin asignar"` vs campo vac√≠o

---

**Deploy Status:** ‚úÖ COMPLETADO AL 100%  
**Next Review:** 2026-01-30 (validar m√©tricas de producci√≥n)  
**Handover By:** AI Agent (Claude Sonnet 4.5)  
**Session ID:** 2026-01-29-deploy-v2.5.64
