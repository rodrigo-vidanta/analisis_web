# Handover: Deploy v2.5.66

**REF:** HANDOVER-2026-01-29-DEPLOY-v2.5.66  
**Fecha:** 2026-01-29  
**Commit Principal:** 3523827  
**Commit Handover:** 88a45d2  
**Versi√≥n:** B10.1.43N2.5.66

---

## üìã Resumen Ejecutivo

Deploy completo de toggles de configuraci√≥n AI en WhatsApp que permite a los usuarios controlar el comportamiento del bot de forma individual por prospecto con l√≥gica de herencia de etapa.

**Caracter√≠sticas principales:**
- 4 toggles funcionales en header de conversaci√≥n WhatsApp
- L√≥gica inteligente de herencia desde configuraci√≥n de etapa
- Override individual por prospecto (columnas `override_*`)
- Lectura desde vista `v_prospectos_ai_config`
- Indicadores visuales de funcionalidad en desarrollo

---

## ‚úÖ Tareas Completadas

### 1. Actualizaci√≥n de C√≥digo

**Archivo principal:**
- `src/components/chat/LiveChatCanvas.tsx` (~250 l√≠neas modificadas)
  - Estados para configuraci√≥n AI
  - Estados para defaults de etapa
  - Funci√≥n `loadAiConfig()` con carga de defaults
  - Funci√≥n `updateAiConfigOverride()` con l√≥gica de herencia
  - 4 handlers de toggles
  - useEffect para auto-carga al seleccionar conversaci√≥n
  - UI de toggles completamente funcional

**Handover de implementaci√≥n:**
- `.cursor/handovers/2026-01-29-toggles-ai-config-whatsapp.md` (documentaci√≥n t√©cnica completa)

### 2. Git Push

**Commits:**
- `3523827` - v2.5.66: Implementaci√≥n principal de toggles AI
- `88a45d2` - fix: Actualizar hash commit en DocumentationModule

**Branch:** main ‚Üí origin/main  
**Total archivos modificados:** 6 archivos  
**Insertions/Deletions:** +687/-520

### 3. Deploy AWS

**Timing:**
- Build: 30.34s
- Upload + Invalidaci√≥n: 7.66s
- **Total: 38s**

**URLs:**
- S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
- CloudFront: https://d3m6zgat40u0u1.cloudfront.net

**Bundle:**
- Index: 9.28 MB (2.56 MB gzip)
- Total assets: 10.18 MB
- Chunks optimizados con code-splitting

### 4. Base de Datos

**Tabla:** `system_config`  
**Config Key:** `app_version`  
**Versi√≥n Anterior:** B10.1.43N2.5.65  
**Versi√≥n Nueva:** B10.1.43N2.5.66  
**Force Update:** `true`  
**Updated At:** 2026-01-29 21:49:40 UTC  
**Status:** ‚úÖ Actualizado exitosamente

---

## üìä Cambios Principales

### Funcionalidad: Toggles de Configuraci√≥n AI

**4 Toggles implementados:**

1. **IA Responde chat** (‚úÖ Producci√≥n)
   - Lee de: `v_prospectos_ai_config.ai_responde`
   - Escribe en: `prospectos.override_ai_responde`
   - Default de: `etapas.ai_responde_auto`

2. **IA Programa llamada** (‚úÖ Producci√≥n)
   - Lee de: `v_prospectos_ai_config.permite_llamadas_auto`
   - Escribe en: `prospectos.override_permite_llamadas_auto`
   - Default de: `etapas.permite_llamadas_auto`

3. **IA Reactiva chat (en desarrollo)** (‚ö†Ô∏è Beta)
   - Lee de: `v_prospectos_ai_config.mensajes_reactivacion`
   - Escribe en: `prospectos.override_mensajes_reactivacion`
   - Default de: `etapas.mensajes_reactivacion_auto`

4. **IA Manda plantillas (en desarrollo)** (‚ö†Ô∏è Beta)
   - Lee de: `v_prospectos_ai_config.plantillas_reactivacion`
   - Escribe en: `prospectos.override_plantillas_reactivacion`
   - Default de: `etapas.plantillas_reactivacion_auto`

### L√≥gica de Herencia (CR√çTICA)

**Algoritmo implementado:**
```typescript
const newValue = !currentValue;
const defaultValue = etapa[field + '_auto'];

// Si coincide con default ‚Üí null (heredar)
// Si difiere del default ‚Üí true/false (forzar)
const overrideValue = newValue === defaultValue ? null : newValue;
```

**Ventajas:**
- ‚úÖ Optimiza almacenamiento (`null` cuando hereda)
- ‚úÖ Cambios en defaults de etapa afectan autom√°ticamente
- ‚úÖ Override expl√≠cito solo cuando usuario personaliza
- ‚úÖ Trazabilidad completa

### UI/UX

**Mejoras visuales:**
- Toggles con estados visuales claros (color seg√∫n activo/inactivo)
- Loading state durante actualizaci√≥n
- Tooltips removidos (limpieza visual)
- Indicadores "(en desarrollo)" en funciones beta
- Toast con feedback detallado:
  - "Configuraci√≥n activada"
  - "Configuraci√≥n desactivada"
  - "Configuraci√≥n restaurada a default de etapa"

---

## üîç Auto-Verificaci√≥n Final

```
‚úÖ Script deploy-complete.ts: Ejecutado (commit: 3523827)
‚úÖ AWS deploy: Exitoso (38s)
‚úÖ Base de datos: Actualizada (version: B10.1.43N2.5.66)
‚úÖ Handover t√©cnico: Creado (2026-01-29-toggles-ai-config-whatsapp.md)
‚úÖ Handover deploy: Este archivo
‚úÖ Git: 2 commits pusheados
```

**üéâ DEPLOY 100% COMPLETO - Sin errores**

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

### Inmediato (5-10 minutos)
1. ‚è≥ Esperar propagaci√≥n CloudFront (5-10 min)
2. üßπ Limpiar cache navegador (Cmd+Shift+R o Ctrl+F5)
3. ‚úÖ Verificar versi√≥n en footer: debe mostrar "B10.1.43N2.5.66"

### Testing (D√≠a 1)
1. Abrir m√≥dulo WhatsApp
2. Seleccionar una conversaci√≥n
3. Expandir header (bot√≥n chevron)
4. Verificar que aparecen 4 toggles:
   - IA Responde chat
   - IA Programa llamada
   - IA Reactiva chat (en desarrollo)
   - IA Manda plantillas (en desarrollo)
5. Probar cambiar toggle y verificar:
   - Toast de confirmaci√≥n
   - Persistencia al recargar p√°gina
   - L√≥gica de herencia (consola browser debe mostrar logs)

### Monitoreo (Semana 1)
1. Revisar logs de consola para errores
2. Verificar queries a `v_prospectos_ai_config`
3. Monitorear escrituras en columnas `override_*`
4. Validar que l√≥gica de herencia funciona correctamente
5. Feedback de usuarios sobre funcionalidad

### Opcional (Futuro)
1. Implementar indicador visual cuando valor difiere de etapa
2. Bot√≥n "Restaurar a default de etapa"
3. Logs de auditor√≠a en tabla `ai_config_changes`
4. Validaciones de negocio (confirmaciones antes de cambios cr√≠ticos)

---

## üìö Referencias

### Documentaci√≥n T√©cnica
- **Handover Implementaci√≥n:** `.cursor/handovers/2026-01-29-toggles-ai-config-whatsapp.md`
- **Reglas de Seguridad:** `.cursor/rules/security-rules.mdc`
- **Workflow Deploy:** `.cursor/rules/deploy-workflow.mdc`
- **Arquitectura BD:** `.cursor/rules/arquitectura-bd-unificada.mdc`

### Base de Datos
- **Vista:** `v_prospectos_ai_config` (lectura)
- **Tabla:** `prospectos` (escritura en `override_*`)
- **Tabla:** `etapas` (defaults, NO se modifica)

### Archivos Clave
- `src/components/chat/LiveChatCanvas.tsx` - Implementaci√≥n principal
- `src/config/appVersion.ts` - Versi√≥n actualizada
- `package.json` - Versi√≥n npm actualizada
- `src/components/documentation/DocumentationModule.tsx` - Stats y changelog

---

## üìä M√©tricas del Deploy

| M√©trica | Valor |
|---------|-------|
| Versi√≥n desplegada | B10.1.43N2.5.66 |
| Versi√≥n anterior | B10.1.43N2.5.65 |
| Tiempo total | ~2 minutos |
| Archivos modificados | 6 archivos |
| L√≠neas agregadas | +687 |
| L√≠neas eliminadas | -520 |
| Commits | 2 (3523827, 88a45d2) |
| Build time | 30.34s |
| Deploy AWS time | 38s |
| Bundle size | 9.28 MB (2.56 MB gzip) |

---

## üêõ Debugging

### Logs de Consola

Al hacer click en un toggle, deber√≠as ver en consola:

```
üîÑ Actualizando override_ai_responde: {
  currentValue: true,
  newValue: false,
  defaultValue: true,
  overrideValue: 'false'
}
```

### Verificaci√≥n en BD

```sql
-- Ver configuraci√≥n efectiva del prospecto
SELECT * FROM v_prospectos_ai_config 
WHERE id = 'uuid-del-prospecto';

-- Ver overrides expl√≠citos
SELECT 
  id, 
  etapa_id,
  override_ai_responde,
  override_mensajes_reactivacion,
  override_permite_llamadas_auto,
  override_plantillas_reactivacion
FROM prospectos 
WHERE id = 'uuid-del-prospecto';

-- Ver defaults de la etapa
SELECT 
  e.nombre,
  e.ai_responde_auto,
  e.mensajes_reactivacion_auto,
  e.permite_llamadas_auto,
  e.plantillas_reactivacion_auto
FROM etapas e
JOIN prospectos p ON p.etapa_id = e.id
WHERE p.id = 'uuid-del-prospecto';
```

---

## ‚ö†Ô∏è Issues Conocidos

**Ninguno detectado en este deploy.**

---

## üéì Lecciones Aprendidas

1. **L√≥gica de herencia compleja:** Se implement√≥ correctamente comparando nuevo valor con default de etapa
2. **Estados m√∫ltiples:** Necesario mantener tanto valores efectivos como defaults para comparaci√≥n
3. **Feedback visual:** Los indicadores "(en desarrollo)" ayudan a gestionar expectativas
4. **Logs de debugging:** Console logs detallados facilitan troubleshooting

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Duraci√≥n Total:** ~2 minutos  
**CloudFront Propagation:** Pendiente (5-10 min adicionales)

---

**Generado autom√°ticamente por:** deploy-workflow.mdc v3.0.0  
**Script utilizado:** scripts/deploy-complete.ts  
**MCP utilizado:** SupabaseREST (actualizaci√≥n BD)
