# Handover: Deploy v2.5.60

**REF:** HANDOVER-2026-01-28-DEPLOY-v2.5.60  
**Fecha:** 2026-01-28  
**Commit:** 0177a49  
**Versi√≥n:** B10.1.43N2.5.60

---

## üìã Resumen Ejecutivo

Fix cr√≠tico que corrige el problema de `uchat_id` que imped√≠a pausar el bot y enviar mensajes cuando el campo `conversacion_id` en mensajes_whatsapp era string vac√≠o (`''`). Tambi√©n corrige errores de compilaci√≥n (duplicado `isLoaded()` y const reassignment).

---

## ‚úÖ Tareas Completadas

### 1. Actualizaci√≥n de C√≥digo

**Archivos modificados:**
- `src/components/chat/LiveChatCanvas.tsx` (3 ubicaciones)
  - Fix l√≥gica de fallback para `uchat_id` (filtrar string vac√≠o expl√≠citamente)
  - L√≠nea ~2988: `loadProspectoAndFindConversation`
  - L√≠nea ~3368: `loadConversationsFromMessages`
  - L√≠nea ~3386: metadata de conversaci√≥n
- `src/services/etapasService.ts`
  - Eliminado m√©todo duplicado `isLoaded()` (l√≠neas 260-265)
- `src/components/prospectos/ProspectosManager.tsx`
  - Fix const reassignment en l√≠nea 1714 (usar `prospectosFiltrados` directamente)
- `src/config/appVersion.ts`
  - Versi√≥n actualizada: `B10.1.43N2.5.60`
- `package.json`
  - Versi√≥n actualizada: `2.5.60`
- `src/components/documentation/DocumentationModule.tsx`
  - Stats actualizados
  - Nuevo commit en gitCommits array

### 2. Git Push

- **Commit principal:** `0177a49`
  - Mensaje: "v2.5.60: B10.1.43N2.5.60 - FIX CR√çTICO: uchat_id string vac√≠o impide pausar bot y enviar mensajes + Fix duplicado isLoaded() + Fix const reassignment"
- **Commit docs:** `ab208a0`
  - Mensaje: "fix: Actualizar hash commit en DocumentationModule"
- Push a: `origin/main`

### 3. Deploy AWS

- **Build:** 23.55s
- **Deploy total:** 31s
- **URLs:**
  - S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
  - CloudFront: https://d3m6zgat40u0u1.cloudfront.net

### 4. Base de Datos

- **Tabla:** `system_config`
- **Config Key:** `app_version`
- **Versi√≥n anterior:** `B10.1.43N2.5.59`
- **Versi√≥n nueva:** `B10.1.43N2.5.60`
- **Updated at:** 2026-01-29T04:11:57.328872Z
- **Force update:** `true`

---

## üìä Cambios Principales

### üêõ Fix Cr√≠tico: uchat_id String Vac√≠o

**Problema:** 
- El c√≥digo usaba `||` (OR l√≥gico) para fallbacks
- En JavaScript: `'' || 'fallback'` retorna `''` (¬°NO eval√∫a el fallback!)
- Cuando `lastMessage.conversacion_id` era `''`, no llegaba a `prospecto.id_uchat`
- Resultado: Bot√≥n pausar bot y env√≠o de mensajes fallaban

**Soluci√≥n:**
```typescript
// ‚ùå ANTES
const uchatId = lastMessage.conversacion_id || prospecto.id_uchat || '';

// ‚úÖ AHORA
const uchatId = (lastMessage.conversacion_id && lastMessage.conversacion_id.trim() !== '')
  ? lastMessage.conversacion_id
  : (prospecto.id_uchat || '');
```

**Impacto:**
- ‚úÖ Bot√≥n pausar bot ahora funciona correctamente
- ‚úÖ Env√≠o de mensajes via par√°frasis funciona
- ‚úÖ Env√≠o de plantillas WhatsApp funciona
- ‚úÖ Importaci√≥n de prospectos funciona

### üîß Fix Compilaci√≥n: Duplicado isLoaded()

**Problema:**
- M√©todo `isLoaded()` declarado 2 veces en `etapasService.ts` (l√≠neas 82-84 y 263-265)
- Error: "Duplicate member 'isLoaded' in class body"

**Soluci√≥n:**
- Eliminado duplicado en l√≠neas 260-265
- Mantenido el primero en l√≠neas 82-84

### üîß Fix Compilaci√≥n: Const Reassignment

**Problema:**
- `enrichedProspectos` es `const` pero se intenta reasignar en l√≠nea 1714
- Error: "This assignment will throw because 'enrichedProspectos' is a constant"

**Soluci√≥n:**
- Usar `prospectosFiltrados` directamente en `setAllProspectos()` y `setProspectos()`
- Comentario explicativo agregado

---

## üîç An√°lisis de Funci√≥n `loadProspectoAndFindConversation`

**Pregunta:** ¬øEsta funci√≥n todav√≠a se usa en el bot√≥n de importar?

**Respuesta:** NO

**Flujo actual (desde v2.5.50):**
1. Usuario hace clic en bot√≥n "+" ‚Üí Abre `ImportWizardModal`
2. Backend crea conversaci√≥n (si no existe) v√≠a Edge Function
3. Backend devuelve `conversacion_id`
4. Modal dispara eventos:
   - `refresh-livechat-conversations`
   - `select-livechat-conversation` con el ID
5. `LiveChatCanvas` busca en lista cargada
6. **NO llama a** `loadProspectoAndFindConversation`

**¬øSe puede eliminar?**
- ‚ùå NO - Todav√≠a se usa para:
  - Restaurar conversaci√≥n desde localStorage al reabrir app
  - Fallback si listener de eventos falla
  - Casos edge de recuperaci√≥n

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

1. **Esperar 5-10 min** (propagaci√≥n CloudFront)
2. **Limpiar cache navegador** (Cmd+Shift+R / Ctrl+Shift+R)
3. **Verificar versi√≥n en footer:** Debe mostrar `B10.1.43N2.5.60`
4. **Probar funcionalidad cr√≠tica:**
   - ‚úÖ Pausar bot desde m√≥dulo WhatsApp
   - ‚úÖ Enviar mensaje con par√°frasis
   - ‚úÖ Enviar plantilla desde Quick Import
   - ‚úÖ Importar prospecto nuevo

---

## üìö Referencias

### Documentaci√≥n Relacionada
- `.cursor/rules/deploy-workflow.mdc` - Workflow de deploy seguido
- `.cursor/rules/mcp-rules.mdc` - Reglas de uso de MCP
- `docs/NUEVA_ARQUITECTURA_BD_UNIFICADA.md` - Arquitectura BD
- `src/components/chat/ImportWizardModal.tsx` - Nuevo flujo de importaci√≥n

### Issues Relacionados
- **Error CORS 502:** Diagn√≥stico realizado pero NO relacionado con este fix
  - Causa: Query con ~100 UUIDs excede l√≠mite de URL
  - Estado: En investigaci√≥n, no bloqueante

---

## üéØ M√©tricas del Deploy

| M√©trica | Valor |
|---------|-------|
| ‚è±Ô∏è Tiempo total | ~2 minutos |
| üì¶ Archivos modificados | 6 archivos |
| üî® Commits | 2 (0177a49, ab208a0) |
| üìä Bundle size | 9.28 MB (2.56 MB gzipped) |
| ‚úÖ Pre-checks | Todos OK |
| ‚úÖ Build | Exitoso (23.55s) |
| ‚úÖ Git push | Exitoso |
| ‚úÖ AWS deploy | Exitoso (31s) |
| ‚úÖ BD actualizada | Exitoso |
| ‚úÖ Handover | Creado |

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Lecciones Aprendidas:**
- String vac√≠o (`''`) en JavaScript no activa fallback con `||`
- Siempre verificar si valor es `''` adem√°s de `null`/`undefined`
- Usar trim() para verificar strings realmente vac√≠os
- TypeScript const no permite reassignment (usar let o variable diferente)
