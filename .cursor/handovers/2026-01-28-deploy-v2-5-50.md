# Handover: Deploy v2.5.50

**REF:** HANDOVER-2026-01-28-DEPLOY-v2.5.50  
**Fecha:** 2026-01-28  
**Commits:** 28cfaca, 02c47c9, 42ee9b1  
**Versi√≥n:** B10.1.43N2.5.50

---

## üìã Resumen Ejecutivo

Deploy completo con fix cr√≠tico de navegaci√≥n SPA en el m√≥dulo de Quick Import WhatsApp. Se reemplaz√≥ `window.location.href` (hard reload) por sistema de eventos personalizados (`CustomEvent`) consistente con la arquitectura de la aplicaci√≥n.

---

## ‚úÖ Tareas Completadas

### 1. Fix Navegaci√≥n SPA - Quick Import WhatsApp

**Problema:** Despu√©s de importar un prospecto y enviar una plantilla, la aplicaci√≥n recargaba completamente la p√°gina en lugar de navegar de forma fluida.

**Soluci√≥n:**
- Reemplazo de `window.location.href` por eventos personalizados en `LiveChatModule.tsx`
- Implementaci√≥n de listener en `LiveChatCanvas.tsx` para seleccionar conversaci√≥n autom√°ticamente
- Navegaci√≥n SPA instant√°nea sin p√©rdida de estado
- Toast de confirmaci√≥n + scroll autom√°tico al chat

**Archivos modificados:**
- `src/components/chat/LiveChatModule.tsx` (l√≠nea ~283-305)
- `src/components/chat/LiveChatCanvas.tsx` (nuevo useEffect l√≠nea ~3510-3569)

### 2. Actualizaci√≥n de C√≥digo

**Archivos creados (deploy anterior incluido):**
- `.cursor/handovers/2026-01-28-fix-navegacion-quick-import.md`
- `.cursor/handovers/2026-01-28-quick-import-validacion-permisos-plantillas.md`
- `.cursor/rules/mcp-supabase-rest-full.mdc`
- `src/components/chat/QuickImportModal.tsx`
- `src/components/chat/SendTemplateToProspectModal.tsx`
- `src/services/importContactService.ts`
- `supabase/functions/import-contact-proxy/`
- M√∫ltiples archivos de documentaci√≥n y deployment logs

**Total:** 45 archivos modificados, 7,663 inserciones, 659 eliminaciones

### 3. Git Push

- **Commit 1:** `28cfaca` - Cambios principales (Quick Import, validaciones, documentaci√≥n)
- **Commit 2:** `02c47c9` - Actualizaci√≥n de hash commit en DocumentationModule
- **Commit 3:** `42ee9b1` - Correcci√≥n de versi√≥n a B10.1.43N2.5.50
- **Push a:** origin/main ‚úÖ

### 4. Deploy AWS

- **Build:** 19.89s
- **Upload + Cache:** 20s adicionales
- **Total:** ~40s
- **Bundle size:** 9.26 MB (gzip: 2.56 MB)
- **URLs:**
  - S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
  - CloudFront: https://d3m6zgat40u0u1.cloudfront.net

‚ö†Ô∏è **Warnings:**
- Bundle size >500KB (esperado para SPA grande)
- Dynamic imports de archivos tambi√©n est√°ticamente importados (conocido, no afecta funcionamiento)

### 5. Base de Datos

- **Tabla:** `system_config`
- **Config Key:** `app_version`
- **Versi√≥n actualizada:** `B10.1.43N2.5.50`
- **Force Update:** `true` ‚úÖ
- **Timestamp:** 2026-01-28T19:58:40Z

---

## üìä Cambios Principales

### Quick Import WhatsApp - Navegaci√≥n SPA

**Antes:**
```typescript
// ‚ùå Hard reload completo
window.location.href = `/live-chat?conversation=${conversacionId}`;
```

**Despu√©s:**
```typescript
// ‚úÖ Navegaci√≥n SPA con eventos
window.dispatchEvent(new CustomEvent('select-livechat-conversation', { 
  detail: conversacionId 
}));
toast.success('Conversaci√≥n iniciada correctamente');
```

**Beneficios:**
- ‚úÖ Sin recarga de p√°gina
- ‚úÖ Mantiene estado de React
- ‚úÖ Transici√≥n instant√°nea
- ‚úÖ No pierde conexiones Supabase realtime
- ‚úÖ Mejor UX (sin pantalla en blanco)

### Listener en LiveChatCanvas

- Escucha evento `select-livechat-conversation`
- Busca conversaci√≥n en `allConversationsLoaded`
- Selecciona autom√°ticamente
- Scroll al chat
- Fallback robusto si no encuentra la conversaci√≥n (refresh + retry)

---

## üîß Correcciones Post-Deploy

### Bug del Script de Deploy

**Problema:** El script `deploy-complete.ts` no interpret√≥ correctamente el primer argumento como mensaje, us√°ndolo como versi√≥n.

**Resultado:** `appVersion.ts` qued√≥ con valor `'Fix navegaci√≥n SPA...'` en lugar de `'B10.1.43N2.5.50'`

**Correcci√≥n Manual:**
1. Actualizaci√≥n manual de `appVersion.ts` a `B10.1.43N2.5.50`
2. Commit: `42ee9b1`
3. Push exitoso

**Acci√≥n Futura:** Revisar l√≥gica del script `deploy-complete.ts` para manejar correctamente los argumentos.

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

1. **Inmediato (Usuario):**
   - Esperar 5-10 min para propagaci√≥n CloudFront
   - Limpiar cache del navegador (Cmd+Shift+R)
   - Verificar versi√≥n en footer: `v2.5.50`
   - Probar flujo de Quick Import completo

2. **Testing Recomendado:**
   - Importar prospecto nuevo desde m√≥dulo WhatsApp (bot√≥n `+`)
   - Enviar plantilla sin variables
   - Verificar navegaci√≥n fluida SIN recarga
   - Verificar que se abre el chat autom√°ticamente
   - Verificar scroll al final del chat

3. **Monitoreo:**
   - Verificar logs de CloudFront para errores 404/502
   - Monitorear consola del navegador para errores JS
   - Verificar que usuarios con versi√≥n antigua reciban modal de actualizaci√≥n

4. **Desarrollo Futuro:**
   - Investigar por qu√© `deploy-complete.ts` no increment√≥ versi√≥n correctamente
   - Considerar agregar validaci√≥n de versi√≥n en el script
   - Documentar formato correcto de argumentos del script

---

## üìö Referencias

### Documentaci√≥n Creada
- [Fix Navegaci√≥n Quick Import](.cursor/handovers/2026-01-28-fix-navegacion-quick-import.md)
- [Quick Import Validaci√≥n](.cursor/handovers/2026-01-28-quick-import-validacion-permisos-plantillas.md)
- [MCP Supabase REST](.cursor/rules/mcp-supabase-rest-full.mdc)

### Archivos Clave
- `src/components/chat/LiveChatModule.tsx` - M√≥dulo principal WhatsApp
- `src/components/chat/LiveChatCanvas.tsx` - Canvas con listener de eventos
- `src/components/chat/QuickImportModal.tsx` - Modal de importaci√≥n r√°pida
- `src/components/chat/SendTemplateToProspectModal.tsx` - Modal de env√≠o de plantillas
- `src/services/importContactService.ts` - Servicio de importaci√≥n

### Sistema de Navegaci√≥n
- La app NO usa React Router
- Usa `appMode` (estado global) + eventos personalizados
- `window.location.href` debe evitarse (hard reload)
- Preferir `CustomEvent` para comunicaci√≥n entre componentes

---

## üêõ Issues Conocidos

### Warning: Bundle Size >500KB
- **Status:** ‚ö†Ô∏è Conocido, no cr√≠tico
- **Impacto:** Tiempo de carga inicial m√°s lento
- **Soluci√≥n futura:** Code splitting con dynamic imports
- **Prioridad:** Baja

### Dynamic Import Warnings (Vite)
- **Status:** ‚ö†Ô∏è Conocido, no afecta funcionalidad
- **Causa:** Archivos importados din√°micamente y est√°ticamente
- **Impacto:** Ninguno (chunks se generan correctamente)
- **Prioridad:** Baja

### Script deploy-complete.ts
- **Status:** üêõ Bug detectado
- **Causa:** No interpreta correctamente argumentos de versi√≥n
- **Workaround:** Correcci√≥n manual de `appVersion.ts`
- **Prioridad:** Media (documentar uso correcto)

---

## üìä M√©tricas del Deploy

| M√©trica | Valor |
|---------|-------|
| **Tiempo total** | ~2 minutos |
| **Archivos modificados** | 45 |
| **Inserciones** | 7,663 l√≠neas |
| **Eliminaciones** | 659 l√≠neas |
| **Commits** | 3 |
| **Build time** | 19.89s |
| **Deploy time** | 40s |
| **Bundle size (gzip)** | 2.56 MB |
| **CloudFront propagation** | 5-10 min (pendiente) |

---

## ‚úÖ Checklist Completado

- [x] Documentaci√≥n sincronizada (300 archivos)
- [x] Versi√≥n actualizada (B10.1.43N2.5.50)
- [x] Git push exitoso (3 commits)
- [x] AWS deploy exitoso (40s)
- [x] Base de datos actualizada
- [x] Handover creado y commiteado
- [x] Fix de navegaci√≥n SPA implementado
- [x] Listener de eventos agregado
- [x] Testing local exitoso

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Lecciones Aprendidas:**  
1. Siempre verificar que `deploy-complete.ts` incremente la versi√≥n correctamente
2. El sistema de navegaci√≥n de la app usa eventos personalizados, NO React Router
3. `window.location.href` causa hard reload y debe evitarse en SPAs
4. Usar `CustomEvent` para comunicaci√≥n entre componentes distantes
