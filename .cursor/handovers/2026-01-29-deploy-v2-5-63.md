# Handover: Deploy v2.5.63 - Hotfixes Cr√≠ticos

**REF:** HANDOVER-2026-01-29-DEPLOY-v2.5.63  
**Fecha:** 2026-01-29  
**Commit Principal:** c8bdb60  
**Commit Actualizaci√≥n Hash:** 3bdfbce  
**Versi√≥n:** B10.1.43N2.5.63

---

## üìã Resumen Ejecutivo

Deploy de hotfixes cr√≠ticos para resolver 4 issues principales:
1. Dashboard crash al filtrar por coordinaci√≥n (etapas din√°micas)
2. Warnings de Recharts en widgets de m√©tricas
3. Error 401 "Authentication required" en Edge Functions
4. M√≥dulo WhatsApp no cargaba (import faltante)

**Todos los issues resueltos y testeados en desarrollo.**

---

## ‚úÖ Tareas Completadas

### 1. Hotfix: Dashboard Crash (Etapas Din√°micas)

**Problema:** Dashboard crasheaba con error `FUNNEL_CONVERSION_STAGES is not defined` al filtrar por coordinaci√≥n "APEX".

**Causa Ra√≠z:** C√≥digo legacy en `DashboardModule.tsx` que referenciaba constantes hardcodeadas (`FUNNEL_CONVERSION_STAGES`, `OUT_OF_FUNNEL_STAGES`) despu√©s de la migraci√≥n a etapas din√°micas (2026-01-27).

**Soluci√≥n:**
- **Archivo:** `src/components/dashboard/DashboardModule.tsx`
- **Cambios:**
  1. Eliminada funci√≥n legacy `loadPipelineData` (l√≠neas 3648-3852) con referencias a constantes obsoletas
  2. Actualizado componente `FunnelContent` (l√≠nea 1831) para usar `coord.stages` din√°micas en lugar de `FUNNEL_CONVERSION_STAGES`

```typescript
// ANTES (l√≠neas 1831-1835)
const stageNames = FUNNEL_CONVERSION_STAGES.map(s => s.name);
const values = FUNNEL_CONVERSION_STAGES.map(s => {
  const found = coord.stages.find(cs => cs.stage === s.name);
  return found?.count || 0;
});

// DESPU√âS
const stageNames = coord.stages.map(s => s.stage);
const values = coord.stages.map(s => s.count);
```

**Referencia:** `.cursor/handovers/2026-01-27-dashboard-etapas-dinamicas.md` (migraci√≥n previa)

### 2. Hotfix: Recharts Warnings

**Problema:** Warnings en consola `The width(-1) and height(-1) of chart should be greater than 0` en m√∫ltiples widgets.

**Causa:** `ResponsiveContainer` de Recharts renderizaba antes de que contenedores padres establecieran dimensiones.

**Soluci√≥n:**
- **Archivos modificados:**
  1. `src/components/dashboard/DashboardModule.tsx`
  2. `src/components/dashboard/widgets/ProspectosMetricsWidget.tsx`
  3. `src/components/dashboard/widgets/EjecutivosMetricsWidget.tsx`

- **Cambios:**
  - Agregado `minHeight` prop a todos los `ResponsiveContainer`
  - En modales: cambiado `height="100%"` a valores fijos (`height={350}`, `height={200}`)

```typescript
// ANTES
<ResponsiveContainer width="100%" height="100%">

// DESPU√âS (contexto normal)
<ResponsiveContainer width="100%" height="100%" minHeight={200}>

// DESPU√âS (contexto modal)
<ResponsiveContainer width="100%" height={350}>
```

### 3. Hotfix: Error 401 en Edge Functions (CR√çTICO)

**Problema:** Todas las Edge Functions retornaban error 401 "Authentication required":
- Programar llamadas manuales
- Pausar/reanudar bot WhatsApp
- Enviar mensajes WhatsApp
- Enviar im√°genes
- Generar par√°frasis

**Causa Ra√≠z:** C√≥digo usaba `analysisSupabase.auth.getSession()` para obtener JWT, pero **`analysisSupabase` NO tiene sesi√≥n de usuario** (solo consultas). La sesi√≥n est√° en `supabaseSystemUI` (donde se hace login).

**Contexto Arquitect√≥nico:**
- **Base de datos:** TODO en PQNC_AI (glsmifhkoaifvaegsozd) tras migraci√≥n 2026-01-13
- **Autenticaci√≥n:** Supabase Auth nativo en PQNC_AI (migraci√≥n 2026-01-16)
- **Clientes Supabase:**
  - `supabaseSystemUI` ‚Üí PQNC_AI (**tiene sesi√≥n de auth**)
  - `analysisSupabase` ‚Üí PQNC_AI (**NO tiene sesi√≥n**, solo queries)

**Soluci√≥n:**

1. **Nuevo archivo:** `src/utils/authToken.ts`
   - Utilidad centralizada para obtener JWT desde `supabaseSystemUI`
   - Funciones: `getAuthToken()` y `getAuthTokenOrThrow()`

```typescript
// src/utils/authToken.ts (nuevo)
import { supabaseSystemUI } from '../config/supabaseSystemUI';

export async function getAuthToken(): Promise<string | null> {
  const { data: { session } } = await supabaseSystemUI.auth.getSession();
  return session?.access_token || null;
}

export async function getAuthTokenOrThrow(): Promise<string> {
  const token = await getAuthToken();
  if (!token) {
    throw new Error('Usuario no autenticado. Por favor recarga la p√°gina.');
  }
  return token;
}
```

2. **Archivos actualizados (5):**
   - `src/components/shared/ManualCallModal.tsx`
   - `src/components/chat/LiveChatCanvas.tsx` (3 lugares)
   - `src/components/chat/ImageCatalogModalV2.tsx`
   - `src/components/chat/ImageCatalogModal.tsx`

```typescript
// ANTES (INCORRECTO)
const { data: { session } } = await analysisSupabase.auth.getSession();
const authToken = session?.access_token || import.meta.env.VITE_ANALYSIS_SUPABASE_ANON_KEY;
// ‚ùå session siempre null ‚Üí usa anon_key ‚Üí Edge Function rechaza con 401

// DESPU√âS (CORRECTO)
import { getAuthTokenOrThrow } from '../../utils/authToken';
const authToken = await getAuthTokenOrThrow();
// ‚úÖ Obtiene JWT v√°lido desde supabaseSystemUI ‚Üí Edge Function acepta
```

3. **Mejoras adicionales en `ManualCallModal.tsx`:**
   - Logging detallado para debugging
   - Mensajes de error espec√≠ficos por c√≥digo HTTP (404, 401/403, 500, network)

**Edge Functions afectadas:**
- `trigger-manual-proxy` (programar llamadas)
- `pause-bot-proxy` (control bot WhatsApp)
- `send-message-proxy` (mensajes WhatsApp)
- `send-img-proxy` (im√°genes WhatsApp)
- `paraphrase-proxy` (par√°frasis)

**Documentaci√≥n relacionada:**
- `docs/MIGRACION_SYSTEM_UI_A_PQNC_AI_COMPLETA.md` (migraci√≥n BD 2026-01-13)
- `docs/MIGRACION_SUPABASE_AUTH_NATIVO.md` (migraci√≥n Auth 2026-01-16)
- `src/config/supabaseSystemUI.ts` (configuraci√≥n cliente, l√≠nea 8: "Este archivo ahora apunta a PQNC_AI")

### 4. Hotfix: WhatsApp Module No Cargaba

**Problema:** M√≥dulo WhatsApp no cargaba con error `coordinacionService is not defined`.

**Causa:** Al agregar import de `getAuthTokenOrThrow`, accidentalmente se elimin√≥ el import de `coordinacionService`.

**Soluci√≥n:**
- **Archivo:** `src/components/chat/LiveChatCanvas.tsx`
- **Cambio:** Agregado import faltante:

```typescript
import { coordinacionService } from '../../services/coordinacionService';
```

---

## üîÑ Git Push

**Commits:**
1. **c8bdb60** - `v2.5.63: B10.1.43N2.5.63 - Hotfix: Dashboard crash (etapas din√°micas) + Recharts warnings + Auth 401 Edge Functions + WhatsApp module`
   - Archivos: 11 changed, 142 insertions(+), 247 deletions(-)
   - Archivo nuevo: `src/utils/authToken.ts`
   
2. **3bdfbce** - `fix: Actualizar hash commit en DocumentationModule`
   - Archivo: 1 changed, 1 insertion(+), 1 deletion(-)

**Push a:** origin/main ‚úÖ

---

## üöÄ Deploy AWS

**M√©tricas:**
- Build time: 18.89s
- Deploy total: 26s
- Bundle size: 9,280.78 kB (2,563.79 kB gzipped)

**URLs:**
- S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
- CloudFront: https://d3m6zgat40u0u1.cloudfront.net

**‚è≥ CloudFront Propagation:** 5-10 minutos

---

## üíæ Base de Datos

**Tabla:** `system_config`  
**Config Key:** `app_version`  
**Versi√≥n Actualizada:** `B10.1.43N2.5.63`  
**Config Value:**
```json
{
  "version": "B10.1.43N2.5.63",
  "force_update": true
}
```
**Updated At:** 2026-01-29T17:10:04.677669+00:00  
**Estado:** ‚úÖ ACTUALIZADO

---

## üìä Archivos Modificados (8)

| Archivo | Cambios | Tipo |
|---------|---------|------|
| `src/utils/authToken.ts` | +43 l√≠neas | Nuevo archivo |
| `src/components/shared/ManualCallModal.tsx` | Mejoras logging + fix auth | Modificado |
| `src/components/chat/LiveChatCanvas.tsx` | Fix auth (3x) + import coordinacionService | Modificado |
| `src/components/chat/ImageCatalogModalV2.tsx` | Fix auth | Modificado |
| `src/components/chat/ImageCatalogModal.tsx` | Fix auth | Modificado |
| `src/components/dashboard/DashboardModule.tsx` | Eliminado legacy + fix Recharts | Modificado |
| `src/components/dashboard/widgets/EjecutivosMetricsWidget.tsx` | Fix Recharts warnings | Modificado |
| `src/components/dashboard/widgets/ProspectosMetricsWidget.tsx` | Fix Recharts warnings | Modificado |

**Total:** 11 archivos (142 insertions, 247 deletions)

---

## üß™ Testing

### Testing Manual Realizado en Desarrollo

**‚úÖ Dashboard:**
- [x] Filtrar por coordinaci√≥n "APEX" ‚Üí No crash
- [x] Ver funnel de conversi√≥n ‚Üí Sin errores
- [x] No warnings de Recharts en consola

**‚úÖ Edge Functions:**
- [x] Programar llamada manual ‚Üí √âxito (sin 401)
- [x] Pausar bot WhatsApp ‚Üí √âxito
- [x] Enviar mensaje WhatsApp ‚Üí √âxito
- [x] Enviar imagen ‚Üí √âxito
- [x] Generar par√°frasis ‚Üí √âxito

**‚úÖ M√≥dulo WhatsApp:**
- [x] M√≥dulo carga correctamente
- [x] Lista de conversaciones visible
- [x] Sin error `coordinacionService is not defined`

### Testing Pendiente en Producci√≥n

Despu√©s de CloudFront propagation (5-10 min):

1. **Verificar versi√≥n en footer:** Debe mostrar `B10.1.43N2.5.63`
2. **Forzar recarga:** Cmd+Shift+R (Mac) o Ctrl+Shift+R (Windows)
3. **Probar Dashboard:** Filtrar por cualquier coordinaci√≥n
4. **Probar programar llamada:** Debe funcionar sin error 401
5. **Probar WhatsApp:** Pausar/reanudar bot, enviar mensajes

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

### Inmediato (Usuario)
1. ‚è±Ô∏è Esperar 5-10 min para propagaci√≥n de CloudFront
2. üîÑ Limpiar cache del navegador (Cmd+Shift+R)
3. ‚úÖ Verificar versi√≥n en footer: `B10.1.43N2.5.63`
4. üß™ Probar todos los fixes en producci√≥n (ver checklist arriba)

### Seguimiento (Desarrollo)
1. Monitorear logs de errores 401 en pr√≥ximas 24h (deben desaparecer)
2. Monitorear warnings de Recharts en consola (deben desaparecer)
3. Verificar que no haya regresiones en m√≥dulos afectados

---

## üìö Referencias

### Documentaci√≥n Relacionada
- [Migraci√≥n BD Unificada](../docs/MIGRACION_SYSTEM_UI_A_PQNC_AI_COMPLETA.md) (2026-01-13)
- [Migraci√≥n Auth Nativo](../docs/MIGRACION_SUPABASE_AUTH_NATIVO.md) (2026-01-16)
- [Migraci√≥n Etapas Din√°micas](.cursor/handovers/2026-01-27-dashboard-etapas-dinamicas.md) (2026-01-27)
- [Arquitectura BD Unificada](.cursor/rules/arquitectura-bd-unificada.mdc)
- [Security Rules](.cursor/rules/security-rules.mdc)

### Archivos Clave
- `src/config/supabaseSystemUI.ts` - Configuraci√≥n cliente (apunta a PQNC_AI)
- `src/services/authService.ts` - Auth nativo Supabase
- `src/utils/authToken.ts` - Utilidad nueva para JWT

---

## üéØ M√©tricas de √âxito

**Deploy Status:** ‚úÖ COMPLETADO 100%

| M√©trica | Estado | Detalle |
|---------|--------|---------|
| Pre-checks | ‚úÖ | Script, Git, Handovers dir OK |
| Script deploy-complete.ts | ‚úÖ | Ejecutado (commit: c8bdb60) |
| Git push | ‚úÖ | 2 commits pusheados |
| AWS deploy | ‚úÖ | Build: 18.89s, Total: 26s |
| Base de datos | ‚úÖ | Versi√≥n actualizada: B10.1.43N2.5.63 |
| Handover | ‚úÖ | Creado y documentado |

**Tiempo total:** ~2 minutos  
**Errores:** 0  
**Warnings:** 0 (post-fix)

---

## üîç Lecciones Aprendidas

### Buenas Pr√°cticas Identificadas

1. **Utilidades centralizadas:** El nuevo `authToken.ts` evita duplicaci√≥n de c√≥digo para obtener JWT en 5+ archivos.

2. **Documentaci√≥n de migraciones:** Las referencias a handovers previos (`2026-01-27-dashboard-etapas-dinamicas.md`) fueron cruciales para entender el contexto del crash.

3. **Testing incremental:** Detectar y corregir el import faltante (`coordinacionService`) inmediatamente despu√©s de aplicar el fix de auth evit√≥ un segundo deploy.

4. **Logging mejorado:** Los logs detallados en `ManualCallModal.tsx` facilitar√°n debugging futuro de Edge Functions.

### Mejoras Sugeridas

1. **Linter para imports:** Configurar ESLint para detectar uso de imports eliminados o faltantes.

2. **Tests E2E:** Agregar tests automatizados para Edge Functions (auth, pausar bot, enviar mensajes).

3. **Monitoreo de constantes deprecadas:** Script para detectar referencias a `FUNNEL_CONVERSION_STAGES` u otras constantes obsoletas tras migraciones.

---

**Deploy completado por:** AI Agent (Cursor)  
**Timestamp:** 2026-01-29 17:10 UTC  
**Next Review:** 2026-01-30 (verificar m√©tricas de errores 401)
