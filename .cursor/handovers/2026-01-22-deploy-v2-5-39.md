# Handover Deploy v2.5.39

**REF:** `HANDOVER-2026-01-22-DEPLOY-v2.5.39`  
**Fecha:** 22 de Enero 2026  
**Versión:** `v2.5.39` / `B10.1.39N2.5.39`  
**Commit:** `1a3ff05`

---

## Resumen Ejecutivo

Deploy completo del sistema de control de versiones forzado con actualización automática en base de datos. El sistema ahora compara la versión del build con la versión requerida almacenada en `system_config` y fuerza la actualización mediante un modal de pantalla completa.

---

## Archivos Principales Modificados

### Nuevos Archivos
- `src/hooks/useVersionCheck.ts` - Hook para verificación de versión con realtime
- `src/components/shared/ForceUpdateModal.tsx` - Modal de actualización forzada
- `docs/VERSION_CONTROL_SYSTEM.md` - Documentación completa del sistema
- `docs/VERSION_CONTROL_SETUP.md` - Guía de setup y testing
- `docs/DEPLOY_VERSION_UPDATE_GUIDE.md` - Guía de actualización automática en BD
- `scripts/update-app-version.ts` - Script para actualización manual (alternativa)
- `scripts/sql/enable_realtime_system_config.sql` - SQL para habilitar Realtime

### Archivos Modificados
- `src/components/MainApp.tsx` - Integración del hook y modal de versión
- `src/components/Footer.tsx` - Versión hardcodeada: `B10.1.39N2.5.39`
- `src/components/documentation/DocumentationModule.tsx` - Actualización stats y historial
- `.cursor/rules/deploy-workflow.mdc` - Regla actualizada con PASO 6.5 (actualización BD)

---

## Commits Realizados

```
1a3ff05 v2.5.39: B10.1.39N2.5.39 - Sistema control versiones forzado + actualización automática BD
```

**Archivos en commit:** 40 archivos modificados, 11,465 inserciones

---

## Estado del Deploy AWS

- ✅ **Build exitoso** - Vite build completado sin errores
- ✅ **Deploy completado** - Frontend actualizado en producción
- ✅ **Versión en BD** - `app_version` actualizada a `B10.1.39N2.5.39` (vía MCP)

---

## Sistema de Control de Versiones

### Funcionalidad Implementada

1. **Hook `useVersionCheck`**:
   - Lee versión requerida de `system_config.app_version`
   - Compara con versión del build (`VITE_APP_VERSION` o fallback)
   - Extrae primera parte antes de "N" para comparación (ej: `B10.1.39` de `B10.1.39N2.5.39`)
   - Suscripción Realtime con fallback polling (30s)

2. **Modal `ForceUpdateModal`**:
   - Pantalla completa con backdrop blur
   - Muestra versión actual vs requerida
   - Botón de reload forzado
   - Animaciones con Framer Motion

3. **Actualización Automática en BD**:
   - Integrada en workflow de deploy (PASO 6.5)
   - Usa MCP SupabaseREST con access token de `.supabase/access_token`
   - Actualiza `system_config.app_version` con formato completo

### Configuración en BD

```json
{
  "config_key": "app_version",
  "config_value": {
    "version": "B10.1.39N2.5.39",
    "force_update": true
  }
}
```

### Versión en Footer.tsx

```typescript
const version = 'B10.1.39N2.5.39';
```

---

## Próximos Pasos

### Manual (Requerido)

1. **Habilitar Realtime en `system_config`**:
   - Ejecutar SQL en Supabase Dashboard:
   ```sql
   ALTER PUBLICATION supabase_realtime ADD TABLE public.system_config;
   ```
   - O ejecutar: `scripts/sql/enable_realtime_system_config.sql`

### Automático (Ya Implementado)

- ✅ Actualización de versión en BD durante deploy (PASO 6.5)
- ✅ Comparación automática en cliente
- ✅ Modal de actualización forzada

---

## Testing

### Verificar Funcionamiento

1. **Cambiar versión en BD**:
   ```sql
   UPDATE system_config 
   SET config_value = '{"version": "B10.1.40N2.5.40", "force_update": true}'::jsonb
   WHERE config_key = 'app_version';
   ```

2. **Recargar aplicación**:
   - Debe aparecer modal de actualización forzada
   - Botón "Recargar" debe funcionar

3. **Restaurar versión correcta**:
   ```sql
   UPDATE system_config 
   SET config_value = '{"version": "B10.1.39N2.5.39", "force_update": true}'::jsonb
   WHERE config_key = 'app_version';
   ```

---

## Documentación Relacionada

- `docs/VERSION_CONTROL_SYSTEM.md` - Arquitectura completa
- `docs/VERSION_CONTROL_SETUP.md` - Setup y testing
- `docs/DEPLOY_VERSION_UPDATE_GUIDE.md` - Guía de actualización automática
- `.cursor/rules/deploy-workflow.mdc` - Workflow de deploy actualizado

---

## Notas Técnicas

- **Comparación de versiones**: Extrae primera parte antes de "N" (ej: `B10.1.39`)
- **Realtime**: Requiere habilitación manual en Supabase Dashboard
- **Fallback**: Polling cada 30 segundos si Realtime no está disponible
- **MCP**: Usa `SupabaseREST` con access token de `.supabase/access_token`
- **Versión en BD**: Formato completo `B10.1.39N2.5.39` (se extrae primera parte para comparación)

---

**Última actualización:** 22 de Enero 2026 20:00 UTC
