# Handover: Deploy v2.5.72 - Sistema de Heartbeat Completo

**REF:** HANDOVER-2026-01-30-DEPLOY-v2.5.72  
**Fecha:** 30 Enero 2026  
**Commit Principal:** 1cb6705  
**Commit Handover:** 91a87eb  
**Versi√≥n:** B10.1.44N2.5.72

---

## üìã Resumen Ejecutivo

Deploy completo del **Sistema de Heartbeat** para controlar sesiones activas y sincronizar el estado `is_operativo` con la realidad de las conexiones de usuarios. Este sistema elimina sesiones "colgadas" y asegura que el indicador "Usuario en L√≠nea" sea preciso en tiempo real.

**Componentes principales:**
- ‚úÖ Sistema de Heartbeat (actualizaci√≥n cada 30s)
- ‚úÖ Tabla `active_sessions` con limpieza autom√°tica
- ‚úÖ Edge Function con Cron Job (cada 1 minuto)
- ‚úÖ Indicador "Usuario en L√≠nea" para todos los roles
- ‚úÖ Filtro "En L√≠nea Ahora" actualizado
- ‚úÖ Evento `beforeunload` para limpieza al cerrar ventana

---

## ‚úÖ Tareas Completadas

### 1. Actualizaci√≥n de C√≥digo Frontend

#### **Nuevos Archivos Creados:**

| Archivo | Descripci√≥n | L√≠neas |
|---------|-------------|--------|
| `src/hooks/useHeartbeat.ts` | Hook para mantener sesi√≥n activa con heartbeat cada 30s | 153 |
| `src/hooks/useTokenExpiryMonitor.ts` | Monitor de expiraci√≥n de tokens JWT | ~100 |
| `src/utils/authenticatedFetch.ts` | Utilidad para requests autenticados | ~50 |

#### **Archivos Modificados:**

| Archivo | Cambios | L√≠neas Afectadas |
|---------|---------|------------------|
| `src/contexts/AuthContext.tsx` | + Import `useHeartbeat`<br>+ Integraci√≥n de heartbeat autom√°tico<br>+ `handleForceLogout` actualiza `is_operativo = false` | 19, 61-66, 238-276 |
| `src/services/authService.ts` | + `login()`: establece `is_operativo = true` para todos<br>+ `logout()`: establece `is_operativo = false` para todos<br>+ Removidas duplicaciones en `handleExecutiveLogin/Logout` | 186-271, 276-302, 346-385 |
| `src/components/admin/UserManagementV2/components/UserEditPanel.tsx` | - Removida restricci√≥n de rol para indicador "Usuario en L√≠nea"<br>- Ahora visible para TODOS los roles | 1507 |
| `src/components/admin/UserManagementV2/components/UserTable.tsx` | - Removida columna "Operativo" (bot√≥n toggle manual)<br>- Removido handler `onToggleStatus`<br>- Removido prop del componente | 262-472, 33-49 |
| `src/components/admin/UserManagementV2/index.tsx` | - Removido `handleToggleStatus` function<br>- Removidas referencias a `onToggleStatus` | 213-216, 454, 464, 502 |
| `src/components/admin/UserManagementV2/hooks/useUserManagement.ts` | + Filtro "online" ahora muestra TODOS los usuarios con `is_operativo = true`<br>- Antes: solo ejecutivos | 529-533 |
| `src/components/admin/UserManagementV2/components/TreeViewSidebar.tsx` | + Texto actualizado: "En L√≠nea Ahora" (m√°s claro) | 588 |

### 2. Base de Datos

#### **Nueva Tabla: `active_sessions`**

```sql
CREATE TABLE active_sessions (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  session_id TEXT UNIQUE,
  device_info JSONB,
  last_activity TIMESTAMPTZ,
  expires_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ,
  CONSTRAINT unique_user_session UNIQUE (user_id)
);
```

**Caracter√≠sticas:**
- Constraint: Un usuario = una sesi√≥n activa
- √çndices optimizados para queries de limpieza
- RLS habilitado con pol√≠ticas seguras
- Usuarios pueden ver/actualizar solo su propia sesi√≥n
- Service role tiene acceso completo

#### **Nueva Funci√≥n: `cleanup_inactive_sessions()`**

```sql
CREATE OR REPLACE FUNCTION cleanup_inactive_sessions()
RETURNS INTEGER
```

**Funcionalidad:**
- Elimina sesiones expiradas (`expires_at < NOW()`)
- Elimina sesiones inactivas > 2 minutos (`last_activity < NOW() - INTERVAL '2 minutes'`)
- Actualiza `is_operativo = false` para usuarios sin sesi√≥n activa
- Retorna n√∫mero de sesiones eliminadas

**Migraci√≥n:** `supabase/migrations/20260130_create_active_sessions.sql`

### 3. Edge Function

**Nombre:** `cleanup-inactive-sessions`  
**URL:** https://glsmifhkoaifvaegsozd.supabase.co/functions/v1/cleanup-inactive-sessions  
**Verificaci√≥n JWT:** No (permite llamadas de Cron)  
**Deploy Status:** ‚úÖ Desplegado y probado exitosamente

**Funcionalidad:**
- Llama a `cleanup_inactive_sessions()` cada vez que se invoca
- Retorna estad√≠sticas (sesiones eliminadas, sesiones activas)
- Configurado para ejecutarse cada 1 minuto via Cron Job

**Prueba exitosa:**
```json
{
  "success": true,
  "deleted_sessions": 0,
  "active_sessions": 0,
  "timestamp": "2026-01-30T23:42:08.745Z"
}
```

### 4. Cron Job Configurado

**Nombre:** `cleanup-inactive-sessions`  
**Frecuencia:** Cada 1 minuto (`* * * * *`)  
**Estado:** ‚úÖ Configurado y ejecut√°ndose

```sql
SELECT cron.schedule(
  'cleanup-inactive-sessions',
  '* * * * *',
  $$SELECT net.http_post(...)$$
);
```

### 5. Git Push

**Commits realizados:**
- `1cb6705` - Deploy principal con todos los cambios
- `91a87eb` - Fix: Actualizar hash commit en DocumentationModule

**Branch:** main  
**Push Status:** ‚úÖ Exitoso (origin/main)

**Archivos commiteados:** 29 archivos
- 16 modificados
- 13 nuevos
- 2318 l√≠neas agregadas
- 207 l√≠neas eliminadas

### 6. Deploy AWS

**Tiempo total:** 48 segundos  
**Build time:** 40.35 segundos  
**Status:** ‚úÖ Exitoso

**URLs:**
- S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
- CloudFront: https://d3m6zgat40u0u1.cloudfront.net

**Bundle size:**
- CSS: 304.11 kB (40.26 kB gzip)
- JS principal: 9,287.24 kB (2,566.37 kB gzip)

### 7. Base de Datos

**Tabla:** `system_config`  
**Config Key:** `app_version`  
**Status:** ‚úÖ Actualizado

**Valor anterior:**
```json
{
  "version": "B10.1.44N2.5.71",
  "force_update": true
}
```

**Valor nuevo:**
```json
{
  "version": "B10.1.44N2.5.72",
  "force_update": true
}
```

**Timestamp:** 2026-01-30T23:55:40.813923+00:00

---

## üìä Cambios Principales

### üîê 1. Sistema de Autenticaci√≥n Mejorado

#### **Problema Original:**
- `is_operativo` era editable manualmente por admin
- Usuarios que cerraban ventana sin logout quedaban marcados como "en l√≠nea" por 4 horas
- No hab√≠a forma confiable de detectar usuarios realmente conectados

#### **Soluci√≥n Implementada:**

**a) Sincronizaci√≥n Autom√°tica de `is_operativo`:**
- ‚úÖ Login ‚Üí `is_operativo = true` (todos los usuarios)
- ‚úÖ Logout manual ‚Üí `is_operativo = false`
- ‚úÖ Token expirado ‚Üí `is_operativo = false`
- ‚úÖ Force logout ‚Üí `is_operativo = false`
- ‚úÖ Cierre de ventana ‚Üí `is_operativo = false` (via `beforeunload`)

**Archivos:** `authService.ts`, `useTokenExpiryMonitor.ts`, `AuthContext.tsx`

**b) Sistema de Heartbeat:**
- Frontend actualiza `last_activity` cada 30 segundos
- Hook `useHeartbeat` se activa autom√°ticamente al login
- Se detiene autom√°ticamente al logout
- Registra sesi√≥n en tabla `active_sessions`

**Archivo:** `src/hooks/useHeartbeat.ts`

**c) Limpieza Autom√°tica:**
- Cron Job ejecuta Edge Function cada 1 minuto
- Edge Function elimina sesiones inactivas > 2 minutos
- Actualiza `is_operativo = false` para usuarios sin sesi√≥n
- Previene sesiones "colgadas"

**Archivos:** 
- `supabase/functions/cleanup-inactive-sessions/index.ts`
- `supabase/migrations/20260130_create_active_sessions.sql`

### üé® 2. UI/UX Mejorado en Administraci√≥n de Usuarios

#### **Panel de Edici√≥n de Usuario:**
- ‚ùå Removido: Toggle editable "Usuario Operativo"
- ‚úÖ Agregado: Indicador visual "Usuario en L√≠nea" (read-only)
- ‚úÖ Ahora visible para TODOS los roles (antes solo coordinador/ejecutivo)

**Caracter√≠sticas del indicador:**
- C√≠rculo verde pulsante cuando est√° en l√≠nea
- Badge "En l√≠nea" / "Desconectado"
- Descripci√≥n contextual

**Archivo:** `UserEditPanel.tsx`

#### **Grid de Usuarios:**
- ‚ùå Removida: Columna "Operativo" con bot√≥n toggle manual
- ‚úÖ Estado `is_operativo` ahora es completamente autom√°tico

**Archivo:** `UserTable.tsx`

#### **Filtros Especiales:**
- ‚úÖ Filtro "En L√≠nea Ahora" actualizado
- Antes: Solo ejecutivos con `is_operativo = true` y `is_active = true`
- Ahora: TODOS los usuarios con `is_operativo = true`

**Archivo:** `useUserManagement.ts`

### üìä 3. Nuevos Scripts de Utilidad

| Script | Prop√≥sito |
|--------|-----------|
| `scripts/sync-is-operativo.ts` | Sincronizar manualmente `is_operativo` con sesiones activas |
| `scripts/deploy-cleanup-function.sh` | Deploy de Edge Function (alternativa a npx) |
| `scripts/test-heartbeat-system.sh` | Tests del sistema completo |

### üìö 4. Documentaci√≥n

| Documento | Descripci√≥n |
|-----------|-------------|
| `docs/HEARTBEAT_SYSTEM_SETUP.md` | Documentaci√≥n inicial del sistema |
| `docs/HEARTBEAT_FINAL_SETUP.md` | Gu√≠a completa con instrucciones de configuraci√≥n |

**Contenido:**
- Instrucciones de setup paso a paso
- Queries de monitoreo
- Troubleshooting
- Checklist de validaci√≥n

### üîß 5. Migraciones SQL

| Archivo | Descripci√≥n |
|---------|-------------|
| `supabase/migrations/20260130_create_active_sessions.sql` | Tabla + funci√≥n + √≠ndices + RLS |
| `supabase/migrations/reset_is_operativo_all_offline.sql` | Reset manual de todos a offline |
| `supabase/migrations/sync_is_operativo_with_sessions.sql` | Sincronizaci√≥n completa con logs |

---

## üîÑ Flujo Completo del Sistema

```
Usuario hace LOGIN
    ‚Üì
authService.login() ‚Üí is_operativo = true
    ‚Üì
useHeartbeat se activa
    ‚Üì
Actualiza last_activity cada 30s en active_sessions
    ‚Üì
[Usuario usa la app normalmente]
    ‚Üì
Cron Job ejecuta cada 1 minuto:
  - Elimina sesiones inactivas > 2 min
  - Actualiza is_operativo = false para usuarios sin sesi√≥n
    ‚Üì
Usuario hace LOGOUT / Cierra ventana / Token expira
    ‚Üì
is_operativo = false
    ‚Üì
useHeartbeat se detiene
    ‚Üì
beforeunload limpia sesi√≥n de active_sessions
```

---

## üß™ Testing Realizado

### ‚úÖ Tests Exitosos:

1. **Migraci√≥n SQL:**
   - ‚úÖ Tabla `active_sessions` creada
   - ‚úÖ √çndices creados (5 √≠ndices)
   - ‚úÖ Pol√≠ticas RLS configuradas (5 pol√≠ticas)
   - ‚úÖ Funci√≥n `cleanup_inactive_sessions()` probada

2. **Edge Function:**
   - ‚úÖ Deploy exitoso via `npx supabase`
   - ‚úÖ Test manual: responde con 200 OK
   - ‚úÖ Retorna JSON con estad√≠sticas

3. **Cron Job:**
   - ‚úÖ Configurado con `cron.schedule()`
   - ‚úÖ Visible en `cron.job`
   - ‚úÖ Ejecut√°ndose cada 1 minuto

4. **Linter:**
   - ‚úÖ Sin errores en todos los archivos modificados

---

## üìä Cambios por M√≥dulo

### M√≥dulo: Autenticaci√≥n

**Archivos:**
- `src/services/authService.ts`
- `src/contexts/AuthContext.tsx`
- `src/hooks/useTokenExpiryMonitor.ts`
- `src/hooks/useHeartbeat.ts`

**Cambios clave:**
- Sistema de heartbeat integrado
- `is_operativo` se actualiza autom√°ticamente en login/logout
- Limpieza de sesi√≥n al expirar token
- Evento `beforeunload` para cerrar sesi√≥n al cerrar ventana

### M√≥dulo: Administraci√≥n de Usuarios

**Archivos:**
- `src/components/admin/UserManagementV2/components/UserEditPanel.tsx`
- `src/components/admin/UserManagementV2/components/UserTable.tsx`
- `src/components/admin/UserManagementV2/components/TreeViewSidebar.tsx`
- `src/components/admin/UserManagementV2/hooks/useUserManagement.ts`
- `src/components/admin/UserManagementV2/index.tsx`

**Cambios clave:**
- Removido toggle manual de `is_operativo`
- Indicador "Usuario en L√≠nea" visible para todos los roles
- Filtro "En L√≠nea Ahora" actualizado para todos los usuarios
- Columna "Operativo" eliminada del grid

### M√≥dulo: Base de Datos

**Nuevo:**
- Tabla `active_sessions`
- Funci√≥n `cleanup_inactive_sessions()`
- 5 pol√≠ticas RLS
- 5 √≠ndices de optimizaci√≥n

**Modificado:**
- `system_config.app_version` ‚Üí `B10.1.44N2.5.72`

### M√≥dulo: Edge Functions

**Nuevo:**
- `supabase/functions/cleanup-inactive-sessions/`
- Configuraci√≥n Cron Job

---

## üîç Detalles T√©cnicos

### Sistema de Heartbeat

**Intervalo:** 30 segundos  
**M√©todo:** UPSERT en `active_sessions`  
**Campos actualizados:**
- `last_activity` ‚Üí NOW()
- `expires_at` ‚Üí NOW() + 24 horas
- `device_info` ‚Üí Browser, Platform, UserAgent

**Implementaci√≥n:**
```typescript
useHeartbeat({
  userId: authState.user?.id || '',
  sessionId: localStorage.getItem('session_id') || '',
  enabled: authState.isAuthenticated,
  intervalMs: 30000
});
```

### Limpieza de Sesiones

**Frecuencia:** Cada 1 minuto (Cron Job)  
**Criterios de eliminaci√≥n:**
- `expires_at < NOW()` (sesi√≥n expirada)
- `last_activity < NOW() - INTERVAL '2 minutes'` (sesi√≥n inactiva)

**Acci√≥n posterior:**
- Actualiza `is_operativo = false` para usuarios sin sesi√≥n activa

### Evento beforeunload

**Prop√≥sito:** Limpiar sesi√≥n al cerrar ventana/pesta√±a  
**Implementaci√≥n:**
```typescript
window.addEventListener('beforeunload', async () => {
  await supabaseSystemUI.rpc('update_user_metadata', {
    p_user_id: userId,
    p_updates: { is_operativo: false }
  });
  await supabaseSystemUI
    .from('active_sessions')
    .delete()
    .eq('session_id', sessionId);
});
```

**Nota:** `beforeunload` es "best effort" - no garantiza ejecuci√≥n en todos los casos (crashes, force quit, etc.). El Cron Job es el respaldo principal.

---

## üéØ Impacto en Usuarios

### Para Administradores:

- ‚úÖ **Vista precisa** de usuarios realmente conectados
- ‚úÖ **Filtro "En L√≠nea Ahora"** funciona correctamente
- ‚úÖ **No m√°s edici√≥n manual** de estado operativo
- ‚úÖ **Indicador en tiempo real** en panel de edici√≥n

### Para Coordinadores/Ejecutivos/Evaluadores:

- ‚úÖ **Estado autom√°tico** - No requiere intervenci√≥n
- ‚úÖ **Sesi√≥n limpia** al logout o inactividad
- ‚úÖ **No m√°s sesiones colgadas** despu√©s de cerrar ventana

### Para el Sistema:

- ‚úÖ **Detecci√≥n precisa** de usuarios activos
- ‚úÖ **Limpieza autom√°tica** cada 1 minuto
- ‚úÖ **Optimizaci√≥n** de recursos (no mantener sesiones fantasma)

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

### Inmediato (Usuario):

1. **Esperar 5-10 minutos** (propagaci√≥n CloudFront)
2. **Limpiar cache del navegador** (Cmd+Shift+R en macOS)
3. **Hacer login** y verificar en DevTools ‚Üí Console:
   ```
   üíì Heartbeat iniciado (cada 30s)
   üíì Heartbeat enviado: HH:MM:SS
   üëã beforeunload listener registrado
   ```
4. **Verificar footer** muestre versi√≥n `B10.1.44N2.5.72`

### Monitoreo (Pr√≥ximos d√≠as):

1. **Verificar Cron Job se est√° ejecutando:**
   ```sql
   SELECT * FROM cron.job_run_details 
   ORDER BY start_time DESC LIMIT 10;
   ```

2. **Monitorear sesiones activas:**
   ```sql
   SELECT COUNT(*) as usuarios_en_linea 
   FROM active_sessions 
   WHERE expires_at > NOW();
   ```

3. **Detectar inconsistencias:**
   ```sql
   SELECT u.email, u.raw_user_meta_data->>'is_operativo' as is_operativo
   FROM auth.users u
   LEFT JOIN active_sessions s ON u.id = s.user_id AND s.expires_at > NOW()
   WHERE u.raw_user_meta_data->>'is_operativo' = 'true' AND s.user_id IS NULL;
   ```

### Mejoras Futuras (Opcional):

- Ajustar intervalo de heartbeat (actualmente 30s)
- Ajustar timeout de inactividad (actualmente 2 minutos)
- Dashboard de sesiones activas en tiempo real
- Alertas para sesiones an√≥malas

---

## üêõ Issues Conocidos / Limitaciones

### beforeunload No es 100% Confiable

**Problema:**
- El evento `beforeunload` no siempre se dispara (crashes, force quit, p√©rdida de conexi√≥n)

**Mitigaci√≥n:**
- Cron Job limpia sesiones cada 1 minuto
- Timeout de 2 minutos de inactividad
- Sistema sigue funcionando correctamente incluso si `beforeunload` falla

### Latencia de Sincronizaci√≥n

**Escenario:**
- Usuario cierra ventana ‚Üí `beforeunload` falla
- Aparece como "en l√≠nea" hasta que Cron limpie (m√°ximo 2-3 minutos)

**Soluci√≥n:**
- Aceptable para este caso de uso (no es cr√≠tico)
- Si se requiere precisi√≥n al segundo, reducir intervalo de Cron

---

## üìö Referencias

### Documentaci√≥n Creada:
- [HEARTBEAT_FINAL_SETUP.md](../docs/HEARTBEAT_FINAL_SETUP.md) - Gu√≠a completa
- [HEARTBEAT_SYSTEM_SETUP.md](../docs/HEARTBEAT_SYSTEM_SETUP.md) - Setup inicial

### Archivos Clave:
- [useHeartbeat.ts](../src/hooks/useHeartbeat.ts) - Hook principal
- [AuthContext.tsx](../src/contexts/AuthContext.tsx) - Integraci√≥n
- [authService.ts](../src/services/authService.ts) - L√≥gica de login/logout

### Migraciones:
- [20260130_create_active_sessions.sql](../supabase/migrations/20260130_create_active_sessions.sql)

### Edge Functions:
- [cleanup-inactive-sessions](../supabase/functions/cleanup-inactive-sessions/index.ts)

---

## üéì Lecciones Aprendidas

1. **beforeunload es limitado** - Siempre tener respaldo (Cron Job)
2. **Heartbeat cada 30s es √≥ptimo** - Balance entre precisi√≥n y overhead
3. **RLS en active_sessions es importante** - Seguridad de sesiones
4. **√çndices compuestos** - Queries de limpieza son r√°pidas
5. **pg_cron debe habilitarse manualmente** - No est√° por defecto

---

## üìã Checklist de Validaci√≥n

- [x] Migraci√≥n SQL ejecutada
- [x] Tabla `active_sessions` creada
- [x] Funci√≥n `cleanup_inactive_sessions()` funcionando
- [x] Edge Function desplegada
- [x] Cron Job configurado
- [x] Sistema de Heartbeat integrado
- [x] Indicador UI actualizado para todos los roles
- [x] Filtro "En L√≠nea Ahora" funcional
- [x] Git push exitoso
- [x] AWS deploy exitoso
- [x] BD actualizada (version B10.1.44N2.5.72)
- [x] Handover creado
- [ ] Heartbeat visible en console (verificar al hacer login)
- [ ] Test de inactividad completado (cerrar ventana y verificar)

---

## üîó URLs √ötiles

- **CloudFront:** https://d3m6zgat40u0u1.cloudfront.net
- **Supabase Dashboard:** https://supabase.com/dashboard/project/glsmifhkoaifvaegsozd
- **Edge Function:** https://glsmifhkoaifvaegsozd.supabase.co/functions/v1/cleanup-inactive-sessions
- **GitHub Repo:** https://github.com/rodrigo-vidanta/analisis_web

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Tiempo Total:** ~52 segundos  
**Archivos Modificados:** 29  
**L√≠neas Agregadas:** 2,318  
**L√≠neas Eliminadas:** 207

---

**Pr√≥xima sesi√≥n:** Monitorear comportamiento del heartbeat en producci√≥n durante 24-48 horas y ajustar intervalos si es necesario.
