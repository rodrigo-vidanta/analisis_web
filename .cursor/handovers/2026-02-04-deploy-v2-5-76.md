# Handover: Deploy v2.5.76

**REF:** HANDOVER-2026-02-04-DEPLOY-v2.5.76  
**Fecha:** 2026-02-04  
**Commit:** 7d36e39  
**Versi√≥n:** B10.1.44N2.5.76

---

## üìã Resumen Ejecutivo

Fix cr√≠tico para 42 ejecutivos que no ve√≠an conversaciones de WhatsApp debido a `is_operativo = false` en `auth.users.raw_user_meta_data`. El problema afectaba principalmente a:
- Osmara Partida (29 prospectos, 166 conversaciones)
- Jessica Gutierrez (204 prospectos)
- Kenia Martinez (220 prospectos)
- Mayra Gonzalez (318 prospectos)

---

## ‚úÖ Tareas Completadas

### 1. Diagn√≥stico y An√°lisis
- ‚úÖ Identificado problema: campo `is_operativo = false` bloqueaba filtros de conversaciones
- ‚úÖ Verificado 42 ejecutivos afectados con prospectos asignados
- ‚úÖ Confirmado que datos S√ç existen en BD (166 conversaciones para Osmara)

### 2. Fix de Base de Datos
**Script ejecutado:** `scripts/sql/FIX_IS_OPERATIVO_EJECUTIVOS.sql`

```sql
UPDATE auth.users
SET raw_user_meta_data = jsonb_set(
  raw_user_meta_data, '{is_operativo}', 'true'::jsonb
)
WHERE id IN (
  SELECT u.id FROM user_profiles_v2 u
  WHERE u.is_ejecutivo = true
    AND u.is_operativo = false
    AND u.is_active = true
    AND EXISTS (SELECT 1 FROM prospectos p WHERE p.ejecutivo_id = u.id)
);
```

**Resultado:** ‚úÖ 35 ejecutivos actualizados en 5 coordinaciones

### 3. Fix de C√≥digo (Prevenci√≥n)
**Archivo:** `src/services/authService.ts` (l√≠neas 140-168)

Agregado en m√©todo `initialize()`:
```typescript
// Al recargar sesi√≥n, restaurar is_operativo = true
if (this.currentUser && (this.currentUser.is_ejecutivo || this.currentUser.is_coordinador)) {
  await this.updateUserMetadata(session.user.id, { is_operativo: true });
}
```

**Efecto:** Previene que el problema vuelva a ocurrir si usuarios cierran navegador sin logout.

### 4. Git Push
- **Commits:** 
  - `7d36e39` - Deploy v2.5.76 (26 archivos, 3095 inserciones)
  - `1b0e717` - Actualizar hash commit en DocumentationModule
- **Push a:** origin/main ‚úÖ

### 5. Deploy AWS
- **Build time:** 23.37s
- **Upload time:** 35s total
- **URLs:**
  - S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
  - CloudFront: https://d3m6zgat40u0u1.cloudfront.net
- **Status:** ‚úÖ Completado

### 6. Base de Datos
- **Tabla:** `system_config`
- **Config Key:** `app_version`
- **Versi√≥n anterior:** B10.1.44N2.5.75
- **Versi√≥n nueva:** B10.1.44N2.5.76
- **force_update:** true
- **Status:** ‚úÖ Actualizada

---

## üìä Cambios Principales

### Archivos Creados
1. `docs/FIX_IS_OPERATIVO_WHATSAPP_2026-02-04.md` - Documentaci√≥n completa del fix
2. `scripts/sql/FIX_IS_OPERATIVO_EJECUTIVOS.sql` - Script de fix en BD
3. `scripts/sql/diagnostico_is_operativo_false.sql` - Script de diagn√≥stico
4. `scripts/sql/diagnostico_osmara_whatsapp.sql` - Diagn√≥stico caso Osmara
5. `scripts/sql/fix_osmara_whatsapp_view.sql` - Script de verificaci√≥n vista
6. `src/types/errorCatalog.ts` - Cat√°logo de errores
7. `DIAGNOSTICO_ERR_CONNECTION_RESET.md` - Diagn√≥stico de errores de conexi√≥n
8. `docs/ERROR_CATALOG_ANALYSIS.md` - An√°lisis de cat√°logo de errores

### Archivos Modificados
1. `src/services/authService.ts` - Agregado auto-restore de `is_operativo`
2. `src/components/chat/ReactivateConversationModal.tsx`
3. `src/components/live-activity/CallCard.tsx`
4. `src/components/live-activity/LiveCallActivityWidget.tsx`
5. `src/hooks/useHeartbeat.ts`
6. `src/hooks/useTokenExpiryMonitor.ts`
7. `src/services/dynamicsLeadService.ts`
8. `supabase/functions/dynamics-lead-proxy/index.ts`

---

## üîç Detalles T√©cnicos

### Problema Identificado

El campo `is_operativo` en `auth.users.raw_user_meta_data` tiene dos usos:
1. **Control de sesi√≥n:** Se pone en `false` al hacer logout
2. **Filtro de datos:** Solo se muestran conversaciones si `is_operativo = true`

**Causa del bug:** Si un usuario cierra el navegador sin logout (o hay error de red), queda permanentemente con `is_operativo = false`.

### Usuarios Afectados

**Total:** 42 ejecutivos con prospectos asignados

**Top 5 m√°s afectados:**
- Mayra Gonzalez: 318 prospectos
- Kenia Martinez: 220 prospectos
- Jessica Gutierrez: 204 prospectos
- Rodrigo Meza: 164 prospectos
- Osmara Partida: 29 prospectos

### Verificaci√≥n de Datos (Osmara Partida)

| M√©trica | Valor |
|---------|-------|
| Prospectos asignados | 29 |
| Conversaciones en vista | 166 |
| Mensajes WhatsApp | 529 |
| `is_operativo` (antes) | false ‚ùå |
| `is_operativo` (despu√©s) | true ‚úÖ |

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

### Inmediatos
1. ‚úÖ Esperar 5-10 min (propagaci√≥n CloudFront)
2. ‚úÖ Pedir a Osmara Partida que:
   - Recargue la p√°gina (Cmd+Shift+R)
   - Verifique versi√≥n en footer: `B10.1.44N2.5.76`
   - Confirme que ve sus 166 conversaciones en m√≥dulo WhatsApp

### Validaci√≥n
3. ‚úÖ Probar con otros usuarios afectados:
   - Jessica Gutierrez (jessicagutierrez@vidavacations.com)
   - Kenia Martinez (keniamartineza@vidavacations.com)
   - Mayra Gonzalez (mayragonzalezs@vidavacations.com)

### Monitoreo (24 horas)
4. ‚úÖ Verificar que no aparezcan nuevos casos de `is_operativo = false` con prospectos
5. ‚úÖ Ejecutar script de monitoreo diario:
```sql
SELECT COUNT(*) 
FROM user_profiles_v2
WHERE is_ejecutivo = true 
  AND is_operativo = false 
  AND is_active = true
  AND last_login > NOW() - INTERVAL '7 days';
-- Debe ser 0
```

---

## üìö Referencias

### Documentaci√≥n Creada
- `docs/FIX_IS_OPERATIVO_WHATSAPP_2026-02-04.md` - Documentaci√≥n completa
- `scripts/sql/FIX_IS_OPERATIVO_EJECUTIVOS.sql` - Script SQL de fix
- `scripts/sql/diagnostico_is_operativo_false.sql` - Script de diagn√≥stico

### Documentaci√≥n Relacionada
- `docs/MIGRACION_AUTH_USERS_NATIVO_2026-01-20.md` - Migraci√≥n a auth.users
- `docs/ARQUITECTURA_AUTH_NATIVA_2026.md` - Arquitectura actual
- `.cursor/rules/security-rules.mdc` - Reglas de seguridad

### Archivos de C√≥digo
- `src/services/authService.ts` (l√≠neas 140-168) - Fix implementado
- `src/services/coordinacionService.ts` (l√≠nea 124) - Usa filtro `is_operativo`
- `src/services/permissionsService.ts` - Sistema de permisos

---

## üéØ M√©tricas del Deploy

| M√©trica | Valor |
|---------|-------|
| **Tiempo total** | ~1.5 minutos |
| **Archivos modificados** | 26 archivos |
| **Commits** | 2 (7d36e39, 1b0e717) |
| **Build time** | 23.37s |
| **Deploy AWS** | 35s |
| **BD update** | 2s (via MCP) |

---

## üõ°Ô∏è Seguridad

- ‚úÖ No hay API keys expuestas en bundle
- ‚úÖ Solo `anon_key` en producci√≥n
- ‚úÖ Actualizaci√≥n de BD v√≠a MCP seguro
- ‚úÖ Script SQL usa `auth.users` (nativo de Supabase)
- ‚úÖ Compatibilidad con migraci√≥n 2026-01-20

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Lecciones Aprendidas:** 
- El campo `is_operativo` necesita restauraci√≥n autom√°tica al recargar sesi√≥n
- Importante considerar casos de cierre sin logout en dise√±o de flags de sesi√≥n
- La vista materializada `mv_conversaciones_dashboard` funcionaba correctamente
