# Handover: Deploy v2.5.73 - HOTFIX Permisos Supervisor

**REF:** HANDOVER-2026-01-30-DEPLOY-v2.5.73  
**Fecha:** 2026-01-30  
**Commits:** 2bf4c92, 983ae05  
**Versi√≥n:** B10.1.44N2.5.73

---

## üìã Resumen Ejecutivo

HOTFIX cr√≠tico: Revertir cambio no autorizado en permisos de supervisor. Los supervisores **NO deben** poder programar llamadas a prospectos en etapa "Importado Manual". Este deploy restaura las restricciones correctas.

---

## ‚úÖ Tareas Completadas

### 1. Reversi√≥n de Cambios No Autorizados

**Archivo modificado:** `src/utils/prospectRestrictions.ts`

**Cambio revertido:**
```typescript
// ‚ùå INCORRECTO (revertido)
const EXEMPT_ROLES: string[] = [
  'admin',
  'administrador_operativo',
  'supervisor', // <-- ELIMINADO
];

// ‚úÖ CORRECTO (restaurado)
const EXEMPT_ROLES: string[] = [
  'admin',
  'administrador_operativo',
];
```

**Comentarios actualizados:**
- Restaurados comentarios originales sobre roles afectados
- Confirmado que supervisores tienen restricciones

### 2. Limpieza de Archivos Temporales

**Archivos eliminados:**
- `FIX_SUPERVISOR_PERMISOS_2026-01-30.md` (documentaci√≥n incorrecta)
- `RESUMEN_FIX_SUPERVISOR_2026-01-30.md` (resumen incorrecto)  
- `scripts/check-supervisor-permisos.sh` (script innecesario)

### 3. Documentaci√≥n del Issue Real

**Nuevo archivo:** `DIAGNOSTICO_ACTUALIZADO_SUPERVISOR_2026-01-30.md`

Contenido:
- ‚úÖ Confirmaci√≥n: El prospecto NO est√° en etapa restringida (Discovery)
- ‚úÖ Descarta problema de restricciones por etapa
- ‚úÖ Identifica posibles causas reales (Edge Function, N8N)
- ‚úÖ Pasos de debugging recomendados

### 4. Git Push

**Commits:**
- `2bf4c92` - Deploy v2.5.73 principal
- `983ae05` - Fix hash commit en DocumentationModule

**Branch:** main ‚Üí origin/main

### 5. Deploy AWS

**M√©tricas:**
- Build time: 38.63s
- Deploy time: 47s
- Bundle size: 9,287.55 kB (gzipped: 2,566.44 kB)

**URLs:**
- S3: http://pqnc-qa-ai-frontend.s3-website.us-west-2.amazonaws.com
- CloudFront: https://d3m6zgat40u0u1.cloudfront.net

### 6. Base de Datos

**Tabla:** `system_config`  
**Config Key:** `app_version`  
**Versi√≥n:** B10.1.44N2.5.73  
**Config Value:**
```json
{
  "version": "B10.1.44N2.5.73",
  "force_update": true
}
```

**Actualizado:** 2026-01-31 00:24:56 UTC  
**Status:** ‚úÖ Verificado

---

## üìä Cambios Principales

### Restricciones de Permisos (Restauradas)

**Roles con restricciones en etapa "Importado Manual":**
- ‚úÖ Ejecutivos (NO pueden programar llamadas)
- ‚úÖ Supervisores (NO pueden programar llamadas) ‚Üê **RESTAURADO**
- ‚úÖ Coordinadores (NO pueden programar llamadas)

**Roles exentos:**
- ‚úÖ Administradores
- ‚úÖ Administradores Operativos

### Funciones Afectadas

Las siguientes funciones en `prospectRestrictions.ts` ahora aplican restricciones correctamente a supervisores:
- `canStartCall()` - Iniciar llamadas
- `canPauseBot()` - Pausar bot
- `canToggleAttentionRequired()` - Cambiar "Requiere Atenci√≥n"
- `canScheduleCall()` - Programar llamadas

---

## üêõ Problema Original (NO RESUELTO)

**Usuario reportado:** Issel Rico (isselrico@vidavacations.com)  
**Rol:** supervisor  
**Prospecto:** Sandra Nieto Mancilla (aaedd700-0758-453d-98c2-eca11447e207)  
**Etapa:** Discovery (NO restringida)

**S√≠ntoma:** Hace clic en "Programar llamada", dice "llamada programada", pero NO se ve en conversaci√≥n ni en BD.

**Diagn√≥stico:**
- ‚úÖ Prospecto NO est√° en etapa restringida
- ‚úÖ Otras personas S√ç pueden programar llamadas a ese prospecto
- ‚ö†Ô∏è El problema NO es de restricciones de etapa

**Posibles causas reales:**
1. Error silencioso en Edge Function `trigger-manual-proxy`
2. N8N rechaza la llamada pero retorna "success"
3. Validaci√≥n de permisos en workflow N8N

**Acci√≥n requerida:** Revisar logs de Edge Function y N8N (ver documentaci√≥n en `DIAGNOSTICO_ACTUALIZADO_SUPERVISOR_2026-01-30.md`)

---

## ‚è≠Ô∏è Pr√≥ximos Pasos

### Inmediatos (Usuario)
1. ‚è≥ Esperar 5-10 min (propagaci√≥n CloudFront)
2. üîÑ Limpiar cache navegador (Cmd+Shift+R)
3. ‚úÖ Verificar versi√≥n en footer: B10.1.44N2.5.73
4. ‚úÖ Confirmar que supervisores NO pueden programar llamadas a "Importado Manual"

### Para Resolver el Problema Real (Issel Rico)
1. Pedirle que abra DevTools (F12) en Chrome
2. Ir a pesta√±a "Network"
3. Intentar programar una llamada
4. Buscar request a `trigger-manual-proxy`
5. Compartir:
   - Status code
   - Response body
   - Errores en Console

### Alternativamente
- Revisar logs de Edge Function en Supabase Dashboard
- Revisar logs de N8N workflow "Logica de llamadas programadas [PROD]"

---

## üìö Referencias

### Archivos Modificados
- `src/utils/prospectRestrictions.ts` - Reversi√≥n completa
- `src/config/appVersion.ts` - Versi√≥n B10.1.44N2.5.73
- `package.json` - Versi√≥n 2.5.73
- `src/components/documentation/DocumentationModule.tsx` - Stats + commit

### Documentaci√≥n
- `DIAGNOSTICO_ACTUALIZADO_SUPERVISOR_2026-01-30.md` - Diagn√≥stico correcto del problema
- `.cursor/rules/deploy-workflow.mdc` - Workflow seguido
- `docs/PERMISSION_GROUPS_SYSTEM.md` - Sistema de permisos

### Edge Functions
- `supabase/functions/trigger-manual-proxy/index.ts` - Proxy para programar llamadas

### N8N Workflows
- "Logica de llamadas programadas [PROD]" (ID: HYRGSVN86YY64pBS)

---

## üîê Seguridad

**Checks realizados:**
- ‚úÖ No hay API keys expuestas en bundle
- ‚úÖ Restricciones de etapa correctamente aplicadas
- ‚úÖ Permisos por rol restaurados
- ‚úÖ `.gitignore` actualizado

---

## üìä M√©tricas del Deploy

| M√©trica | Valor |
|---------|-------|
| Tiempo total | ~52s |
| Build | 38.63s |
| Deploy AWS | 47s |
| Git push | ~2s |
| BD update | ~1s |
| Archivos modificados | 5 archivos |
| Commits | 2 (2bf4c92, 983ae05) |
| Bundle size | 9.28 MB (2.57 MB gzipped) |

---

**Deploy Status:** ‚úÖ COMPLETADO  
**Problema Original:** ‚ö†Ô∏è PENDIENTE (requiere debugging adicional)  
**Lecciones Aprendidas:** 
1. NUNCA hacer cambios de permisos sin autorizaci√≥n expl√≠cita del usuario
2. Verificar siempre el contexto completo antes de asumir la causa ra√≠z
3. El problema de Issel Rico NO es de restricciones de etapa (requiere investigaci√≥n de Edge Function/N8N)
